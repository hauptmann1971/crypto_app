<!-- templates/status.html -->
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }} | Crypto App</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .status-card {
            transition: all 0.3s;
        }
        .status-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .progress-thin {
            height: 8px;
        }
        .process-list {
            max-height: 300px;
            overflow-y: auto;
        }
        .badge-online {
            background-color: #28a745;
        }
        .badge-offline {
            background-color: #dc3545;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="mb-4">{{ title }}</h1>

        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card status-card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">üìä –°–∏—Å—Ç–µ–º–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h5>
                    </div>
                    <div class="card-body">
                        <div id="system-info">
                            <p class="text-center">
                                <span class="spinner-border spinner-border-sm"></span>
                                –ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏...
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card status-card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">‚ö° –†–µ—Å—É—Ä—Å—ã</h5>
                    </div>
                    <div class="card-body">
                        <div id="resources-info">
                            <p class="text-center">
                                <span class="spinner-border spinner-border-sm"></span>
                                –ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏...
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card status-card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">üõ°Ô∏è Nginx</h5>
                    </div>
                    <div class="card-body">
                        <div id="nginx-status">
                            <p class="text-center">
                                <span class="spinner-border spinner-border-sm"></span>
                                –ó–∞–≥—Ä—É–∑–∫–∞...
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card status-card">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0">üêç Gunicorn</h5>
                    </div>
                    <div class="card-body">
                        <div id="gunicorn-status">
                            <p class="text-center">
                                <span class="spinner-border spinner-border-sm"></span>
                                –ó–∞–≥—Ä—É–∑–∫–∞...
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card status-card">
                    <div class="card-header bg-danger text-white">
                        <h5 class="mb-0">üî• Flask</h5>
                    </div>
                    <div class="card-body">
                        <div id="flask-status">
                            <p class="text-center">
                                <span class="spinner-border spinner-border-sm"></span>
                                –ó–∞–≥—Ä—É–∑–∫–∞...
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card status-card mb-4">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0">üìà –ê–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã</h5>
            </div>
            <div class="card-body">
                <div id="processes-list">
                    <p class="text-center">
                        <span class="spinner-border spinner-border-sm"></span>
                        –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤...
                    </p>
                </div>
            </div>
        </div>

        <div class="text-center mb-4">
            <button id="refresh-btn" class="btn btn-primary">
                üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å
            </button>
            <a href="/" class="btn btn-secondary">üè† –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
            <a href="/log_table" class="btn btn-info">üìù –õ–æ–≥–∏</a>
        </div>

        <div class="text-muted text-center small">
            <p>–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã. –ù–∞–∂–º–∏—Ç–µ "–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å" –¥–ª—è –∞–∫—Ç—É–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.</p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        async function loadStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–∏—Å—Ç–µ–º–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
                document.getElementById('system-info').innerHTML = `
                    <p><strong>–°–∏—Å—Ç–µ–º–∞:</strong> ${data.system.system} ${data.system.release}</p>
                    <p><strong>–•–æ—Å—Ç:</strong> ${data.system.node}</p>
                    <p><strong>–ú–∞—à–∏–Ω–∞:</strong> ${data.system.machine}</p>
                    <p><strong>–ü—Ä–æ—Ü–µ—Å—Å–æ—Ä:</strong> ${data.system.processor}</p>
                    <p><strong>ID —Ö–æ—Å—Ç–∞:</strong> <code>${data.system.host_id}</code></p>
                    <p><strong>–í—Ä–µ–º—è:</strong> ${data.timestamp}</p>
                `;

                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ä–µ—Å—É—Ä—Å–∞—Ö
                document.getElementById('resources-info').innerHTML = `
                    <div class="mb-3">
                        <strong>RAM:</strong> ${data.resources.ram.used}GB / ${data.resources.ram.total}GB
                        <div class="progress progress-thin">
                            <div class="progress-bar ${data.resources.ram.percent > 80 ? 'bg-danger' : data.resources.ram.percent > 60 ? 'bg-warning' : 'bg-success'}"
                                 style="width: ${data.resources.ram.percent}%">
                                ${data.resources.ram.percent}%
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <strong>CPU:</strong> ${data.resources.cpu.percent}%
                        <div class="progress progress-thin">
                            <div class="progress-bar ${data.resources.cpu.percent > 80 ? 'bg-danger' : data.resources.cpu.percent > 60 ? 'bg-warning' : 'bg-info'}"
                                 style="width: ${data.resources.cpu.percent}%">
                                ${data.resources.cpu.percent}%
                            </div>
                        </div>
                    </div>
                    <div>
                        <strong>Disk:</strong> ${data.resources.disk.used}GB / ${data.resources.disk.total}GB
                        <div class="progress progress-thin">
                            <div class="progress-bar ${data.resources.disk.percent > 80 ? 'bg-danger' : data.resources.disk.percent > 60 ? 'bg-warning' : 'bg-primary'}"
                                 style="width: ${data.resources.disk.percent}%">
                                ${data.resources.disk.percent}%
                            </div>
                        </div>
                    </div>
                `;

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å Nginx
                const nginxOn = data.services.nginx.on;
                const nginxOff = data.services.nginx.off;
                document.getElementById('nginx-status').innerHTML = `
                    <p><strong>–°—Ç–∞—Ç—É—Å:</strong>
                        <span class="badge ${nginxOn > 0 ? 'badge-online' : 'badge-offline'}">
                            ${nginxOn > 0 ? 'ONLINE' : 'OFFLINE'}
                        </span>
                    </p>
                    <p><strong>–ü—Ä–æ—Ü–µ—Å—Å—ã:</strong> ${nginxOn} on / ${nginxOff} off (–≤—Å–µ–≥–æ: ${data.services.nginx.count})</p>
                    ${nginxOn > 0 ? `<p><small>${data.services.nginx.processes.map(p => `${p.name} (PID: ${p.pid})`).join(', ')}</small></p>` : ''}
                `;

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å Gunicorn
                const gunicornOn = data.services.gunicorn.on;
                const gunicornOff = data.services.gunicorn.off;
                document.getElementById('gunicorn-status').innerHTML = `
                    <p><strong>–°—Ç–∞—Ç—É—Å:</strong>
                        <span class="badge ${gunicornOn > 0 ? 'badge-online' : 'badge-offline'}">
                            ${gunicornOn > 0 ? 'ONLINE' : 'OFFLINE'}
                        </span>
                    </p>
                    <p><strong>–ü—Ä–æ—Ü–µ—Å—Å—ã:</strong> ${gunicornOn} on / ${gunicornOff} off (–≤—Å–µ–≥–æ: ${data.services.gunicorn.count})</p>
                    ${gunicornOn > 0 ? `<p><small>${data.services.gunicorn.processes.map(p => `${p.name} (PID: ${p.pid})`).join(', ')}</small></p>` : ''}
                `;

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å Flask
                const flaskStatus = data.services.flask.status;
                const uptimeHours = (data.services.flask.uptime / 3600).toFixed(1);
                document.getElementById('flask-status').innerHTML = `
                    <p><strong>–°—Ç–∞—Ç—É—Å:</strong>
                        <span class="badge ${flaskStatus === 'running' ? 'badge-online' : 'badge-offline'}">
                            ${flaskStatus.toUpperCase()}
                        </span>
                    </p>
                    <p><strong>–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã:</strong> ${uptimeHours} —á–∞—Å–æ–≤</p>
                    <p><strong>–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö:</strong>
                        <span class="badge ${data.services.database.connected ? 'badge-online' : 'badge-offline'}">
                            ${data.services.database.connected ? 'CONNECTED' : 'DISCONNECTED'}
                        </span>
                    </p>
                `;

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
                let processesHtml = '<div class="process-list">';
                if (data.processes.list && data.processes.list.length > 0) {
                    data.processes.list.forEach(process => {
                        processesHtml += `
                            <div class="border-bottom py-2">
                                <strong>${process.name}</strong>
                                <small class="text-muted">(PID: ${process.pid})</small>
                                <br>
                                <small>
                                    –°—Ç–∞—Ç—É—Å: <span class="badge ${process.status === 'running' ? 'bg-success' : 'bg-danger'}">${process.status}</span>
                                    CPU: ${process.cpu}% | RAM: ${process.memory ? process.memory.toFixed(1) : 'N/A'}%
                                </small>
                            </div>
                        `;
                    });
                } else {
                    processesHtml += '<p class="text-center text-muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –ø—Ä–æ—Ü–µ—Å—Å–∞—Ö</p>';
                }
                processesHtml += '</div>';
                document.getElementById('processes-list').innerHTML = processesHtml;

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç—É—Å–∞:', error);
                document.getElementById('system-info').innerHTML = '<p class="text-danger">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</p>';
            }
        }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç—É—Å –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', loadStatus);

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –∫–Ω–æ–ø–∫–∏
        document.getElementById('refresh-btn').addEventListener('click', loadStatus);

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
        setInterval(loadStatus, 30000);
    </script>
</body>
</html>