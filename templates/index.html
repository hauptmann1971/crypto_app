<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–æ–Ω–≤–µ—Ä—Ç–µ—Ä –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .rate-display {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .form-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .history-item {
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        .history-item:last-child {
            border-bottom: none;
        }
        .status-pending, .status-processing { color: #007bff; }
        .status-finished { color: #28a745; }
        .status-error { color: #dc3545; }
        /* –°—Ç–∏–ª—å –¥–ª—è —Å–∫—Ä–æ–ª–ª–∏—Ä—É–µ–º–æ–≥–æ —Å–ø–∏—Å–∫–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ */
        .modal-list-container {
            max-height: 400px; /* –í—ã—Å–æ—Ç–∞ –¥–æ –ø–æ—è–≤–ª–µ–Ω–∏—è —Å–∫—Ä–æ–ª–ª–∞ */
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('index') }}">üí∞ Crypto Rates</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="{{ url_for('index') }}">–ö—É—Ä—Å—ã</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('chart') }}">–ì—Ä–∞—Ñ–∏–∫–∏</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('show_crypto_table') }}">–¢–∞–±–ª–∏—Ü–∞ –∫—É—Ä—Å–æ–≤</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('historical_data') }}">–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('show_requests_table') }}">–û—á–µ—Ä–µ–¥—å –∑–∞–ø—Ä–æ—Å–æ–≤</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('show_users_table') }}">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('show_log_table') }}">–õ–æ–≥–∏</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('show_main_crypto_rates_to_btc') }}">–ö—É—Ä—Å—ã –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç –∫ BTC</a>
                    </li>
                </ul>
                <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –∏ —Å—Å—ã–ª–∫–∏ –Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é -->
                {% if user %}
                <div class="user-info text-light">
                    <span>{{ user.first_name }}</span>
                    {% if user.username %}
                    <span class="text-muted">@{{ user.username }}</span>
                    {% endif %}
                </div>
                <a href="{{ url_for('logout') }}" class="btn btn-outline-light ms-2">–í—ã–π—Ç–∏</a>
                {% else %}
                <a href="{{ url_for('auth') }}" class="btn btn-outline-light">–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</a>
                {% endif %}
            </div>
        </div>
    </nav>
    <div class="container mt-4">
        <h1 class="mb-4">üí∞ –ö–æ–Ω–≤–µ—Ä—Ç–µ—Ä –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç</h1>
        <!-- –°—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î -->
        {% if not db_connected %}
        <div class="alert alert-danger" role="alert">
            ‚ö†Ô∏è –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –æ—Ç–∫–ª—é—á–µ–Ω–æ. –ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –º–æ–≥—É—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å.
            <form method="POST" action="{{ url_for('connect_db') }}" class="d-inline">
                <button type="submit" class="btn btn-success btn-sm ms-2">–ü–æ–¥–∫–ª—é—á–∏—Ç—å</button>
            </form>
        </div>
        {% endif %}
        <!-- Flash —Å–æ–æ–±—â–µ–Ω–∏—è -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else 'info' }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        {% if user %}
        <div class="row mb-3">
            <div class="col-md-4">
                <div class="card bg-light">
                    <div class="card-body">
                        <h6 class="card-title">Pending –∑–∞–ø—Ä–æ—Å—ã</h6>
                        <p class="card-text">{{ pending_requests_count }}</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-light">
                    <div class="card-body">
                        <h6 class="card-title">Processing –∑–∞–ø—Ä–æ—Å—ã</h6>
                        <p class="card-text">{{ processing_requests_count }}</p>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        <!-- –§–æ—Ä–º–∞ –∑–∞–ø—Ä–æ—Å–∞ -->
        <div class="form-container">
            <form method="POST" action="{{ url_for('index') }}">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label for="crypto" class="form-label">–ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞</label>
                        <select class="form-select" id="crypto" name="crypto" required>
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç—É...</option>
                            <!-- –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ 50 –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç -->
                            {% for crypto in cryptos[:50] %}
                                <option value="{{ crypto }}" {{'selected' if current_crypto == crypto }}>
                                    {{ crypto.upper() }}
                                </option>
                            {% endfor %}
                        </select>
                        <!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ -->
                        <button type="button" class="btn btn-link p-0 mt-1" data-bs-toggle="modal" data-bs-target="#cryptoModal">
                            –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ...
                        </button>
                    </div>
                    <div class="col-md-4">
                        <label for="currency" class="form-label">–í–∞–ª—é—Ç–∞</label>
                        <select class="form-select" id="currency" name="currency" required>
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞–ª—é—Ç—É...</option>
                            {% for currency in currencies %}
                                <option value="{{ currency }}" {{ 'selected' if current_currency == currency }}>
                                    {{ currency.upper() }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label>&nbsp;</label> <!-- –ü—É—Å—Ç–∞—è –º–µ—Ç–∫–∞ –¥–ª—è –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è -->
                        <button type="submit" class="btn btn-primary w-100">
                            –ü–æ–ª—É—á–∏—Ç—å –∫—É—Ä—Å
                        </button>
                    </div>
                </div>
            </form>
        </div>
        <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç -->
        <div class="modal fade" id="cryptoModal" tabindex="-1" aria-labelledby="cryptoModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="cryptoModalLabel">–í—ã–±–µ—Ä–∏—Ç–µ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç—É</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å–ø–∏—Å–∫–∞ —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é —Å–∫—Ä–æ–ª–ª–∞ -->
                        <div class="modal-list-container">
                            <ul class="list-group">
                                <!-- –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç—ã (–ø–æ—Å–ª–µ –ø–µ—Ä–≤—ã—Ö 50) -->
                                {% for crypto in cryptos[50:] %}
                                    <li class="list-group-item list-group-item-action crypto-item" data-crypto="{{ crypto }}">
                                        {{ crypto.upper() }}
                                    </li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ -->
        {% if current_request_id %}
        <div class="rate-display">
            <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ "–†–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–ø—Ä–æ—Å–∞ ID: ..." —Ç–µ–ø–µ—Ä—å –º–µ–ª–∫–∏–π –∏ —Å–µ—Ä—ã–π -->
            <div class="text-muted small mb-3">üìä –†–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–ø—Ä–æ—Å–∞ ID: {{ current_request_id }}</div>
            <div id="request-result-container">
                <div id="request-result-placeholder"></div>
            </div>
        </div>
        {% else %}
        <div class="rate-display">
            <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ "–†–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–ø—Ä–æ—Å–∞" —Ç–µ–ø–µ—Ä—å –º–µ–ª–∫–∏–π –∏ —Å–µ—Ä—ã–π -->
            <div class="text-muted small mb-3">üìä –†–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–ø—Ä–æ—Å–∞</div>
            <p>–ó–∞–ø—Ä–æ—Å –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω.</p>
        </div>
        {% endif %}

        <!-- –ò—Å—Ç–æ—Ä–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ -->
        {% if user %}
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="card-title">üìã –ò—Å—Ç–æ—Ä–∏—è –≤–∞—à–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤</h5>
            </div>
            <div class="card-body">
                {% if requests_history %}
                    {% for req in requests_history %}
                    <div class="history-item">
                        <strong>{{ req.crypto.upper() }} / {{ req.currency.upper() }}</strong> -
                        –°—Ç–∞—Ç—É—Å: <span class="status-{{ req.status }}">{{ req.status }}</span>
                        {% if req.rate %} | –ö—É—Ä—Å: {{ "%.8f"|format(req.rate) }} {% endif %}
                        {% if req.error %} | –û—à–∏–±–∫–∞: {{ req.error }} {% endif %}
                        <small class="text-muted">({{ req.created_at }})</small>
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="text-muted">–ò—Å—Ç–æ—Ä–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ –ø—É—Å—Ç–∞.</p>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>
    <footer class="bg-dark text-light py-4 mt-5">
        <div class="container text-center">
            <p class="mb-0">Crypto Rates App &copy; 2025 | Real-time cryptocurrency rates</p>
        </div>
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ —Å –ø–æ–≤—Ç–æ—Ä–Ω—ã–º–∏ –ø–æ–ø—ã—Ç–∫–∞–º–∏
        function fetchLastRequestStatus(requestId) {
            if (!requestId) return;

            const resultDiv = document.getElementById('request-result-placeholder');
            if (!resultDiv) return;

            let isChecking = true; // –§–ª–∞–≥ –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø—Ä–æ–≤–µ—Ä–æ–∫

            const checkStatus = () => {
                if (!isChecking) return; // –ï—Å–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã, –≤—ã—Ö–æ–¥–∏–º

                fetch(`/request-status/${requestId}`)
                 .then(response => {
                     if (!response.ok) {
                         throw new Error(`HTTP error! status: ${response.status}`);
                     }
                     return response.json();
                 })
                 .then(data => {
                     if (!isChecking) return; // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–ª–∞–≥ —Å–Ω–æ–≤–∞ –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

                     if (data.success) {
                         let statusText = `–°—Ç–∞—Ç—É—Å: ${data.status}`;
                         let rateText = '';
                         if (data.status === 'finished' && data.rate !== undefined) {
                             // --- –ò–ó–ú–ï–ù–ï–ù–ò–ï: –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫—É—Ä—Å–∞ ---
                             rateText = `<p class="fs-4 fw-bold text-primary">–ö—É—Ä—Å: ${data.rate.toFixed(8)} ${data.currency.toUpperCase()}</p>`;
                             // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫–∏, —Ç–∞–∫ –∫–∞–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–ª—É—á–µ–Ω
                             isChecking = false;
                         } else if (data.status === 'error' && data.error) {
                             statusText += ` | –û—à–∏–±–∫–∞: ${data.error}`;
                             // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫–∏, —Ç–∞–∫ –∫–∞–∫ –æ—à–∏–±–∫–∞
                             isChecking = false;
                         }
                         // --- –ò–ó–ú–ï–ù–ï–ù–ò–ï: –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ ---
                         resultDiv.innerHTML = `<p class="text-muted small">${statusText}</p>`;
                         // –ï—Å–ª–∏ –∫—É—Ä—Å –±—ã–ª —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ –ø–æ—Å–ª–µ —Å—Ç–∞—Ç—É—Å–∞
                         if (rateText) {
                             resultDiv.innerHTML += rateText;
                         }
                     } else {
                         resultDiv.innerHTML = `<p class="text-danger small">–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞: ${data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}</p>`;
                         // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∏ –æ—à–∏–±–∫–µ –æ—Ç–≤–µ—Ç–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
                         isChecking = false;
                     }
                 })
                 .catch(error => {
                     console.error('Error fetching request status:', error);
                     if (isChecking) { // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–ª–∞–≥, —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                         resultDiv.innerHTML = '<p class="text-danger small">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–ø—Ä–æ—Å–∞.</p>';
                         // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∏ –æ—à–∏–±–∫–µ —Å–µ—Ç–∏/–∑–∞–ø—Ä–æ—Å–∞
                         isChecking = false;
                     }
                 });
            };

            // –í—ã–∑—ã–≤–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É —Å—Ä–∞–∑—É
            checkStatus();
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã
            const intervalId = setInterval(checkStatus, 2000);

            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
            const stopChecking = () => {
                isChecking = false;
                clearInterval(intervalId);
            };

            // –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –æ—Å—Ç–∞–Ω–æ–≤–∫—É –ø—Ä–æ–≤–µ—Ä–æ–∫ –∫ —Å–æ–±—ã—Ç–∏—é —Ä–∞–∑–≥—Ä—É–∑–∫–∏ –æ–∫–Ω–∞ (–ø–µ—Ä–µ—Ö–æ–¥ –ø–æ —Å—Å—ã–ª–∫–µ, –∑–∞–∫—Ä—ã—Ç–∏–µ –≤–∫–ª–∞–¥–∫–∏)
            // –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤, –∫–æ–≥–¥–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —É–∂–µ –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞
            window.addEventListener('beforeunload', stopChecking);
        }

        // –ó–∞–ø—É—Å–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã, –µ—Å–ª–∏ –µ—Å—Ç—å ID –∑–∞–ø—Ä–æ—Å–∞
        document.addEventListener('DOMContentLoaded', function() {
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–µ–ª–µ–∫—Ç–æ—Ä –¥–ª—è –ø–æ–∏—Å–∫–∞ ID –∑–∞–ø—Ä–æ—Å–∞, —Ç–∞–∫ –∫–∞–∫ –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–µ–ø–µ—Ä—å div
            const currentRequestIdElement = document.querySelector('div.rate-display div.text-muted.small'); // –ù–∞—Ö–æ–¥–∏–º —ç–ª–µ–º–µ–Ω—Ç —Å ID –∑–∞–ø—Ä–æ—Å–∞
            if (currentRequestIdElement) {
                const requestIdText = currentRequestIdElement.textContent; // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—Å—Ç "üìä –†–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–ø—Ä–æ—Å–∞ ID: 123"
                const requestIdMatch = requestIdText.match(/ID: (\d+)/); // –ò—â–µ–º —á–∏—Å–ª–æ –ø–æ—Å–ª–µ "ID: "
                if (requestIdMatch) {
                    const requestId = parseInt(requestIdMatch[1], 10);
                    if (!isNaN(requestId)) {
                        fetchLastRequestStatus(requestId);
                    }
                }
            }

            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ –∞–ª–µ—Ä—Ç–æ–≤ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
            setTimeout(function() {
                var alerts = document.querySelectorAll('.alert');
                alerts.forEach(function(alert) {
                    if (!alert.classList.contains('alert-dismissible')) return; // –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –∫–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è
                    var bsAlert = new bootstrap.Alert(alert);
                    bsAlert.close();
                });
            }, 5000);

            // --- –õ–æ–≥–∏–∫–∞ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ ---
            // –ù–∞—Ö–æ–¥–∏–º –æ—Å–Ω–æ–≤–Ω–æ–π select
            const cryptoSelect = document.getElementById('crypto');
            if (!cryptoSelect) {
                console.error("–≠–ª–µ–º–µ–Ω—Ç —Å ID 'crypto' –Ω–µ –Ω–∞–π–¥–µ–Ω!");
                return; // –ü—Ä–µ—Ä—ã–≤–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ, –µ—Å–ª–∏ select –Ω–µ –Ω–∞–π–¥–µ–Ω
            }

            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ–ø—Ü–∏–∏ –≤ select, –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
            function addOptionToSelect(selectElement, value, text) {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ —Ç–∞–∫–∞—è –æ–ø—Ü–∏—è
                const existingOption = Array.from(selectElement.options).find(option => option.value === value);
                if (!existingOption) {
                    const newOption = document.createElement('option');
                    newOption.value = value;
                    newOption.textContent = text;
                    selectElement.appendChild(newOption);
                } else {
                    // –ï—Å–ª–∏ –æ–ø—Ü–∏—è —É–∂–µ –µ—Å—Ç—å, –ø—Ä–æ—Å—Ç–æ —É–±–µ–¥–∏–º—Å—è, —á—Ç–æ –æ–Ω–∞ –≤—ã–±—Ä–∞–Ω–∞
                    existingOption.selected = true;
                }
            }

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è 'shown.bs.modal' –¥–ª—è #cryptoModal
            // –≠—Ç–æ —Å–æ–±—ã—Ç–∏–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–æ—Å–ª–µ —Ç–æ–≥–æ, –∫–∞–∫ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ—Ç–∫—Ä—ã—Ç–æ –∏ –µ–≥–æ DOM-—Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –¥–æ—Å—Ç—É–ø–Ω–æ
            document.getElementById('cryptoModal').addEventListener('shown.bs.modal', function () {
                console.log("–ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ—Ç–∫—Ä—ã—Ç–æ, –∏—â–µ–º .crypto-item"); // –û—Ç–ª–∞–¥–∫–∞

                // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã —Å–ø–∏—Å–∫–∞ *–≤–Ω—É—Ç—Ä–∏* –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ *—Å–µ–π—á–∞—Å*
                const cryptoItems = this.querySelectorAll('.crypto-item');
                console.log(`–ù–∞–π–¥–µ–Ω–æ ${cryptoItems.length} —ç–ª–µ–º–µ–Ω—Ç–æ–≤ .crypto-item –≤–Ω—É—Ç—Ä–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞`); // –û—Ç–ª–∞–¥–∫–∞

                cryptoItems.forEach(item => {
                    // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–µ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –¥–≤–∞–∂–¥—ã
                    // (—Ö–æ—Ç—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –æ–Ω –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –∑–∞–Ω–æ–≤–æ, –Ω–æ —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ,
                    // —Ç.–∫. —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ç–µ—Ä—è—é—Ç—Å—è –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞)
                    item.addEventListener('click', function() {
                        const selectedCrypto = this.getAttribute('data-crypto');
                        const selectedCryptoText = this.textContent.trim(); // –ë–µ—Ä–µ–º —Ç–µ–∫—Å—Ç –∏–∑ —ç–ª–µ–º–µ–Ω—Ç–∞ —Å–ø–∏—Å–∫–∞
                        console.log(`–ö–ª–∏–∫ –ø–æ —ç–ª–µ–º–µ–Ω—Ç—É –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ: ${selectedCrypto}, —Ç–µ–∫—Å—Ç: ${selectedCryptoText}`); // –û—Ç–ª–∞–¥–∫–∞
                        if (selectedCrypto) {
                            // –î–æ–±–∞–≤–ª—è–µ–º –æ–ø—Ü–∏—é –≤ –æ—Å–Ω–æ–≤–Ω–æ–π select, –µ—Å–ª–∏ –µ—ë —Ç–∞–º –Ω–µ—Ç
                            addOptionToSelect(cryptoSelect, selectedCrypto, selectedCryptoText);
                            // –¢–µ–ø–µ—Ä—å —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ (—ç—Ç–æ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç, —Ç–∞–∫ –∫–∞–∫ –æ–ø—Ü–∏—è —Ç–µ–ø–µ—Ä—å —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
                            cryptoSelect.value = selectedCrypto;
                            console.log(`–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –∑–Ω–∞—á–µ–Ω–∏–µ –≤ #crypto: ${selectedCrypto}`); // –û—Ç–ª–∞–¥–∫–∞
                            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                            const modal = bootstrap.Modal.getInstance(this.closest('.modal'));
                            if (modal) {
                                modal.hide();
                            }
                        }
                    });
                });
            });

        });
    </script>
</body>
</html>