2025-12-08 15:16:13,623 - ERROR - [crypto_api.backend] User=None | Ошибка миграции базы данных: maximum recursion depth exceeded
Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 282, in get_db
    yield db
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 300, in migrate_database
    result = db.execute("""
             ~~~~~~~~~~^^^^
        SELECT COUNT(*)
        ^^^^^^^^^^^^^^^
    ...<3 lines>...
        AND column_name = 'host'
        ^^^^^^^^^^^^^^^^^^^^^^^^
    """).fetchone()
    ^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2147, in _execute_internal
    statement = coercions.expect(roles.StatementRole, statement)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 395, in expect
    resolved = impl._literal_coercion(
        element, argname=argname, **kw
    )
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 621, in _literal_coercion
    return self._text_coercion(element, argname, **kw)
           ~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 614, in _text_coercion
    return _no_text_coercion(element, argname)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 584, in _no_text_coercion
    raise exc_cls(
    ...<7 lines>...
    ) from err
sqlalchemy.exc.ArgumentError: Textual SQL expression '\n                SELECT C...' should be explicitly declared as text('\n                SELECT C...')

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 789, in _read_bytes
    data = self._rfile.read(num_bytes)
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\socket.py", line 715, in readinto
    self._checkReadable()
    ~~~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1301, in _checkout
    result = pool._dialect._do_ping_w_event(
        fairy.dbapi_connection
    )
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 728, in _do_ping_w_event
    return self.do_ping(dbapi_connection)
           ~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\dialects\mysql\pymysql.py", line 121, in do_ping
    dbapi_connection.ping(False)
    ~~~~~~~~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 607, in ping
    self._read_ok_packet()
    ~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 465, in _read_ok_packet
    pkt = self._read_packet()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 751, in _read_packet
    packet_header = self._read_bytes(4)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 801, in _read_bytes
    self._force_close()
    ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 444, in _force_close
    self._rfile.close()
    ~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 372, in _close_connection
    self._dialect.do_terminate(connection)
    ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 717, in do_terminate
    self.do_close(dbapi_connection)
    ~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 720, in do_close
    dbapi_connection.close()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 434, in close
    self._force_close()
    ~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 298, in migrate_database
    with get_db() as db:
         ~~~~~~^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 286, in get_db
    log_message(f"Ошибка БД: {e}", 'error')
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 214, in log_message
    db.commit()
    ~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2030, in commit
    trans.commit(_to_root=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "<string>", line 2, in commit
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1311, in commit
    self._prepare_impl()
    ~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 2, in _prepare_impl
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1286, in _prepare_impl
    self.session.flush()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4331, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4466, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4427, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 68, in save_obj
    ) in _organize_states_for_save(base_mapper, states, uowtransaction):
         ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 223, in _organize_states_for_save
    for state, dict_, mapper, connection in _connections_for_states(
                                            ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper, uowtransaction, states
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ):
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 1759, in _connections_for_states
    connection = uowtransaction.transaction.connection(base_mapper)
  File "<string>", line 2, in connection
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1037, in connection
    return self._connection_for_bind(bind, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1173, in _connection_for_bind
    conn = self._parent._connection_for_bind(
        bind, execution_options
    )
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1187, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3277, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 143, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3301, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 447, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1363, in _checkout
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 228, in __exit__
    raise value.with_traceback(traceback)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1366, in _checkout
    rec._checkin_failed(
    ~~~~~~~~~~~~~~~~~~~^
        be_outer,
        ^^^^^^^^^
        _fairy_was_created=True,
        ^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 745, in _checkin_failed
    self.invalidate(e=err)
    ~~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 815, in invalidate
    self.__close(terminate=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 882, in __close
    self.__pool._close_connection(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.dbapi_connection, terminate=terminate
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 376, in _close_connection
    self.logger.error(
    ~~~~~~~~~~~~~~~~~^
        f"Exception {'terminating' if terminate else 'closing'} "
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<2 lines>...
        exc_info=True,
        ^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\logging\__init__.py", line 1549, in error
    self._log(ERROR, msg, args, **kwargs)
    ~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\logging\__init__.py", line 1653, in _log
    fn, lno, func, sinfo = self.findCaller(stack_info, stacklevel)
                           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\logging\__init__.py", line 1597, in findCaller
    f = currentframe()
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 661, in connect
    sock = socket.create_connection(
        (self.host, self.port), self.connect_timeout, **kwargs
    )
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 298, in migrate_database
    with get_db() as db:
         ~~~~~~^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 286, in get_db
    log_message(f"Ошибка БД: {e}", 'error')
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 219, in log_message
    migrate_database()
    ~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 337, in migrate_database
    log_message(f"Ошибка миграции базы данных: {e}", 'error', traceback=str(e))
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 214, in log_message
    db.commit()
    ~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2030, in commit
    trans.commit(_to_root=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "<string>", line 2, in commit
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1311, in commit
    self._prepare_impl()
    ~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 2, in _prepare_impl
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1286, in _prepare_impl
    self.session.flush()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4331, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4466, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4427, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 68, in save_obj
    ) in _organize_states_for_save(base_mapper, states, uowtransaction):
         ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 223, in _organize_states_for_save
    for state, dict_, mapper, connection in _connections_for_states(
                                            ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper, uowtransaction, states
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ):
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 1759, in _connections_for_states
    connection = uowtransaction.transaction.connection(base_mapper)
  File "<string>", line 2, in connection
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1037, in connection
    return self._connection_for_bind(bind, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1173, in _connection_for_bind
    conn = self._parent._connection_for_bind(
        bind, execution_options
    )
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1187, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3277, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 143, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3301, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 447, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1264, in _checkout
    fairy = _ConnectionRecord.checkout(pool)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 711, in checkout
    rec = pool._do_get()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 177, in _do_get
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 175, in _do_get
    return self._create_connection()
           ~~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 388, in _create_connection
    return _ConnectionRecord(self)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 673, in __init__
    self.__connect()
    ~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 899, in __connect
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 895, in __connect
    self.dbapi_connection = connection = pool._invoke_creator(self)
                                         ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\create.py", line 661, in connect
    return dialect.connect(*cargs, **cparams)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 629, in connect
    return self.loaded_dbapi.connect(*cargs, **cparams)  # type: ignore[no-any-return]  # NOQA: E501
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 365, in __init__
    self.connect()
    ~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 711, in connect
    self._force_close()
    ~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded
2025-12-08 15:16:13,641 - ERROR - [crypto_api.backend] User=None | Ошибка миграции базы данных: maximum recursion depth exceeded
Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 282, in get_db
    yield db
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 300, in migrate_database
    result = db.execute("""
             ~~~~~~~~~~^^^^
        SELECT COUNT(*)
        ^^^^^^^^^^^^^^^
    ...<3 lines>...
        AND column_name = 'host'
        ^^^^^^^^^^^^^^^^^^^^^^^^
    """).fetchone()
    ^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2147, in _execute_internal
    statement = coercions.expect(roles.StatementRole, statement)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 395, in expect
    resolved = impl._literal_coercion(
        element, argname=argname, **kw
    )
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 621, in _literal_coercion
    return self._text_coercion(element, argname, **kw)
           ~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 614, in _text_coercion
    return _no_text_coercion(element, argname)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 584, in _no_text_coercion
    raise exc_cls(
    ...<7 lines>...
    ) from err
sqlalchemy.exc.ArgumentError: Textual SQL expression '\n                SELECT C...' should be explicitly declared as text('\n                SELECT C...')

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 789, in _read_bytes
    data = self._rfile.read(num_bytes)
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\socket.py", line 715, in readinto
    self._checkReadable()
    ~~~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1301, in _checkout
    result = pool._dialect._do_ping_w_event(
        fairy.dbapi_connection
    )
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 728, in _do_ping_w_event
    return self.do_ping(dbapi_connection)
           ~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\dialects\mysql\pymysql.py", line 121, in do_ping
    dbapi_connection.ping(False)
    ~~~~~~~~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 607, in ping
    self._read_ok_packet()
    ~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 465, in _read_ok_packet
    pkt = self._read_packet()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 751, in _read_packet
    packet_header = self._read_bytes(4)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 801, in _read_bytes
    self._force_close()
    ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 444, in _force_close
    self._rfile.close()
    ~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 372, in _close_connection
    self._dialect.do_terminate(connection)
    ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 717, in do_terminate
    self.do_close(dbapi_connection)
    ~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 720, in do_close
    dbapi_connection.close()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 434, in close
    self._force_close()
    ~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 298, in migrate_database
    with get_db() as db:
         ~~~~~~^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 286, in get_db
    log_message(f"Ошибка БД: {e}", 'error')
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 214, in log_message
    db.commit()
    ~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2030, in commit
    trans.commit(_to_root=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "<string>", line 2, in commit
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1311, in commit
    self._prepare_impl()
    ~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 2, in _prepare_impl
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1286, in _prepare_impl
    self.session.flush()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4331, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4466, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4427, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 68, in save_obj
    ) in _organize_states_for_save(base_mapper, states, uowtransaction):
         ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 223, in _organize_states_for_save
    for state, dict_, mapper, connection in _connections_for_states(
                                            ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper, uowtransaction, states
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ):
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 1759, in _connections_for_states
    connection = uowtransaction.transaction.connection(base_mapper)
  File "<string>", line 2, in connection
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1037, in connection
    return self._connection_for_bind(bind, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1173, in _connection_for_bind
    conn = self._parent._connection_for_bind(
        bind, execution_options
    )
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1187, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3277, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 143, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3301, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 447, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1363, in _checkout
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 228, in __exit__
    raise value.with_traceback(traceback)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1366, in _checkout
    rec._checkin_failed(
    ~~~~~~~~~~~~~~~~~~~^
        be_outer,
        ^^^^^^^^^
        _fairy_was_created=True,
        ^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 745, in _checkin_failed
    self.invalidate(e=err)
    ~~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 815, in invalidate
    self.__close(terminate=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 882, in __close
    self.__pool._close_connection(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.dbapi_connection, terminate=terminate
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 376, in _close_connection
    self.logger.error(
    ~~~~~~~~~~~~~~~~~^
        f"Exception {'terminating' if terminate else 'closing'} "
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<2 lines>...
        exc_info=True,
        ^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\logging\__init__.py", line 1549, in error
    self._log(ERROR, msg, args, **kwargs)
    ~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\logging\__init__.py", line 1653, in _log
    fn, lno, func, sinfo = self.findCaller(stack_info, stacklevel)
                           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\logging\__init__.py", line 1597, in findCaller
    f = currentframe()
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 661, in connect
    sock = socket.create_connection(
        (self.host, self.port), self.connect_timeout, **kwargs
    )
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 298, in migrate_database
    with get_db() as db:
         ~~~~~~^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 286, in get_db
    log_message(f"Ошибка БД: {e}", 'error')
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 219, in log_message
    migrate_database()
    ~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 337, in migrate_database
    log_message(f"Ошибка миграции базы данных: {e}", 'error', traceback=str(e))
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 214, in log_message
    db.commit()
    ~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2030, in commit
    trans.commit(_to_root=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "<string>", line 2, in commit
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1311, in commit
    self._prepare_impl()
    ~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 2, in _prepare_impl
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1286, in _prepare_impl
    self.session.flush()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4331, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4466, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4427, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 68, in save_obj
    ) in _organize_states_for_save(base_mapper, states, uowtransaction):
         ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 223, in _organize_states_for_save
    for state, dict_, mapper, connection in _connections_for_states(
                                            ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper, uowtransaction, states
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ):
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 1759, in _connections_for_states
    connection = uowtransaction.transaction.connection(base_mapper)
  File "<string>", line 2, in connection
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1037, in connection
    return self._connection_for_bind(bind, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1173, in _connection_for_bind
    conn = self._parent._connection_for_bind(
        bind, execution_options
    )
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1187, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3277, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 143, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3301, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 447, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1264, in _checkout
    fairy = _ConnectionRecord.checkout(pool)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 711, in checkout
    rec = pool._do_get()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 177, in _do_get
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 175, in _do_get
    return self._create_connection()
           ~~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 388, in _create_connection
    return _ConnectionRecord(self)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 673, in __init__
    self.__connect()
    ~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 899, in __connect
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 895, in __connect
    self.dbapi_connection = connection = pool._invoke_creator(self)
                                         ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\create.py", line 661, in connect
    return dialect.connect(*cargs, **cparams)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 629, in connect
    return self.loaded_dbapi.connect(*cargs, **cparams)  # type: ignore[no-any-return]  # NOQA: E501
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 365, in __init__
    self.connect()
    ~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 711, in connect
    self._force_close()
    ~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 298, in migrate_database
    with get_db() as db:
         ~~~~~~^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 286, in get_db
    log_message(f"Ошибка БД: {e}", 'error')
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 219, in log_message
    migrate_database()
    ~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 337, in migrate_database
    log_message(f"Ошибка миграции базы данных: {e}", 'error', traceback=str(e))
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 214, in log_message
    db.commit()
    ~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2030, in commit
    trans.commit(_to_root=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "<string>", line 2, in commit
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1311, in commit
    self._prepare_impl()
    ~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 2, in _prepare_impl
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1286, in _prepare_impl
    self.session.flush()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4331, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4466, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4427, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 68, in save_obj
    ) in _organize_states_for_save(base_mapper, states, uowtransaction):
         ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 223, in _organize_states_for_save
    for state, dict_, mapper, connection in _connections_for_states(
                                            ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper, uowtransaction, states
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ):
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 1759, in _connections_for_states
    connection = uowtransaction.transaction.connection(base_mapper)
  File "<string>", line 2, in connection
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1037, in connection
    return self._connection_for_bind(bind, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1173, in _connection_for_bind
    conn = self._parent._connection_for_bind(
        bind, execution_options
    )
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1187, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3277, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 143, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3301, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 447, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1264, in _checkout
    fairy = _ConnectionRecord.checkout(pool)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 711, in checkout
    rec = pool._do_get()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 177, in _do_get
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 175, in _do_get
    return self._create_connection()
           ~~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 388, in _create_connection
    return _ConnectionRecord(self)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 673, in __init__
    self.__connect()
    ~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 899, in __connect
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 895, in __connect
    self.dbapi_connection = connection = pool._invoke_creator(self)
                                         ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\create.py", line 661, in connect
    return dialect.connect(*cargs, **cparams)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 629, in connect
    return self.loaded_dbapi.connect(*cargs, **cparams)  # type: ignore[no-any-return]  # NOQA: E501
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 365, in __init__
    self.connect()
    ~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 661, in connect
    sock = socket.create_connection(
        (self.host, self.port), self.connect_timeout, **kwargs
    )
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\socket.py", line 840, in create_connection
    for res in getaddrinfo(host, port, 0, SOCK_STREAM):
               ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\socket.py", line 979, in getaddrinfo
    addrlist.append((_intenum_converter(af, AddressFamily),
                     ~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\socket.py", line 106, in _intenum_converter
    return enum_klass(value)
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\enum.py", line 726, in __call__
    return cls.__new__(cls, value)
           ~~~~~~~~~~~^^^^^^^^^^^^
RecursionError: maximum recursion depth exceeded
2025-12-08 15:16:13,738 - ERROR - [crypto_api.backend] User=None | Ошибка миграции базы данных: maximum recursion depth exceeded
Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 282, in get_db
    yield db
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 300, in migrate_database
    result = db.execute("""
             ~~~~~~~~~~^^^^
        SELECT COUNT(*)
        ^^^^^^^^^^^^^^^
    ...<3 lines>...
        AND column_name = 'host'
        ^^^^^^^^^^^^^^^^^^^^^^^^
    """).fetchone()
    ^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2147, in _execute_internal
    statement = coercions.expect(roles.StatementRole, statement)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 395, in expect
    resolved = impl._literal_coercion(
        element, argname=argname, **kw
    )
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 621, in _literal_coercion
    return self._text_coercion(element, argname, **kw)
           ~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 614, in _text_coercion
    return _no_text_coercion(element, argname)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 584, in _no_text_coercion
    raise exc_cls(
    ...<7 lines>...
    ) from err
sqlalchemy.exc.ArgumentError: Textual SQL expression '\n                SELECT C...' should be explicitly declared as text('\n                SELECT C...')

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 789, in _read_bytes
    data = self._rfile.read(num_bytes)
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\socket.py", line 715, in readinto
    self._checkReadable()
    ~~~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1301, in _checkout
    result = pool._dialect._do_ping_w_event(
        fairy.dbapi_connection
    )
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 728, in _do_ping_w_event
    return self.do_ping(dbapi_connection)
           ~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\dialects\mysql\pymysql.py", line 121, in do_ping
    dbapi_connection.ping(False)
    ~~~~~~~~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 607, in ping
    self._read_ok_packet()
    ~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 465, in _read_ok_packet
    pkt = self._read_packet()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 751, in _read_packet
    packet_header = self._read_bytes(4)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 801, in _read_bytes
    self._force_close()
    ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 444, in _force_close
    self._rfile.close()
    ~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 372, in _close_connection
    self._dialect.do_terminate(connection)
    ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 717, in do_terminate
    self.do_close(dbapi_connection)
    ~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 720, in do_close
    dbapi_connection.close()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 434, in close
    self._force_close()
    ~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 298, in migrate_database
    with get_db() as db:
         ~~~~~~^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 286, in get_db
    log_message(f"Ошибка БД: {e}", 'error')
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 214, in log_message
    db.commit()
    ~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2030, in commit
    trans.commit(_to_root=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "<string>", line 2, in commit
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1311, in commit
    self._prepare_impl()
    ~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 2, in _prepare_impl
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1286, in _prepare_impl
    self.session.flush()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4331, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4466, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4427, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 68, in save_obj
    ) in _organize_states_for_save(base_mapper, states, uowtransaction):
         ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 223, in _organize_states_for_save
    for state, dict_, mapper, connection in _connections_for_states(
                                            ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper, uowtransaction, states
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ):
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 1759, in _connections_for_states
    connection = uowtransaction.transaction.connection(base_mapper)
  File "<string>", line 2, in connection
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1037, in connection
    return self._connection_for_bind(bind, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1173, in _connection_for_bind
    conn = self._parent._connection_for_bind(
        bind, execution_options
    )
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1187, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3277, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 143, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3301, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 447, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1363, in _checkout
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 228, in __exit__
    raise value.with_traceback(traceback)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1366, in _checkout
    rec._checkin_failed(
    ~~~~~~~~~~~~~~~~~~~^
        be_outer,
        ^^^^^^^^^
        _fairy_was_created=True,
        ^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 745, in _checkin_failed
    self.invalidate(e=err)
    ~~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 815, in invalidate
    self.__close(terminate=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 882, in __close
    self.__pool._close_connection(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.dbapi_connection, terminate=terminate
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 376, in _close_connection
    self.logger.error(
    ~~~~~~~~~~~~~~~~~^
        f"Exception {'terminating' if terminate else 'closing'} "
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<2 lines>...
        exc_info=True,
        ^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\logging\__init__.py", line 1549, in error
    self._log(ERROR, msg, args, **kwargs)
    ~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\logging\__init__.py", line 1653, in _log
    fn, lno, func, sinfo = self.findCaller(stack_info, stacklevel)
                           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\logging\__init__.py", line 1597, in findCaller
    f = currentframe()
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 661, in connect
    sock = socket.create_connection(
        (self.host, self.port), self.connect_timeout, **kwargs
    )
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 298, in migrate_database
    with get_db() as db:
         ~~~~~~^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 286, in get_db
    log_message(f"Ошибка БД: {e}", 'error')
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 219, in log_message
    migrate_database()
    ~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 337, in migrate_database
    log_message(f"Ошибка миграции базы данных: {e}", 'error', traceback=str(e))
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 214, in log_message
    db.commit()
    ~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2030, in commit
    trans.commit(_to_root=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "<string>", line 2, in commit
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1311, in commit
    self._prepare_impl()
    ~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 2, in _prepare_impl
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1286, in _prepare_impl
    self.session.flush()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4331, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4466, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4427, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 68, in save_obj
    ) in _organize_states_for_save(base_mapper, states, uowtransaction):
         ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 223, in _organize_states_for_save
    for state, dict_, mapper, connection in _connections_for_states(
                                            ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper, uowtransaction, states
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ):
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 1759, in _connections_for_states
    connection = uowtransaction.transaction.connection(base_mapper)
  File "<string>", line 2, in connection
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1037, in connection
    return self._connection_for_bind(bind, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1173, in _connection_for_bind
    conn = self._parent._connection_for_bind(
        bind, execution_options
    )
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1187, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3277, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 143, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3301, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 447, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1264, in _checkout
    fairy = _ConnectionRecord.checkout(pool)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 711, in checkout
    rec = pool._do_get()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 177, in _do_get
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 175, in _do_get
    return self._create_connection()
           ~~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 388, in _create_connection
    return _ConnectionRecord(self)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 673, in __init__
    self.__connect()
    ~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 899, in __connect
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 895, in __connect
    self.dbapi_connection = connection = pool._invoke_creator(self)
                                         ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\create.py", line 661, in connect
    return dialect.connect(*cargs, **cparams)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 629, in connect
    return self.loaded_dbapi.connect(*cargs, **cparams)  # type: ignore[no-any-return]  # NOQA: E501
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 365, in __init__
    self.connect()
    ~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 711, in connect
    self._force_close()
    ~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 298, in migrate_database
    with get_db() as db:
         ~~~~~~^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 286, in get_db
    log_message(f"Ошибка БД: {e}", 'error')
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 219, in log_message
    migrate_database()
    ~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 337, in migrate_database
    log_message(f"Ошибка миграции базы данных: {e}", 'error', traceback=str(e))
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 214, in log_message
    db.commit()
    ~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2030, in commit
    trans.commit(_to_root=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "<string>", line 2, in commit
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1311, in commit
    self._prepare_impl()
    ~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 2, in _prepare_impl
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1286, in _prepare_impl
    self.session.flush()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4331, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4466, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4427, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 68, in save_obj
    ) in _organize_states_for_save(base_mapper, states, uowtransaction):
         ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 223, in _organize_states_for_save
    for state, dict_, mapper, connection in _connections_for_states(
                                            ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper, uowtransaction, states
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ):
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 1759, in _connections_for_states
    connection = uowtransaction.transaction.connection(base_mapper)
  File "<string>", line 2, in connection
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1037, in connection
    return self._connection_for_bind(bind, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1173, in _connection_for_bind
    conn = self._parent._connection_for_bind(
        bind, execution_options
    )
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1187, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3277, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 143, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3301, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 447, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1264, in _checkout
    fairy = _ConnectionRecord.checkout(pool)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 711, in checkout
    rec = pool._do_get()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 177, in _do_get
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 175, in _do_get
    return self._create_connection()
           ~~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 388, in _create_connection
    return _ConnectionRecord(self)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 673, in __init__
    self.__connect()
    ~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 899, in __connect
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 895, in __connect
    self.dbapi_connection = connection = pool._invoke_creator(self)
                                         ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\create.py", line 661, in connect
    return dialect.connect(*cargs, **cparams)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 629, in connect
    return self.loaded_dbapi.connect(*cargs, **cparams)  # type: ignore[no-any-return]  # NOQA: E501
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 365, in __init__
    self.connect()
    ~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 661, in connect
    sock = socket.create_connection(
        (self.host, self.port), self.connect_timeout, **kwargs
    )
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\socket.py", line 840, in create_connection
    for res in getaddrinfo(host, port, 0, SOCK_STREAM):
               ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\socket.py", line 979, in getaddrinfo
    addrlist.append((_intenum_converter(af, AddressFamily),
                     ~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\socket.py", line 106, in _intenum_converter
    return enum_klass(value)
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\enum.py", line 726, in __call__
    return cls.__new__(cls, value)
           ~~~~~~~~~~~^^^^^^^^^^^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 789, in _read_bytes
    data = self._rfile.read(num_bytes)
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\socket.py", line 715, in readinto
    self._checkReadable()
    ~~~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 298, in migrate_database
    with get_db() as db:
         ~~~~~~^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 286, in get_db
    log_message(f"Ошибка БД: {e}", 'error')
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 219, in log_message
    migrate_database()
    ~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 337, in migrate_database
    log_message(f"Ошибка миграции базы данных: {e}", 'error', traceback=str(e))
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 219, in log_message
    migrate_database()
    ~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 337, in migrate_database
    log_message(f"Ошибка миграции базы данных: {e}", 'error', traceback=str(e))
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 219, in log_message
    migrate_database()
    ~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 337, in migrate_database
    log_message(f"Ошибка миграции базы данных: {e}", 'error', traceback=str(e))
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 219, in log_message
    migrate_database()
    ~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 337, in migrate_database
    log_message(f"Ошибка миграции базы данных: {e}", 'error', traceback=str(e))
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 214, in log_message
    db.commit()
    ~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2030, in commit
    trans.commit(_to_root=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "<string>", line 2, in commit
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1311, in commit
    self._prepare_impl()
    ~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 2, in _prepare_impl
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1286, in _prepare_impl
    self.session.flush()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4331, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4466, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4427, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 68, in save_obj
    ) in _organize_states_for_save(base_mapper, states, uowtransaction):
         ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 223, in _organize_states_for_save
    for state, dict_, mapper, connection in _connections_for_states(
                                            ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper, uowtransaction, states
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ):
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 1759, in _connections_for_states
    connection = uowtransaction.transaction.connection(base_mapper)
  File "<string>", line 2, in connection
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1037, in connection
    return self._connection_for_bind(bind, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1173, in _connection_for_bind
    conn = self._parent._connection_for_bind(
        bind, execution_options
    )
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1187, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3277, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 143, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3301, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 447, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1264, in _checkout
    fairy = _ConnectionRecord.checkout(pool)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 711, in checkout
    rec = pool._do_get()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 177, in _do_get
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 175, in _do_get
    return self._create_connection()
           ~~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 388, in _create_connection
    return _ConnectionRecord(self)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 673, in __init__
    self.__connect()
    ~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 913, in __connect
    )._exec_w_sync_on_first_run(self.dbapi_connection, self)
      ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\event\attr.py", line 507, in _exec_w_sync_on_first_run
    self(*args, **kw)
    ~~~~^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\event\attr.py", line 515, in __call__
    fn(*args, **kw)
    ~~^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\create.py", line 739, in on_connect
    do_on_connect(dbapi_connection)
    ~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\dialects\mysql\mysqldb.py", line 180, in on_connect
    cursor.execute("SET NAMES %s" % charset_name)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 575, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 826, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 1203, in read
    first_packet = self.connection._read_packet()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 751, in _read_packet
    packet_header = self._read_bytes(4)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 801, in _read_bytes
    self._force_close()
    ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 444, in _force_close
    self._rfile.close()
    ~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded
2025-12-08 15:16:13,901 - ERROR - [crypto_api.backend] User=None | Ошибка БД: Textual SQL expression '\n                SELECT C...' should be explicitly declared as text('\n                SELECT C...')
2025-12-08 15:16:13,962 - ERROR - [crypto_api.backend] User=None | Ошибка БД: Textual SQL expression '\n                SELECT C...' should be explicitly declared as text('\n                SELECT C...')
2025-12-08 15:16:14,020 - ERROR - [crypto_api.backend] User=None | Ошибка БД: Textual SQL expression '\n                SELECT C...' should be explicitly declared as text('\n                SELECT C...')
2025-12-08 15:16:14,081 - ERROR - [crypto_api.backend] User=None | Ошибка БД: Textual SQL expression '\n                SELECT C...' should be explicitly declared as text('\n                SELECT C...')
2025-12-08 15:16:14,144 - ERROR - [crypto_api.backend] User=None | Ошибка БД: Textual SQL expression '\n                SELECT C...' should be explicitly declared as text('\n                SELECT C...')
2025-12-08 15:16:14,146 - ERROR - [crypto_api.backend] User=None | Ошибка миграции базы данных: maximum recursion depth exceeded
Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 282, in get_db
    yield db
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 300, in migrate_database
    result = db.execute("""
             ~~~~~~~~~~^^^^
        SELECT COUNT(*)
        ^^^^^^^^^^^^^^^
    ...<3 lines>...
        AND column_name = 'host'
        ^^^^^^^^^^^^^^^^^^^^^^^^
    """).fetchone()
    ^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2147, in _execute_internal
    statement = coercions.expect(roles.StatementRole, statement)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 395, in expect
    resolved = impl._literal_coercion(
        element, argname=argname, **kw
    )
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 621, in _literal_coercion
    return self._text_coercion(element, argname, **kw)
           ~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 614, in _text_coercion
    return _no_text_coercion(element, argname)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 584, in _no_text_coercion
    raise exc_cls(
    ...<7 lines>...
    ) from err
sqlalchemy.exc.ArgumentError: Textual SQL expression '\n                SELECT C...' should be explicitly declared as text('\n                SELECT C...')

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 789, in _read_bytes
    data = self._rfile.read(num_bytes)
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\socket.py", line 715, in readinto
    self._checkReadable()
    ~~~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1301, in _checkout
    result = pool._dialect._do_ping_w_event(
        fairy.dbapi_connection
    )
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 728, in _do_ping_w_event
    return self.do_ping(dbapi_connection)
           ~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\dialects\mysql\pymysql.py", line 121, in do_ping
    dbapi_connection.ping(False)
    ~~~~~~~~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 607, in ping
    self._read_ok_packet()
    ~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 465, in _read_ok_packet
    pkt = self._read_packet()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 751, in _read_packet
    packet_header = self._read_bytes(4)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 801, in _read_bytes
    self._force_close()
    ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 444, in _force_close
    self._rfile.close()
    ~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 372, in _close_connection
    self._dialect.do_terminate(connection)
    ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 717, in do_terminate
    self.do_close(dbapi_connection)
    ~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 720, in do_close
    dbapi_connection.close()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 434, in close
    self._force_close()
    ~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 298, in migrate_database
    with get_db() as db:
         ~~~~~~^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 286, in get_db
    log_message(f"Ошибка БД: {e}", 'error')
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 214, in log_message
    db.commit()
    ~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2030, in commit
    trans.commit(_to_root=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "<string>", line 2, in commit
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1311, in commit
    self._prepare_impl()
    ~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 2, in _prepare_impl
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1286, in _prepare_impl
    self.session.flush()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4331, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4466, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4427, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 68, in save_obj
    ) in _organize_states_for_save(base_mapper, states, uowtransaction):
         ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 223, in _organize_states_for_save
    for state, dict_, mapper, connection in _connections_for_states(
                                            ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper, uowtransaction, states
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ):
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 1759, in _connections_for_states
    connection = uowtransaction.transaction.connection(base_mapper)
  File "<string>", line 2, in connection
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1037, in connection
    return self._connection_for_bind(bind, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1173, in _connection_for_bind
    conn = self._parent._connection_for_bind(
        bind, execution_options
    )
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1187, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3277, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 143, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3301, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 447, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1363, in _checkout
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 228, in __exit__
    raise value.with_traceback(traceback)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1366, in _checkout
    rec._checkin_failed(
    ~~~~~~~~~~~~~~~~~~~^
        be_outer,
        ^^^^^^^^^
        _fairy_was_created=True,
        ^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 745, in _checkin_failed
    self.invalidate(e=err)
    ~~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 815, in invalidate
    self.__close(terminate=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 882, in __close
    self.__pool._close_connection(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.dbapi_connection, terminate=terminate
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 376, in _close_connection
    self.logger.error(
    ~~~~~~~~~~~~~~~~~^
        f"Exception {'terminating' if terminate else 'closing'} "
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<2 lines>...
        exc_info=True,
        ^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\logging\__init__.py", line 1549, in error
    self._log(ERROR, msg, args, **kwargs)
    ~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\logging\__init__.py", line 1653, in _log
    fn, lno, func, sinfo = self.findCaller(stack_info, stacklevel)
                           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\logging\__init__.py", line 1597, in findCaller
    f = currentframe()
RecursionError: maximum recursion depth exceeded
2025-12-08 15:16:14,161 - ERROR - [crypto_api.backend] User=None | Ошибка миграции базы данных: maximum recursion depth exceeded
Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 282, in get_db
    yield db
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 300, in migrate_database
    result = db.execute("""
             ~~~~~~~~~~^^^^
        SELECT COUNT(*)
        ^^^^^^^^^^^^^^^
    ...<3 lines>...
        AND column_name = 'host'
        ^^^^^^^^^^^^^^^^^^^^^^^^
    """).fetchone()
    ^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2147, in _execute_internal
    statement = coercions.expect(roles.StatementRole, statement)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 395, in expect
    resolved = impl._literal_coercion(
        element, argname=argname, **kw
    )
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 621, in _literal_coercion
    return self._text_coercion(element, argname, **kw)
           ~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 614, in _text_coercion
    return _no_text_coercion(element, argname)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 584, in _no_text_coercion
    raise exc_cls(
    ...<7 lines>...
    ) from err
sqlalchemy.exc.ArgumentError: Textual SQL expression '\n                SELECT C...' should be explicitly declared as text('\n                SELECT C...')

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 789, in _read_bytes
    data = self._rfile.read(num_bytes)
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\socket.py", line 715, in readinto
    self._checkReadable()
    ~~~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1301, in _checkout
    result = pool._dialect._do_ping_w_event(
        fairy.dbapi_connection
    )
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 728, in _do_ping_w_event
    return self.do_ping(dbapi_connection)
           ~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\dialects\mysql\pymysql.py", line 121, in do_ping
    dbapi_connection.ping(False)
    ~~~~~~~~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 607, in ping
    self._read_ok_packet()
    ~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 465, in _read_ok_packet
    pkt = self._read_packet()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 751, in _read_packet
    packet_header = self._read_bytes(4)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 801, in _read_bytes
    self._force_close()
    ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 444, in _force_close
    self._rfile.close()
    ~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 372, in _close_connection
    self._dialect.do_terminate(connection)
    ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 717, in do_terminate
    self.do_close(dbapi_connection)
    ~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 720, in do_close
    dbapi_connection.close()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 434, in close
    self._force_close()
    ~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 298, in migrate_database
    with get_db() as db:
         ~~~~~~^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 286, in get_db
    log_message(f"Ошибка БД: {e}", 'error')
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 214, in log_message
    db.commit()
    ~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2030, in commit
    trans.commit(_to_root=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "<string>", line 2, in commit
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1311, in commit
    self._prepare_impl()
    ~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 2, in _prepare_impl
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1286, in _prepare_impl
    self.session.flush()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4331, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4466, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4427, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 68, in save_obj
    ) in _organize_states_for_save(base_mapper, states, uowtransaction):
         ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 223, in _organize_states_for_save
    for state, dict_, mapper, connection in _connections_for_states(
                                            ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper, uowtransaction, states
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ):
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 1759, in _connections_for_states
    connection = uowtransaction.transaction.connection(base_mapper)
  File "<string>", line 2, in connection
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1037, in connection
    return self._connection_for_bind(bind, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1173, in _connection_for_bind
    conn = self._parent._connection_for_bind(
        bind, execution_options
    )
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1187, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3277, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 143, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3301, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 447, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1363, in _checkout
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 228, in __exit__
    raise value.with_traceback(traceback)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1366, in _checkout
    rec._checkin_failed(
    ~~~~~~~~~~~~~~~~~~~^
        be_outer,
        ^^^^^^^^^
        _fairy_was_created=True,
        ^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 745, in _checkin_failed
    self.invalidate(e=err)
    ~~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 815, in invalidate
    self.__close(terminate=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 882, in __close
    self.__pool._close_connection(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.dbapi_connection, terminate=terminate
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 376, in _close_connection
    self.logger.error(
    ~~~~~~~~~~~~~~~~~^
        f"Exception {'terminating' if terminate else 'closing'} "
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<2 lines>...
        exc_info=True,
        ^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\logging\__init__.py", line 1549, in error
    self._log(ERROR, msg, args, **kwargs)
    ~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\logging\__init__.py", line 1653, in _log
    fn, lno, func, sinfo = self.findCaller(stack_info, stacklevel)
                           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\logging\__init__.py", line 1597, in findCaller
    f = currentframe()
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 661, in connect
    sock = socket.create_connection(
        (self.host, self.port), self.connect_timeout, **kwargs
    )
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 298, in migrate_database
    with get_db() as db:
         ~~~~~~^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 286, in get_db
    log_message(f"Ошибка БД: {e}", 'error')
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 219, in log_message
    migrate_database()
    ~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 337, in migrate_database
    log_message(f"Ошибка миграции базы данных: {e}", 'error', traceback=str(e))
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 214, in log_message
    db.commit()
    ~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2030, in commit
    trans.commit(_to_root=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "<string>", line 2, in commit
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1311, in commit
    self._prepare_impl()
    ~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 2, in _prepare_impl
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1286, in _prepare_impl
    self.session.flush()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4331, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4466, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4427, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 68, in save_obj
    ) in _organize_states_for_save(base_mapper, states, uowtransaction):
         ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 223, in _organize_states_for_save
    for state, dict_, mapper, connection in _connections_for_states(
                                            ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper, uowtransaction, states
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ):
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 1759, in _connections_for_states
    connection = uowtransaction.transaction.connection(base_mapper)
  File "<string>", line 2, in connection
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1037, in connection
    return self._connection_for_bind(bind, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1173, in _connection_for_bind
    conn = self._parent._connection_for_bind(
        bind, execution_options
    )
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1187, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3277, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 143, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3301, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 447, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1264, in _checkout
    fairy = _ConnectionRecord.checkout(pool)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 711, in checkout
    rec = pool._do_get()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 177, in _do_get
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 175, in _do_get
    return self._create_connection()
           ~~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 388, in _create_connection
    return _ConnectionRecord(self)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 673, in __init__
    self.__connect()
    ~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 899, in __connect
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 895, in __connect
    self.dbapi_connection = connection = pool._invoke_creator(self)
                                         ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\create.py", line 661, in connect
    return dialect.connect(*cargs, **cparams)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 629, in connect
    return self.loaded_dbapi.connect(*cargs, **cparams)  # type: ignore[no-any-return]  # NOQA: E501
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 365, in __init__
    self.connect()
    ~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 711, in connect
    self._force_close()
    ~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded
2025-12-08 15:16:14,179 - ERROR - [crypto_api.backend] User=None | Ошибка миграции базы данных: maximum recursion depth exceeded
Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 282, in get_db
    yield db
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 300, in migrate_database
    result = db.execute("""
             ~~~~~~~~~~^^^^
        SELECT COUNT(*)
        ^^^^^^^^^^^^^^^
    ...<3 lines>...
        AND column_name = 'host'
        ^^^^^^^^^^^^^^^^^^^^^^^^
    """).fetchone()
    ^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2147, in _execute_internal
    statement = coercions.expect(roles.StatementRole, statement)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 395, in expect
    resolved = impl._literal_coercion(
        element, argname=argname, **kw
    )
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 621, in _literal_coercion
    return self._text_coercion(element, argname, **kw)
           ~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 614, in _text_coercion
    return _no_text_coercion(element, argname)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 584, in _no_text_coercion
    raise exc_cls(
    ...<7 lines>...
    ) from err
sqlalchemy.exc.ArgumentError: Textual SQL expression '\n                SELECT C...' should be explicitly declared as text('\n                SELECT C...')

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 789, in _read_bytes
    data = self._rfile.read(num_bytes)
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\socket.py", line 715, in readinto
    self._checkReadable()
    ~~~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1301, in _checkout
    result = pool._dialect._do_ping_w_event(
        fairy.dbapi_connection
    )
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 728, in _do_ping_w_event
    return self.do_ping(dbapi_connection)
           ~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\dialects\mysql\pymysql.py", line 121, in do_ping
    dbapi_connection.ping(False)
    ~~~~~~~~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 607, in ping
    self._read_ok_packet()
    ~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 465, in _read_ok_packet
    pkt = self._read_packet()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 751, in _read_packet
    packet_header = self._read_bytes(4)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 801, in _read_bytes
    self._force_close()
    ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 444, in _force_close
    self._rfile.close()
    ~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 372, in _close_connection
    self._dialect.do_terminate(connection)
    ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 717, in do_terminate
    self.do_close(dbapi_connection)
    ~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 720, in do_close
    dbapi_connection.close()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 434, in close
    self._force_close()
    ~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 298, in migrate_database
    with get_db() as db:
         ~~~~~~^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 286, in get_db
    log_message(f"Ошибка БД: {e}", 'error')
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 214, in log_message
    db.commit()
    ~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2030, in commit
    trans.commit(_to_root=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "<string>", line 2, in commit
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1311, in commit
    self._prepare_impl()
    ~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 2, in _prepare_impl
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1286, in _prepare_impl
    self.session.flush()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4331, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4466, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4427, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 68, in save_obj
    ) in _organize_states_for_save(base_mapper, states, uowtransaction):
         ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 223, in _organize_states_for_save
    for state, dict_, mapper, connection in _connections_for_states(
                                            ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper, uowtransaction, states
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ):
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 1759, in _connections_for_states
    connection = uowtransaction.transaction.connection(base_mapper)
  File "<string>", line 2, in connection
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1037, in connection
    return self._connection_for_bind(bind, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1173, in _connection_for_bind
    conn = self._parent._connection_for_bind(
        bind, execution_options
    )
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1187, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3277, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 143, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3301, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 447, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1363, in _checkout
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 228, in __exit__
    raise value.with_traceback(traceback)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1366, in _checkout
    rec._checkin_failed(
    ~~~~~~~~~~~~~~~~~~~^
        be_outer,
        ^^^^^^^^^
        _fairy_was_created=True,
        ^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 745, in _checkin_failed
    self.invalidate(e=err)
    ~~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 815, in invalidate
    self.__close(terminate=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 882, in __close
    self.__pool._close_connection(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.dbapi_connection, terminate=terminate
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 376, in _close_connection
    self.logger.error(
    ~~~~~~~~~~~~~~~~~^
        f"Exception {'terminating' if terminate else 'closing'} "
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<2 lines>...
        exc_info=True,
        ^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\logging\__init__.py", line 1549, in error
    self._log(ERROR, msg, args, **kwargs)
    ~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\logging\__init__.py", line 1653, in _log
    fn, lno, func, sinfo = self.findCaller(stack_info, stacklevel)
                           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\logging\__init__.py", line 1597, in findCaller
    f = currentframe()
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 661, in connect
    sock = socket.create_connection(
        (self.host, self.port), self.connect_timeout, **kwargs
    )
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 298, in migrate_database
    with get_db() as db:
         ~~~~~~^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 286, in get_db
    log_message(f"Ошибка БД: {e}", 'error')
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 219, in log_message
    migrate_database()
    ~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 337, in migrate_database
    log_message(f"Ошибка миграции базы данных: {e}", 'error', traceback=str(e))
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 214, in log_message
    db.commit()
    ~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2030, in commit
    trans.commit(_to_root=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "<string>", line 2, in commit
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1311, in commit
    self._prepare_impl()
    ~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 2, in _prepare_impl
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1286, in _prepare_impl
    self.session.flush()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4331, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4466, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4427, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 68, in save_obj
    ) in _organize_states_for_save(base_mapper, states, uowtransaction):
         ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 223, in _organize_states_for_save
    for state, dict_, mapper, connection in _connections_for_states(
                                            ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper, uowtransaction, states
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ):
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 1759, in _connections_for_states
    connection = uowtransaction.transaction.connection(base_mapper)
  File "<string>", line 2, in connection
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1037, in connection
    return self._connection_for_bind(bind, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1173, in _connection_for_bind
    conn = self._parent._connection_for_bind(
        bind, execution_options
    )
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1187, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3277, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 143, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3301, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 447, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1264, in _checkout
    fairy = _ConnectionRecord.checkout(pool)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 711, in checkout
    rec = pool._do_get()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 177, in _do_get
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 175, in _do_get
    return self._create_connection()
           ~~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 388, in _create_connection
    return _ConnectionRecord(self)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 673, in __init__
    self.__connect()
    ~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 899, in __connect
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 895, in __connect
    self.dbapi_connection = connection = pool._invoke_creator(self)
                                         ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\create.py", line 661, in connect
    return dialect.connect(*cargs, **cparams)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 629, in connect
    return self.loaded_dbapi.connect(*cargs, **cparams)  # type: ignore[no-any-return]  # NOQA: E501
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 365, in __init__
    self.connect()
    ~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 711, in connect
    self._force_close()
    ~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 298, in migrate_database
    with get_db() as db:
         ~~~~~~^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 286, in get_db
    log_message(f"Ошибка БД: {e}", 'error')
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 219, in log_message
    migrate_database()
    ~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 337, in migrate_database
    log_message(f"Ошибка миграции базы данных: {e}", 'error', traceback=str(e))
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 214, in log_message
    db.commit()
    ~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2030, in commit
    trans.commit(_to_root=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "<string>", line 2, in commit
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1311, in commit
    self._prepare_impl()
    ~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 2, in _prepare_impl
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1286, in _prepare_impl
    self.session.flush()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4331, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4466, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4427, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 68, in save_obj
    ) in _organize_states_for_save(base_mapper, states, uowtransaction):
         ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 223, in _organize_states_for_save
    for state, dict_, mapper, connection in _connections_for_states(
                                            ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper, uowtransaction, states
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ):
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 1759, in _connections_for_states
    connection = uowtransaction.transaction.connection(base_mapper)
  File "<string>", line 2, in connection
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1037, in connection
    return self._connection_for_bind(bind, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1173, in _connection_for_bind
    conn = self._parent._connection_for_bind(
        bind, execution_options
    )
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1187, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3277, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 143, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3301, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 447, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1264, in _checkout
    fairy = _ConnectionRecord.checkout(pool)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 711, in checkout
    rec = pool._do_get()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 177, in _do_get
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 175, in _do_get
    return self._create_connection()
           ~~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 388, in _create_connection
    return _ConnectionRecord(self)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 673, in __init__
    self.__connect()
    ~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 899, in __connect
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 895, in __connect
    self.dbapi_connection = connection = pool._invoke_creator(self)
                                         ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\create.py", line 661, in connect
    return dialect.connect(*cargs, **cparams)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 629, in connect
    return self.loaded_dbapi.connect(*cargs, **cparams)  # type: ignore[no-any-return]  # NOQA: E501
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 365, in __init__
    self.connect()
    ~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 661, in connect
    sock = socket.create_connection(
        (self.host, self.port), self.connect_timeout, **kwargs
    )
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\socket.py", line 840, in create_connection
    for res in getaddrinfo(host, port, 0, SOCK_STREAM):
               ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\socket.py", line 979, in getaddrinfo
    addrlist.append((_intenum_converter(af, AddressFamily),
                     ~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\socket.py", line 106, in _intenum_converter
    return enum_klass(value)
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\enum.py", line 726, in __call__
    return cls.__new__(cls, value)
           ~~~~~~~~~~~^^^^^^^^^^^^
RecursionError: maximum recursion depth exceeded
2025-12-08 15:16:14,276 - ERROR - [crypto_api.backend] User=None | Ошибка миграции базы данных: maximum recursion depth exceeded
Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 282, in get_db
    yield db
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 300, in migrate_database
    result = db.execute("""
             ~~~~~~~~~~^^^^
        SELECT COUNT(*)
        ^^^^^^^^^^^^^^^
    ...<3 lines>...
        AND column_name = 'host'
        ^^^^^^^^^^^^^^^^^^^^^^^^
    """).fetchone()
    ^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2147, in _execute_internal
    statement = coercions.expect(roles.StatementRole, statement)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 395, in expect
    resolved = impl._literal_coercion(
        element, argname=argname, **kw
    )
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 621, in _literal_coercion
    return self._text_coercion(element, argname, **kw)
           ~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 614, in _text_coercion
    return _no_text_coercion(element, argname)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 584, in _no_text_coercion
    raise exc_cls(
    ...<7 lines>...
    ) from err
sqlalchemy.exc.ArgumentError: Textual SQL expression '\n                SELECT C...' should be explicitly declared as text('\n                SELECT C...')

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 789, in _read_bytes
    data = self._rfile.read(num_bytes)
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\socket.py", line 715, in readinto
    self._checkReadable()
    ~~~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1301, in _checkout
    result = pool._dialect._do_ping_w_event(
        fairy.dbapi_connection
    )
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 728, in _do_ping_w_event
    return self.do_ping(dbapi_connection)
           ~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\dialects\mysql\pymysql.py", line 121, in do_ping
    dbapi_connection.ping(False)
    ~~~~~~~~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 607, in ping
    self._read_ok_packet()
    ~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 465, in _read_ok_packet
    pkt = self._read_packet()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 751, in _read_packet
    packet_header = self._read_bytes(4)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 801, in _read_bytes
    self._force_close()
    ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 444, in _force_close
    self._rfile.close()
    ~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 372, in _close_connection
    self._dialect.do_terminate(connection)
    ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 717, in do_terminate
    self.do_close(dbapi_connection)
    ~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 720, in do_close
    dbapi_connection.close()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 434, in close
    self._force_close()
    ~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 298, in migrate_database
    with get_db() as db:
         ~~~~~~^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 286, in get_db
    log_message(f"Ошибка БД: {e}", 'error')
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 214, in log_message
    db.commit()
    ~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2030, in commit
    trans.commit(_to_root=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "<string>", line 2, in commit
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1311, in commit
    self._prepare_impl()
    ~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 2, in _prepare_impl
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1286, in _prepare_impl
    self.session.flush()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4331, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4466, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4427, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 68, in save_obj
    ) in _organize_states_for_save(base_mapper, states, uowtransaction):
         ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 223, in _organize_states_for_save
    for state, dict_, mapper, connection in _connections_for_states(
                                            ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper, uowtransaction, states
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ):
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 1759, in _connections_for_states
    connection = uowtransaction.transaction.connection(base_mapper)
  File "<string>", line 2, in connection
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1037, in connection
    return self._connection_for_bind(bind, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1173, in _connection_for_bind
    conn = self._parent._connection_for_bind(
        bind, execution_options
    )
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1187, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3277, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 143, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3301, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 447, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1363, in _checkout
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 228, in __exit__
    raise value.with_traceback(traceback)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1366, in _checkout
    rec._checkin_failed(
    ~~~~~~~~~~~~~~~~~~~^
        be_outer,
        ^^^^^^^^^
        _fairy_was_created=True,
        ^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 745, in _checkin_failed
    self.invalidate(e=err)
    ~~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 815, in invalidate
    self.__close(terminate=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 882, in __close
    self.__pool._close_connection(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.dbapi_connection, terminate=terminate
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 376, in _close_connection
    self.logger.error(
    ~~~~~~~~~~~~~~~~~^
        f"Exception {'terminating' if terminate else 'closing'} "
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<2 lines>...
        exc_info=True,
        ^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\logging\__init__.py", line 1549, in error
    self._log(ERROR, msg, args, **kwargs)
    ~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\logging\__init__.py", line 1653, in _log
    fn, lno, func, sinfo = self.findCaller(stack_info, stacklevel)
                           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\logging\__init__.py", line 1597, in findCaller
    f = currentframe()
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 661, in connect
    sock = socket.create_connection(
        (self.host, self.port), self.connect_timeout, **kwargs
    )
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 298, in migrate_database
    with get_db() as db:
         ~~~~~~^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 286, in get_db
    log_message(f"Ошибка БД: {e}", 'error')
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 219, in log_message
    migrate_database()
    ~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 337, in migrate_database
    log_message(f"Ошибка миграции базы данных: {e}", 'error', traceback=str(e))
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 214, in log_message
    db.commit()
    ~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2030, in commit
    trans.commit(_to_root=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "<string>", line 2, in commit
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1311, in commit
    self._prepare_impl()
    ~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 2, in _prepare_impl
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1286, in _prepare_impl
    self.session.flush()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4331, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4466, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4427, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 68, in save_obj
    ) in _organize_states_for_save(base_mapper, states, uowtransaction):
         ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 223, in _organize_states_for_save
    for state, dict_, mapper, connection in _connections_for_states(
                                            ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper, uowtransaction, states
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ):
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 1759, in _connections_for_states
    connection = uowtransaction.transaction.connection(base_mapper)
  File "<string>", line 2, in connection
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1037, in connection
    return self._connection_for_bind(bind, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1173, in _connection_for_bind
    conn = self._parent._connection_for_bind(
        bind, execution_options
    )
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1187, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3277, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 143, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3301, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 447, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1264, in _checkout
    fairy = _ConnectionRecord.checkout(pool)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 711, in checkout
    rec = pool._do_get()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 177, in _do_get
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 175, in _do_get
    return self._create_connection()
           ~~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 388, in _create_connection
    return _ConnectionRecord(self)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 673, in __init__
    self.__connect()
    ~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 899, in __connect
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 895, in __connect
    self.dbapi_connection = connection = pool._invoke_creator(self)
                                         ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\create.py", line 661, in connect
    return dialect.connect(*cargs, **cparams)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 629, in connect
    return self.loaded_dbapi.connect(*cargs, **cparams)  # type: ignore[no-any-return]  # NOQA: E501
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 365, in __init__
    self.connect()
    ~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 711, in connect
    self._force_close()
    ~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 298, in migrate_database
    with get_db() as db:
         ~~~~~~^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 286, in get_db
    log_message(f"Ошибка БД: {e}", 'error')
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 219, in log_message
    migrate_database()
    ~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 337, in migrate_database
    log_message(f"Ошибка миграции базы данных: {e}", 'error', traceback=str(e))
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 214, in log_message
    db.commit()
    ~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2030, in commit
    trans.commit(_to_root=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "<string>", line 2, in commit
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1311, in commit
    self._prepare_impl()
    ~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 2, in _prepare_impl
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1286, in _prepare_impl
    self.session.flush()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4331, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4466, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4427, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 68, in save_obj
    ) in _organize_states_for_save(base_mapper, states, uowtransaction):
         ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 223, in _organize_states_for_save
    for state, dict_, mapper, connection in _connections_for_states(
                                            ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper, uowtransaction, states
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ):
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 1759, in _connections_for_states
    connection = uowtransaction.transaction.connection(base_mapper)
  File "<string>", line 2, in connection
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1037, in connection
    return self._connection_for_bind(bind, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1173, in _connection_for_bind
    conn = self._parent._connection_for_bind(
        bind, execution_options
    )
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1187, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3277, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 143, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3301, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 447, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1264, in _checkout
    fairy = _ConnectionRecord.checkout(pool)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 711, in checkout
    rec = pool._do_get()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 177, in _do_get
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 175, in _do_get
    return self._create_connection()
           ~~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 388, in _create_connection
    return _ConnectionRecord(self)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 673, in __init__
    self.__connect()
    ~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 899, in __connect
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 895, in __connect
    self.dbapi_connection = connection = pool._invoke_creator(self)
                                         ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\create.py", line 661, in connect
    return dialect.connect(*cargs, **cparams)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 629, in connect
    return self.loaded_dbapi.connect(*cargs, **cparams)  # type: ignore[no-any-return]  # NOQA: E501
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 365, in __init__
    self.connect()
    ~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 661, in connect
    sock = socket.create_connection(
        (self.host, self.port), self.connect_timeout, **kwargs
    )
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\socket.py", line 840, in create_connection
    for res in getaddrinfo(host, port, 0, SOCK_STREAM):
               ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\socket.py", line 979, in getaddrinfo
    addrlist.append((_intenum_converter(af, AddressFamily),
                     ~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\socket.py", line 106, in _intenum_converter
    return enum_klass(value)
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\enum.py", line 726, in __call__
    return cls.__new__(cls, value)
           ~~~~~~~~~~~^^^^^^^^^^^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 789, in _read_bytes
    data = self._rfile.read(num_bytes)
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\socket.py", line 715, in readinto
    self._checkReadable()
    ~~~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 298, in migrate_database
    with get_db() as db:
         ~~~~~~^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 286, in get_db
    log_message(f"Ошибка БД: {e}", 'error')
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 219, in log_message
    migrate_database()
    ~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 337, in migrate_database
    log_message(f"Ошибка миграции базы данных: {e}", 'error', traceback=str(e))
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 214, in log_message
    db.commit()
    ~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2030, in commit
    trans.commit(_to_root=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "<string>", line 2, in commit
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1311, in commit
    self._prepare_impl()
    ~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 2, in _prepare_impl
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1286, in _prepare_impl
    self.session.flush()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4331, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4466, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4427, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 68, in save_obj
    ) in _organize_states_for_save(base_mapper, states, uowtransaction):
         ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 223, in _organize_states_for_save
    for state, dict_, mapper, connection in _connections_for_states(
                                            ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper, uowtransaction, states
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ):
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 1759, in _connections_for_states
    connection = uowtransaction.transaction.connection(base_mapper)
  File "<string>", line 2, in connection
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1037, in connection
    return self._connection_for_bind(bind, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1173, in _connection_for_bind
    conn = self._parent._connection_for_bind(
        bind, execution_options
    )
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1187, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3277, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 143, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3301, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 447, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1264, in _checkout
    fairy = _ConnectionRecord.checkout(pool)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 711, in checkout
    rec = pool._do_get()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 177, in _do_get
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 175, in _do_get
    return self._create_connection()
           ~~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 388, in _create_connection
    return _ConnectionRecord(self)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 673, in __init__
    self.__connect()
    ~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 913, in __connect
    )._exec_w_sync_on_first_run(self.dbapi_connection, self)
      ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\event\attr.py", line 507, in _exec_w_sync_on_first_run
    self(*args, **kw)
    ~~~~^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\event\attr.py", line 515, in __call__
    fn(*args, **kw)
    ~~^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\create.py", line 739, in on_connect
    do_on_connect(dbapi_connection)
    ~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\dialects\mysql\mysqldb.py", line 180, in on_connect
    cursor.execute("SET NAMES %s" % charset_name)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 575, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 826, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 1203, in read
    first_packet = self.connection._read_packet()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 751, in _read_packet
    packet_header = self._read_bytes(4)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 801, in _read_bytes
    self._force_close()
    ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 444, in _force_close
    self._rfile.close()
    ~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded
2025-12-08 15:16:14,436 - ERROR - [crypto_api.backend] User=None | Ошибка БД: Textual SQL expression '\n                SELECT C...' should be explicitly declared as text('\n                SELECT C...')
2025-12-08 15:16:14,494 - ERROR - [crypto_api.backend] User=None | Ошибка БД: Textual SQL expression '\n                SELECT C...' should be explicitly declared as text('\n                SELECT C...')
2025-12-08 15:16:14,552 - ERROR - [crypto_api.backend] User=None | Ошибка БД: Textual SQL expression '\n                SELECT C...' should be explicitly declared as text('\n                SELECT C...')
2025-12-08 15:16:14,610 - ERROR - [crypto_api.backend] User=None | Ошибка БД: Textual SQL expression '\n                SELECT C...' should be explicitly declared as text('\n                SELECT C...')
2025-12-08 15:16:14,612 - ERROR - [crypto_api.backend] User=None | Ошибка миграции базы данных: maximum recursion depth exceeded
Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 282, in get_db
    yield db
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 300, in migrate_database
    result = db.execute("""
             ~~~~~~~~~~^^^^
        SELECT COUNT(*)
        ^^^^^^^^^^^^^^^
    ...<3 lines>...
        AND column_name = 'host'
        ^^^^^^^^^^^^^^^^^^^^^^^^
    """).fetchone()
    ^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2147, in _execute_internal
    statement = coercions.expect(roles.StatementRole, statement)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 395, in expect
    resolved = impl._literal_coercion(
        element, argname=argname, **kw
    )
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 621, in _literal_coercion
    return self._text_coercion(element, argname, **kw)
           ~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 614, in _text_coercion
    return _no_text_coercion(element, argname)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 584, in _no_text_coercion
    raise exc_cls(
    ...<7 lines>...
    ) from err
sqlalchemy.exc.ArgumentError: Textual SQL expression '\n                SELECT C...' should be explicitly declared as text('\n                SELECT C...')

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1301, in _checkout
    result = pool._dialect._do_ping_w_event(
        fairy.dbapi_connection
    )
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 728, in _do_ping_w_event
    return self.do_ping(dbapi_connection)
           ~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\dialects\mysql\pymysql.py", line 121, in do_ping
    dbapi_connection.ping(False)
    ~~~~~~~~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 607, in ping
    self._read_ok_packet()
    ~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 465, in _read_ok_packet
    pkt = self._read_packet()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 751, in _read_packet
    packet_header = self._read_bytes(4)
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 298, in migrate_database
    with get_db() as db:
         ~~~~~~^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 286, in get_db
    log_message(f"Ошибка БД: {e}", 'error')
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 214, in log_message
    db.commit()
    ~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2030, in commit
    trans.commit(_to_root=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "<string>", line 2, in commit
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1311, in commit
    self._prepare_impl()
    ~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 2, in _prepare_impl
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1286, in _prepare_impl
    self.session.flush()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4331, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4466, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4427, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 68, in save_obj
    ) in _organize_states_for_save(base_mapper, states, uowtransaction):
         ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 223, in _organize_states_for_save
    for state, dict_, mapper, connection in _connections_for_states(
                                            ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper, uowtransaction, states
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ):
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 1759, in _connections_for_states
    connection = uowtransaction.transaction.connection(base_mapper)
  File "<string>", line 2, in connection
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1037, in connection
    return self._connection_for_bind(bind, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1173, in _connection_for_bind
    conn = self._parent._connection_for_bind(
        bind, execution_options
    )
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1187, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3277, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 143, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3301, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 447, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1363, in _checkout
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 228, in __exit__
    raise value.with_traceback(traceback)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1366, in _checkout
    rec._checkin_failed(
    ~~~~~~~~~~~~~~~~~~~^
        be_outer,
        ^^^^^^^^^
        _fairy_was_created=True,
        ^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 745, in _checkin_failed
    self.invalidate(e=err)
    ~~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 815, in invalidate
    self.__close(terminate=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 882, in __close
    self.__pool._close_connection(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.dbapi_connection, terminate=terminate
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 365, in _close_connection
    self.logger.debug(
    ~~~~~~~~~~~~~~~~~^
        "%s connection %r",
        ^^^^^^^^^^^^^^^^^^^
        "Hard-closing" if terminate else "Closing",
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        connection,
        ^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\logging\__init__.py", line 1507, in debug
    if self.isEnabledFor(DEBUG):
       ~~~~~~~~~~~~~~~~~^^^^^^^
RecursionError: maximum recursion depth exceeded
2025-12-08 15:16:14,626 - ERROR - [crypto_api.backend] User=None | Ошибка миграции базы данных: maximum recursion depth exceeded
Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 282, in get_db
    yield db
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 300, in migrate_database
    result = db.execute("""
             ~~~~~~~~~~^^^^
        SELECT COUNT(*)
        ^^^^^^^^^^^^^^^
    ...<3 lines>...
        AND column_name = 'host'
        ^^^^^^^^^^^^^^^^^^^^^^^^
    """).fetchone()
    ^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2147, in _execute_internal
    statement = coercions.expect(roles.StatementRole, statement)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 395, in expect
    resolved = impl._literal_coercion(
        element, argname=argname, **kw
    )
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 621, in _literal_coercion
    return self._text_coercion(element, argname, **kw)
           ~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 614, in _text_coercion
    return _no_text_coercion(element, argname)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 584, in _no_text_coercion
    raise exc_cls(
    ...<7 lines>...
    ) from err
sqlalchemy.exc.ArgumentError: Textual SQL expression '\n                SELECT C...' should be explicitly declared as text('\n                SELECT C...')

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1301, in _checkout
    result = pool._dialect._do_ping_w_event(
        fairy.dbapi_connection
    )
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 728, in _do_ping_w_event
    return self.do_ping(dbapi_connection)
           ~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\dialects\mysql\pymysql.py", line 121, in do_ping
    dbapi_connection.ping(False)
    ~~~~~~~~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 607, in ping
    self._read_ok_packet()
    ~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 465, in _read_ok_packet
    pkt = self._read_packet()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 751, in _read_packet
    packet_header = self._read_bytes(4)
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 298, in migrate_database
    with get_db() as db:
         ~~~~~~^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 286, in get_db
    log_message(f"Ошибка БД: {e}", 'error')
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 214, in log_message
    db.commit()
    ~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2030, in commit
    trans.commit(_to_root=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "<string>", line 2, in commit
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1311, in commit
    self._prepare_impl()
    ~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 2, in _prepare_impl
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1286, in _prepare_impl
    self.session.flush()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4331, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4466, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4427, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 68, in save_obj
    ) in _organize_states_for_save(base_mapper, states, uowtransaction):
         ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 223, in _organize_states_for_save
    for state, dict_, mapper, connection in _connections_for_states(
                                            ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper, uowtransaction, states
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ):
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 1759, in _connections_for_states
    connection = uowtransaction.transaction.connection(base_mapper)
  File "<string>", line 2, in connection
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1037, in connection
    return self._connection_for_bind(bind, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1173, in _connection_for_bind
    conn = self._parent._connection_for_bind(
        bind, execution_options
    )
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1187, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3277, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 143, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3301, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 447, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1363, in _checkout
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 228, in __exit__
    raise value.with_traceback(traceback)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1366, in _checkout
    rec._checkin_failed(
    ~~~~~~~~~~~~~~~~~~~^
        be_outer,
        ^^^^^^^^^
        _fairy_was_created=True,
        ^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 745, in _checkin_failed
    self.invalidate(e=err)
    ~~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 815, in invalidate
    self.__close(terminate=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 882, in __close
    self.__pool._close_connection(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.dbapi_connection, terminate=terminate
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 365, in _close_connection
    self.logger.debug(
    ~~~~~~~~~~~~~~~~~^
        "%s connection %r",
        ^^^^^^^^^^^^^^^^^^^
        "Hard-closing" if terminate else "Closing",
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        connection,
        ^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\logging\__init__.py", line 1507, in debug
    if self.isEnabledFor(DEBUG):
       ~~~~~~~~~~~~~~~~~^^^^^^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 298, in migrate_database
    with get_db() as db:
         ~~~~~~^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 286, in get_db
    log_message(f"Ошибка БД: {e}", 'error')
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 219, in log_message
    migrate_database()
    ~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 337, in migrate_database
    log_message(f"Ошибка миграции базы данных: {e}", 'error', traceback=str(e))
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 214, in log_message
    db.commit()
    ~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2030, in commit
    trans.commit(_to_root=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "<string>", line 2, in commit
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1311, in commit
    self._prepare_impl()
    ~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 2, in _prepare_impl
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1286, in _prepare_impl
    self.session.flush()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4331, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4466, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4427, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 68, in save_obj
    ) in _organize_states_for_save(base_mapper, states, uowtransaction):
         ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 223, in _organize_states_for_save
    for state, dict_, mapper, connection in _connections_for_states(
                                            ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper, uowtransaction, states
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ):
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 1759, in _connections_for_states
    connection = uowtransaction.transaction.connection(base_mapper)
  File "<string>", line 2, in connection
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1037, in connection
    return self._connection_for_bind(bind, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1173, in _connection_for_bind
    conn = self._parent._connection_for_bind(
        bind, execution_options
    )
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1187, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3277, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 143, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3301, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 447, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1264, in _checkout
    fairy = _ConnectionRecord.checkout(pool)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 711, in checkout
    rec = pool._do_get()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 177, in _do_get
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 175, in _do_get
    return self._create_connection()
           ~~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 388, in _create_connection
    return _ConnectionRecord(self)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 673, in __init__
    self.__connect()
    ~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 899, in __connect
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 895, in __connect
    self.dbapi_connection = connection = pool._invoke_creator(self)
                                         ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\create.py", line 661, in connect
    return dialect.connect(*cargs, **cparams)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 629, in connect
    return self.loaded_dbapi.connect(*cargs, **cparams)  # type: ignore[no-any-return]  # NOQA: E501
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
RecursionError: maximum recursion depth exceeded
2025-12-08 15:16:14,641 - ERROR - [crypto_api.backend] User=None | Ошибка миграции базы данных: maximum recursion depth exceeded
Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 282, in get_db
    yield db
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 300, in migrate_database
    result = db.execute("""
             ~~~~~~~~~~^^^^
        SELECT COUNT(*)
        ^^^^^^^^^^^^^^^
    ...<3 lines>...
        AND column_name = 'host'
        ^^^^^^^^^^^^^^^^^^^^^^^^
    """).fetchone()
    ^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2147, in _execute_internal
    statement = coercions.expect(roles.StatementRole, statement)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 395, in expect
    resolved = impl._literal_coercion(
        element, argname=argname, **kw
    )
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 621, in _literal_coercion
    return self._text_coercion(element, argname, **kw)
           ~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 614, in _text_coercion
    return _no_text_coercion(element, argname)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 584, in _no_text_coercion
    raise exc_cls(
    ...<7 lines>...
    ) from err
sqlalchemy.exc.ArgumentError: Textual SQL expression '\n                SELECT C...' should be explicitly declared as text('\n                SELECT C...')

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1301, in _checkout
    result = pool._dialect._do_ping_w_event(
        fairy.dbapi_connection
    )
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 728, in _do_ping_w_event
    return self.do_ping(dbapi_connection)
           ~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\dialects\mysql\pymysql.py", line 121, in do_ping
    dbapi_connection.ping(False)
    ~~~~~~~~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 607, in ping
    self._read_ok_packet()
    ~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 465, in _read_ok_packet
    pkt = self._read_packet()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 751, in _read_packet
    packet_header = self._read_bytes(4)
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 298, in migrate_database
    with get_db() as db:
         ~~~~~~^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 286, in get_db
    log_message(f"Ошибка БД: {e}", 'error')
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 214, in log_message
    db.commit()
    ~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2030, in commit
    trans.commit(_to_root=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "<string>", line 2, in commit
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1311, in commit
    self._prepare_impl()
    ~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 2, in _prepare_impl
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1286, in _prepare_impl
    self.session.flush()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4331, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4466, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4427, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 68, in save_obj
    ) in _organize_states_for_save(base_mapper, states, uowtransaction):
         ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 223, in _organize_states_for_save
    for state, dict_, mapper, connection in _connections_for_states(
                                            ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper, uowtransaction, states
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ):
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 1759, in _connections_for_states
    connection = uowtransaction.transaction.connection(base_mapper)
  File "<string>", line 2, in connection
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1037, in connection
    return self._connection_for_bind(bind, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1173, in _connection_for_bind
    conn = self._parent._connection_for_bind(
        bind, execution_options
    )
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1187, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3277, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 143, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3301, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 447, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1363, in _checkout
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 228, in __exit__
    raise value.with_traceback(traceback)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1366, in _checkout
    rec._checkin_failed(
    ~~~~~~~~~~~~~~~~~~~^
        be_outer,
        ^^^^^^^^^
        _fairy_was_created=True,
        ^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 745, in _checkin_failed
    self.invalidate(e=err)
    ~~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 815, in invalidate
    self.__close(terminate=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 882, in __close
    self.__pool._close_connection(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.dbapi_connection, terminate=terminate
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 365, in _close_connection
    self.logger.debug(
    ~~~~~~~~~~~~~~~~~^
        "%s connection %r",
        ^^^^^^^^^^^^^^^^^^^
        "Hard-closing" if terminate else "Closing",
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        connection,
        ^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\logging\__init__.py", line 1507, in debug
    if self.isEnabledFor(DEBUG):
       ~~~~~~~~~~~~~~~~~^^^^^^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 298, in migrate_database
    with get_db() as db:
         ~~~~~~^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 286, in get_db
    log_message(f"Ошибка БД: {e}", 'error')
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 219, in log_message
    migrate_database()
    ~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 337, in migrate_database
    log_message(f"Ошибка миграции базы данных: {e}", 'error', traceback=str(e))
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 214, in log_message
    db.commit()
    ~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2030, in commit
    trans.commit(_to_root=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "<string>", line 2, in commit
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1311, in commit
    self._prepare_impl()
    ~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 2, in _prepare_impl
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1286, in _prepare_impl
    self.session.flush()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4331, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4466, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4427, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 68, in save_obj
    ) in _organize_states_for_save(base_mapper, states, uowtransaction):
         ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 223, in _organize_states_for_save
    for state, dict_, mapper, connection in _connections_for_states(
                                            ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper, uowtransaction, states
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ):
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 1759, in _connections_for_states
    connection = uowtransaction.transaction.connection(base_mapper)
  File "<string>", line 2, in connection
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1037, in connection
    return self._connection_for_bind(bind, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1173, in _connection_for_bind
    conn = self._parent._connection_for_bind(
        bind, execution_options
    )
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1187, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3277, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 143, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3301, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 447, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1264, in _checkout
    fairy = _ConnectionRecord.checkout(pool)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 711, in checkout
    rec = pool._do_get()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 177, in _do_get
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 175, in _do_get
    return self._create_connection()
           ~~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 388, in _create_connection
    return _ConnectionRecord(self)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 673, in __init__
    self.__connect()
    ~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 899, in __connect
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 895, in __connect
    self.dbapi_connection = connection = pool._invoke_creator(self)
                                         ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\create.py", line 661, in connect
    return dialect.connect(*cargs, **cparams)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 629, in connect
    return self.loaded_dbapi.connect(*cargs, **cparams)  # type: ignore[no-any-return]  # NOQA: E501
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 298, in migrate_database
    with get_db() as db:
         ~~~~~~^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 286, in get_db
    log_message(f"Ошибка БД: {e}", 'error')
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 219, in log_message
    migrate_database()
    ~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 337, in migrate_database
    log_message(f"Ошибка миграции базы данных: {e}", 'error', traceback=str(e))
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 214, in log_message
    db.commit()
    ~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2030, in commit
    trans.commit(_to_root=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "<string>", line 2, in commit
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1311, in commit
    self._prepare_impl()
    ~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 2, in _prepare_impl
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1286, in _prepare_impl
    self.session.flush()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4331, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4466, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4427, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 68, in save_obj
    ) in _organize_states_for_save(base_mapper, states, uowtransaction):
         ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 223, in _organize_states_for_save
    for state, dict_, mapper, connection in _connections_for_states(
                                            ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper, uowtransaction, states
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ):
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 1759, in _connections_for_states
    connection = uowtransaction.transaction.connection(base_mapper)
  File "<string>", line 2, in connection
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1037, in connection
    return self._connection_for_bind(bind, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1173, in _connection_for_bind
    conn = self._parent._connection_for_bind(
        bind, execution_options
    )
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1187, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3277, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 143, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3301, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 447, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1264, in _checkout
    fairy = _ConnectionRecord.checkout(pool)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 711, in checkout
    rec = pool._do_get()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 177, in _do_get
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 175, in _do_get
    return self._create_connection()
           ~~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 388, in _create_connection
    return _ConnectionRecord(self)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 673, in __init__
    self.__connect()
    ~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 899, in __connect
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 895, in __connect
    self.dbapi_connection = connection = pool._invoke_creator(self)
                                         ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\create.py", line 661, in connect
    return dialect.connect(*cargs, **cparams)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 629, in connect
    return self.loaded_dbapi.connect(*cargs, **cparams)  # type: ignore[no-any-return]  # NOQA: E501
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 365, in __init__
    self.connect()
    ~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 661, in connect
    sock = socket.create_connection(
        (self.host, self.port), self.connect_timeout, **kwargs
    )
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\socket.py", line 840, in create_connection
    for res in getaddrinfo(host, port, 0, SOCK_STREAM):
               ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\socket.py", line 977, in getaddrinfo
    for res in _socket.getaddrinfo(host, port, family, type, proto, flags):
               ~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
RecursionError: maximum recursion depth exceeded
encoding with 'idna' codec failed
2025-12-08 15:16:14,726 - ERROR - [crypto_api.backend] User=None | Ошибка миграции базы данных: maximum recursion depth exceeded
Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 282, in get_db
    yield db
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 300, in migrate_database
    result = db.execute("""
             ~~~~~~~~~~^^^^
        SELECT COUNT(*)
        ^^^^^^^^^^^^^^^
    ...<3 lines>...
        AND column_name = 'host'
        ^^^^^^^^^^^^^^^^^^^^^^^^
    """).fetchone()
    ^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2147, in _execute_internal
    statement = coercions.expect(roles.StatementRole, statement)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 395, in expect
    resolved = impl._literal_coercion(
        element, argname=argname, **kw
    )
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 621, in _literal_coercion
    return self._text_coercion(element, argname, **kw)
           ~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 614, in _text_coercion
    return _no_text_coercion(element, argname)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 584, in _no_text_coercion
    raise exc_cls(
    ...<7 lines>...
    ) from err
sqlalchemy.exc.ArgumentError: Textual SQL expression '\n                SELECT C...' should be explicitly declared as text('\n                SELECT C...')

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1301, in _checkout
    result = pool._dialect._do_ping_w_event(
        fairy.dbapi_connection
    )
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 728, in _do_ping_w_event
    return self.do_ping(dbapi_connection)
           ~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\dialects\mysql\pymysql.py", line 121, in do_ping
    dbapi_connection.ping(False)
    ~~~~~~~~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 607, in ping
    self._read_ok_packet()
    ~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 465, in _read_ok_packet
    pkt = self._read_packet()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 751, in _read_packet
    packet_header = self._read_bytes(4)
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 298, in migrate_database
    with get_db() as db:
         ~~~~~~^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 286, in get_db
    log_message(f"Ошибка БД: {e}", 'error')
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 214, in log_message
    db.commit()
    ~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2030, in commit
    trans.commit(_to_root=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "<string>", line 2, in commit
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1311, in commit
    self._prepare_impl()
    ~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 2, in _prepare_impl
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1286, in _prepare_impl
    self.session.flush()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4331, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4466, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4427, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 68, in save_obj
    ) in _organize_states_for_save(base_mapper, states, uowtransaction):
         ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 223, in _organize_states_for_save
    for state, dict_, mapper, connection in _connections_for_states(
                                            ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper, uowtransaction, states
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ):
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 1759, in _connections_for_states
    connection = uowtransaction.transaction.connection(base_mapper)
  File "<string>", line 2, in connection
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1037, in connection
    return self._connection_for_bind(bind, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1173, in _connection_for_bind
    conn = self._parent._connection_for_bind(
        bind, execution_options
    )
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1187, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3277, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 143, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3301, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 447, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1363, in _checkout
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 228, in __exit__
    raise value.with_traceback(traceback)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1366, in _checkout
    rec._checkin_failed(
    ~~~~~~~~~~~~~~~~~~~^
        be_outer,
        ^^^^^^^^^
        _fairy_was_created=True,
        ^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 745, in _checkin_failed
    self.invalidate(e=err)
    ~~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 815, in invalidate
    self.__close(terminate=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 882, in __close
    self.__pool._close_connection(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.dbapi_connection, terminate=terminate
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 365, in _close_connection
    self.logger.debug(
    ~~~~~~~~~~~~~~~~~^
        "%s connection %r",
        ^^^^^^^^^^^^^^^^^^^
        "Hard-closing" if terminate else "Closing",
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        connection,
        ^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\logging\__init__.py", line 1507, in debug
    if self.isEnabledFor(DEBUG):
       ~~~~~~~~~~~~~~~~~^^^^^^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 298, in migrate_database
    with get_db() as db:
         ~~~~~~^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 286, in get_db
    log_message(f"Ошибка БД: {e}", 'error')
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 219, in log_message
    migrate_database()
    ~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 337, in migrate_database
    log_message(f"Ошибка миграции базы данных: {e}", 'error', traceback=str(e))
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 214, in log_message
    db.commit()
    ~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2030, in commit
    trans.commit(_to_root=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "<string>", line 2, in commit
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1311, in commit
    self._prepare_impl()
    ~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 2, in _prepare_impl
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1286, in _prepare_impl
    self.session.flush()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4331, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4466, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4427, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 68, in save_obj
    ) in _organize_states_for_save(base_mapper, states, uowtransaction):
         ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 223, in _organize_states_for_save
    for state, dict_, mapper, connection in _connections_for_states(
                                            ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper, uowtransaction, states
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ):
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 1759, in _connections_for_states
    connection = uowtransaction.transaction.connection(base_mapper)
  File "<string>", line 2, in connection
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1037, in connection
    return self._connection_for_bind(bind, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1173, in _connection_for_bind
    conn = self._parent._connection_for_bind(
        bind, execution_options
    )
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1187, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3277, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 143, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3301, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 447, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1264, in _checkout
    fairy = _ConnectionRecord.checkout(pool)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 711, in checkout
    rec = pool._do_get()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 177, in _do_get
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 175, in _do_get
    return self._create_connection()
           ~~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 388, in _create_connection
    return _ConnectionRecord(self)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 673, in __init__
    self.__connect()
    ~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 899, in __connect
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 895, in __connect
    self.dbapi_connection = connection = pool._invoke_creator(self)
                                         ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\create.py", line 661, in connect
    return dialect.connect(*cargs, **cparams)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 629, in connect
    return self.loaded_dbapi.connect(*cargs, **cparams)  # type: ignore[no-any-return]  # NOQA: E501
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 298, in migrate_database
    with get_db() as db:
         ~~~~~~^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 286, in get_db
    log_message(f"Ошибка БД: {e}", 'error')
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 219, in log_message
    migrate_database()
    ~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 337, in migrate_database
    log_message(f"Ошибка миграции базы данных: {e}", 'error', traceback=str(e))
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 214, in log_message
    db.commit()
    ~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2030, in commit
    trans.commit(_to_root=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "<string>", line 2, in commit
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1311, in commit
    self._prepare_impl()
    ~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 2, in _prepare_impl
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1286, in _prepare_impl
    self.session.flush()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4331, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4466, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4427, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 68, in save_obj
    ) in _organize_states_for_save(base_mapper, states, uowtransaction):
         ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 223, in _organize_states_for_save
    for state, dict_, mapper, connection in _connections_for_states(
                                            ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper, uowtransaction, states
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ):
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 1759, in _connections_for_states
    connection = uowtransaction.transaction.connection(base_mapper)
  File "<string>", line 2, in connection
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1037, in connection
    return self._connection_for_bind(bind, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1173, in _connection_for_bind
    conn = self._parent._connection_for_bind(
        bind, execution_options
    )
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1187, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3277, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 143, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3301, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 447, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1264, in _checkout
    fairy = _ConnectionRecord.checkout(pool)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 711, in checkout
    rec = pool._do_get()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 177, in _do_get
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 175, in _do_get
    return self._create_connection()
           ~~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 388, in _create_connection
    return _ConnectionRecord(self)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 673, in __init__
    self.__connect()
    ~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 899, in __connect
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 895, in __connect
    self.dbapi_connection = connection = pool._invoke_creator(self)
                                         ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\create.py", line 661, in connect
    return dialect.connect(*cargs, **cparams)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 629, in connect
    return self.loaded_dbapi.connect(*cargs, **cparams)  # type: ignore[no-any-return]  # NOQA: E501
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 365, in __init__
    self.connect()
    ~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 661, in connect
    sock = socket.create_connection(
        (self.host, self.port), self.connect_timeout, **kwargs
    )
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\socket.py", line 840, in create_connection
    for res in getaddrinfo(host, port, 0, SOCK_STREAM):
               ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\socket.py", line 977, in getaddrinfo
    for res in _socket.getaddrinfo(host, port, family, type, proto, flags):
               ~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
RecursionError: maximum recursion depth exceeded
encoding with 'idna' codec failed

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 789, in _read_bytes
    data = self._rfile.read(num_bytes)
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\socket.py", line 715, in readinto
    self._checkReadable()
    ~~~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 298, in migrate_database
    with get_db() as db:
         ~~~~~~^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 286, in get_db
    log_message(f"Ошибка БД: {e}", 'error')
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 219, in log_message
    migrate_database()
    ~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 337, in migrate_database
    log_message(f"Ошибка миграции базы данных: {e}", 'error', traceback=str(e))
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 214, in log_message
    db.commit()
    ~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2030, in commit
    trans.commit(_to_root=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "<string>", line 2, in commit
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1311, in commit
    self._prepare_impl()
    ~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 2, in _prepare_impl
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1286, in _prepare_impl
    self.session.flush()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4331, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4466, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4427, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 68, in save_obj
    ) in _organize_states_for_save(base_mapper, states, uowtransaction):
         ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 223, in _organize_states_for_save
    for state, dict_, mapper, connection in _connections_for_states(
                                            ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper, uowtransaction, states
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ):
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 1759, in _connections_for_states
    connection = uowtransaction.transaction.connection(base_mapper)
  File "<string>", line 2, in connection
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1037, in connection
    return self._connection_for_bind(bind, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1173, in _connection_for_bind
    conn = self._parent._connection_for_bind(
        bind, execution_options
    )
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1187, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3277, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 143, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3301, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 447, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1264, in _checkout
    fairy = _ConnectionRecord.checkout(pool)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 711, in checkout
    rec = pool._do_get()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 177, in _do_get
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 175, in _do_get
    return self._create_connection()
           ~~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 388, in _create_connection
    return _ConnectionRecord(self)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 673, in __init__
    self.__connect()
    ~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 899, in __connect
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 895, in __connect
    self.dbapi_connection = connection = pool._invoke_creator(self)
                                         ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\create.py", line 661, in connect
    return dialect.connect(*cargs, **cparams)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 629, in connect
    return self.loaded_dbapi.connect(*cargs, **cparams)  # type: ignore[no-any-return]  # NOQA: E501
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 365, in __init__
    self.connect()
    ~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 709, in connect
    self.autocommit(self.autocommit_mode)
    ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 459, in autocommit
    self._send_autocommit_mode()
    ~~~~~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 480, in _send_autocommit_mode
    self._read_ok_packet()
    ~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 465, in _read_ok_packet
    pkt = self._read_packet()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 751, in _read_packet
    packet_header = self._read_bytes(4)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 801, in _read_bytes
    self._force_close()
    ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 444, in _force_close
    self._rfile.close()
    ~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded
2025-12-08 15:16:14,888 - ERROR - [crypto_api.backend] User=None | Ошибка БД: Textual SQL expression '\n                SELECT C...' should be explicitly declared as text('\n                SELECT C...')
2025-12-08 15:16:14,944 - ERROR - [crypto_api.backend] User=None | Ошибка БД: Textual SQL expression '\n                SELECT C...' should be explicitly declared as text('\n                SELECT C...')
2025-12-08 15:16:14,999 - ERROR - [crypto_api.backend] User=None | Ошибка БД: Textual SQL expression '\n                SELECT C...' should be explicitly declared as text('\n                SELECT C...')
2025-12-08 15:16:15,000 - ERROR - [crypto_api.backend] User=None | Ошибка миграции базы данных: maximum recursion depth exceeded
Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 282, in get_db
    yield db
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 300, in migrate_database
    result = db.execute("""
             ~~~~~~~~~~^^^^
        SELECT COUNT(*)
        ^^^^^^^^^^^^^^^
    ...<3 lines>...
        AND column_name = 'host'
        ^^^^^^^^^^^^^^^^^^^^^^^^
    """).fetchone()
    ^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2147, in _execute_internal
    statement = coercions.expect(roles.StatementRole, statement)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 395, in expect
    resolved = impl._literal_coercion(
        element, argname=argname, **kw
    )
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 621, in _literal_coercion
    return self._text_coercion(element, argname, **kw)
           ~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 614, in _text_coercion
    return _no_text_coercion(element, argname)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 584, in _no_text_coercion
    raise exc_cls(
    ...<7 lines>...
    ) from err
sqlalchemy.exc.ArgumentError: Textual SQL expression '\n                SELECT C...' should be explicitly declared as text('\n                SELECT C...')

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 789, in _read_bytes
    data = self._rfile.read(num_bytes)
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\socket.py", line 715, in readinto
    self._checkReadable()
    ~~~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1301, in _checkout
    result = pool._dialect._do_ping_w_event(
        fairy.dbapi_connection
    )
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 728, in _do_ping_w_event
    return self.do_ping(dbapi_connection)
           ~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\dialects\mysql\pymysql.py", line 121, in do_ping
    dbapi_connection.ping(False)
    ~~~~~~~~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 607, in ping
    self._read_ok_packet()
    ~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 465, in _read_ok_packet
    pkt = self._read_packet()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 751, in _read_packet
    packet_header = self._read_bytes(4)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 801, in _read_bytes
    self._force_close()
    ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 444, in _force_close
    self._rfile.close()
    ~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 372, in _close_connection
    self._dialect.do_terminate(connection)
    ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 717, in do_terminate
    self.do_close(dbapi_connection)
    ~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 720, in do_close
    dbapi_connection.close()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 434, in close
    self._force_close()
    ~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 298, in migrate_database
    with get_db() as db:
         ~~~~~~^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 286, in get_db
    log_message(f"Ошибка БД: {e}", 'error')
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 214, in log_message
    db.commit()
    ~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2030, in commit
    trans.commit(_to_root=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "<string>", line 2, in commit
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1311, in commit
    self._prepare_impl()
    ~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 2, in _prepare_impl
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1286, in _prepare_impl
    self.session.flush()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4331, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4466, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4427, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 68, in save_obj
    ) in _organize_states_for_save(base_mapper, states, uowtransaction):
         ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 223, in _organize_states_for_save
    for state, dict_, mapper, connection in _connections_for_states(
                                            ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper, uowtransaction, states
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ):
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 1759, in _connections_for_states
    connection = uowtransaction.transaction.connection(base_mapper)
  File "<string>", line 2, in connection
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1037, in connection
    return self._connection_for_bind(bind, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1173, in _connection_for_bind
    conn = self._parent._connection_for_bind(
        bind, execution_options
    )
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1187, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3277, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 143, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3301, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 447, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1363, in _checkout
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 228, in __exit__
    raise value.with_traceback(traceback)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1366, in _checkout
    rec._checkin_failed(
    ~~~~~~~~~~~~~~~~~~~^
        be_outer,
        ^^^^^^^^^
        _fairy_was_created=True,
        ^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 745, in _checkin_failed
    self.invalidate(e=err)
    ~~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 815, in invalidate
    self.__close(terminate=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 882, in __close
    self.__pool._close_connection(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.dbapi_connection, terminate=terminate
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 376, in _close_connection
    self.logger.error(
    ~~~~~~~~~~~~~~~~~^
        f"Exception {'terminating' if terminate else 'closing'} "
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<2 lines>...
        exc_info=True,
        ^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\logging\__init__.py", line 1549, in error
    self._log(ERROR, msg, args, **kwargs)
    ~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\logging\__init__.py", line 1653, in _log
    fn, lno, func, sinfo = self.findCaller(stack_info, stacklevel)
                           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\logging\__init__.py", line 1597, in findCaller
    f = currentframe()
RecursionError: maximum recursion depth exceeded
2025-12-08 15:16:15,009 - ERROR - [crypto_api.backend] User=None | Ошибка миграции базы данных: maximum recursion depth exceeded
Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 282, in get_db
    yield db
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 300, in migrate_database
    result = db.execute("""
             ~~~~~~~~~~^^^^
        SELECT COUNT(*)
        ^^^^^^^^^^^^^^^
    ...<3 lines>...
        AND column_name = 'host'
        ^^^^^^^^^^^^^^^^^^^^^^^^
    """).fetchone()
    ^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2147, in _execute_internal
    statement = coercions.expect(roles.StatementRole, statement)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 395, in expect
    resolved = impl._literal_coercion(
        element, argname=argname, **kw
    )
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 621, in _literal_coercion
    return self._text_coercion(element, argname, **kw)
           ~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 614, in _text_coercion
    return _no_text_coercion(element, argname)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 584, in _no_text_coercion
    raise exc_cls(
    ...<7 lines>...
    ) from err
sqlalchemy.exc.ArgumentError: Textual SQL expression '\n                SELECT C...' should be explicitly declared as text('\n                SELECT C...')

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 789, in _read_bytes
    data = self._rfile.read(num_bytes)
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\socket.py", line 715, in readinto
    self._checkReadable()
    ~~~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1301, in _checkout
    result = pool._dialect._do_ping_w_event(
        fairy.dbapi_connection
    )
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 728, in _do_ping_w_event
    return self.do_ping(dbapi_connection)
           ~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\dialects\mysql\pymysql.py", line 121, in do_ping
    dbapi_connection.ping(False)
    ~~~~~~~~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 607, in ping
    self._read_ok_packet()
    ~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 465, in _read_ok_packet
    pkt = self._read_packet()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 751, in _read_packet
    packet_header = self._read_bytes(4)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 801, in _read_bytes
    self._force_close()
    ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 444, in _force_close
    self._rfile.close()
    ~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 372, in _close_connection
    self._dialect.do_terminate(connection)
    ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 717, in do_terminate
    self.do_close(dbapi_connection)
    ~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 720, in do_close
    dbapi_connection.close()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 434, in close
    self._force_close()
    ~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 298, in migrate_database
    with get_db() as db:
         ~~~~~~^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 286, in get_db
    log_message(f"Ошибка БД: {e}", 'error')
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 214, in log_message
    db.commit()
    ~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2030, in commit
    trans.commit(_to_root=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "<string>", line 2, in commit
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1311, in commit
    self._prepare_impl()
    ~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 2, in _prepare_impl
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1286, in _prepare_impl
    self.session.flush()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4331, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4466, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4427, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 68, in save_obj
    ) in _organize_states_for_save(base_mapper, states, uowtransaction):
         ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 223, in _organize_states_for_save
    for state, dict_, mapper, connection in _connections_for_states(
                                            ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper, uowtransaction, states
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ):
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 1759, in _connections_for_states
    connection = uowtransaction.transaction.connection(base_mapper)
  File "<string>", line 2, in connection
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1037, in connection
    return self._connection_for_bind(bind, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1173, in _connection_for_bind
    conn = self._parent._connection_for_bind(
        bind, execution_options
    )
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1187, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3277, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 143, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3301, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 447, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1363, in _checkout
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 228, in __exit__
    raise value.with_traceback(traceback)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1366, in _checkout
    rec._checkin_failed(
    ~~~~~~~~~~~~~~~~~~~^
        be_outer,
        ^^^^^^^^^
        _fairy_was_created=True,
        ^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 745, in _checkin_failed
    self.invalidate(e=err)
    ~~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 815, in invalidate
    self.__close(terminate=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 882, in __close
    self.__pool._close_connection(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.dbapi_connection, terminate=terminate
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 376, in _close_connection
    self.logger.error(
    ~~~~~~~~~~~~~~~~~^
        f"Exception {'terminating' if terminate else 'closing'} "
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<2 lines>...
        exc_info=True,
        ^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\logging\__init__.py", line 1549, in error
    self._log(ERROR, msg, args, **kwargs)
    ~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\logging\__init__.py", line 1653, in _log
    fn, lno, func, sinfo = self.findCaller(stack_info, stacklevel)
                           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\logging\__init__.py", line 1597, in findCaller
    f = currentframe()
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 661, in connect
    sock = socket.create_connection(
        (self.host, self.port), self.connect_timeout, **kwargs
    )
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 298, in migrate_database
    with get_db() as db:
         ~~~~~~^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 286, in get_db
    log_message(f"Ошибка БД: {e}", 'error')
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 219, in log_message
    migrate_database()
    ~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 337, in migrate_database
    log_message(f"Ошибка миграции базы данных: {e}", 'error', traceback=str(e))
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 214, in log_message
    db.commit()
    ~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2030, in commit
    trans.commit(_to_root=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "<string>", line 2, in commit
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1311, in commit
    self._prepare_impl()
    ~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 2, in _prepare_impl
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1286, in _prepare_impl
    self.session.flush()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4331, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4466, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4427, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 68, in save_obj
    ) in _organize_states_for_save(base_mapper, states, uowtransaction):
         ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 223, in _organize_states_for_save
    for state, dict_, mapper, connection in _connections_for_states(
                                            ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper, uowtransaction, states
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ):
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 1759, in _connections_for_states
    connection = uowtransaction.transaction.connection(base_mapper)
  File "<string>", line 2, in connection
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1037, in connection
    return self._connection_for_bind(bind, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1173, in _connection_for_bind
    conn = self._parent._connection_for_bind(
        bind, execution_options
    )
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1187, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3277, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 143, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3301, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 447, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1264, in _checkout
    fairy = _ConnectionRecord.checkout(pool)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 711, in checkout
    rec = pool._do_get()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 177, in _do_get
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 175, in _do_get
    return self._create_connection()
           ~~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 388, in _create_connection
    return _ConnectionRecord(self)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 673, in __init__
    self.__connect()
    ~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 899, in __connect
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 895, in __connect
    self.dbapi_connection = connection = pool._invoke_creator(self)
                                         ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\create.py", line 661, in connect
    return dialect.connect(*cargs, **cparams)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 629, in connect
    return self.loaded_dbapi.connect(*cargs, **cparams)  # type: ignore[no-any-return]  # NOQA: E501
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 365, in __init__
    self.connect()
    ~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 711, in connect
    self._force_close()
    ~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded
2025-12-08 15:16:15,027 - ERROR - [crypto_api.backend] User=None | Ошибка миграции базы данных: maximum recursion depth exceeded
Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 282, in get_db
    yield db
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 300, in migrate_database
    result = db.execute("""
             ~~~~~~~~~~^^^^
        SELECT COUNT(*)
        ^^^^^^^^^^^^^^^
    ...<3 lines>...
        AND column_name = 'host'
        ^^^^^^^^^^^^^^^^^^^^^^^^
    """).fetchone()
    ^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2147, in _execute_internal
    statement = coercions.expect(roles.StatementRole, statement)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 395, in expect
    resolved = impl._literal_coercion(
        element, argname=argname, **kw
    )
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 621, in _literal_coercion
    return self._text_coercion(element, argname, **kw)
           ~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 614, in _text_coercion
    return _no_text_coercion(element, argname)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 584, in _no_text_coercion
    raise exc_cls(
    ...<7 lines>...
    ) from err
sqlalchemy.exc.ArgumentError: Textual SQL expression '\n                SELECT C...' should be explicitly declared as text('\n                SELECT C...')

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 789, in _read_bytes
    data = self._rfile.read(num_bytes)
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\socket.py", line 715, in readinto
    self._checkReadable()
    ~~~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1301, in _checkout
    result = pool._dialect._do_ping_w_event(
        fairy.dbapi_connection
    )
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 728, in _do_ping_w_event
    return self.do_ping(dbapi_connection)
           ~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\dialects\mysql\pymysql.py", line 121, in do_ping
    dbapi_connection.ping(False)
    ~~~~~~~~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 607, in ping
    self._read_ok_packet()
    ~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 465, in _read_ok_packet
    pkt = self._read_packet()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 751, in _read_packet
    packet_header = self._read_bytes(4)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 801, in _read_bytes
    self._force_close()
    ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 444, in _force_close
    self._rfile.close()
    ~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 372, in _close_connection
    self._dialect.do_terminate(connection)
    ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 717, in do_terminate
    self.do_close(dbapi_connection)
    ~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 720, in do_close
    dbapi_connection.close()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 434, in close
    self._force_close()
    ~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 298, in migrate_database
    with get_db() as db:
         ~~~~~~^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 286, in get_db
    log_message(f"Ошибка БД: {e}", 'error')
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 214, in log_message
    db.commit()
    ~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2030, in commit
    trans.commit(_to_root=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "<string>", line 2, in commit
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1311, in commit
    self._prepare_impl()
    ~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 2, in _prepare_impl
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1286, in _prepare_impl
    self.session.flush()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4331, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4466, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4427, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 68, in save_obj
    ) in _organize_states_for_save(base_mapper, states, uowtransaction):
         ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 223, in _organize_states_for_save
    for state, dict_, mapper, connection in _connections_for_states(
                                            ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper, uowtransaction, states
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ):
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 1759, in _connections_for_states
    connection = uowtransaction.transaction.connection(base_mapper)
  File "<string>", line 2, in connection
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1037, in connection
    return self._connection_for_bind(bind, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1173, in _connection_for_bind
    conn = self._parent._connection_for_bind(
        bind, execution_options
    )
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1187, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3277, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 143, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3301, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 447, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1363, in _checkout
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 228, in __exit__
    raise value.with_traceback(traceback)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1366, in _checkout
    rec._checkin_failed(
    ~~~~~~~~~~~~~~~~~~~^
        be_outer,
        ^^^^^^^^^
        _fairy_was_created=True,
        ^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 745, in _checkin_failed
    self.invalidate(e=err)
    ~~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 815, in invalidate
    self.__close(terminate=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 882, in __close
    self.__pool._close_connection(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.dbapi_connection, terminate=terminate
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 376, in _close_connection
    self.logger.error(
    ~~~~~~~~~~~~~~~~~^
        f"Exception {'terminating' if terminate else 'closing'} "
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<2 lines>...
        exc_info=True,
        ^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\logging\__init__.py", line 1549, in error
    self._log(ERROR, msg, args, **kwargs)
    ~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\logging\__init__.py", line 1653, in _log
    fn, lno, func, sinfo = self.findCaller(stack_info, stacklevel)
                           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\logging\__init__.py", line 1597, in findCaller
    f = currentframe()
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 661, in connect
    sock = socket.create_connection(
        (self.host, self.port), self.connect_timeout, **kwargs
    )
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 298, in migrate_database
    with get_db() as db:
         ~~~~~~^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 286, in get_db
    log_message(f"Ошибка БД: {e}", 'error')
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 219, in log_message
    migrate_database()
    ~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 337, in migrate_database
    log_message(f"Ошибка миграции базы данных: {e}", 'error', traceback=str(e))
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 214, in log_message
    db.commit()
    ~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2030, in commit
    trans.commit(_to_root=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "<string>", line 2, in commit
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1311, in commit
    self._prepare_impl()
    ~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 2, in _prepare_impl
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1286, in _prepare_impl
    self.session.flush()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4331, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4466, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4427, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 68, in save_obj
    ) in _organize_states_for_save(base_mapper, states, uowtransaction):
         ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 223, in _organize_states_for_save
    for state, dict_, mapper, connection in _connections_for_states(
                                            ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper, uowtransaction, states
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ):
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 1759, in _connections_for_states
    connection = uowtransaction.transaction.connection(base_mapper)
  File "<string>", line 2, in connection
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1037, in connection
    return self._connection_for_bind(bind, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1173, in _connection_for_bind
    conn = self._parent._connection_for_bind(
        bind, execution_options
    )
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1187, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3277, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 143, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3301, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 447, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1264, in _checkout
    fairy = _ConnectionRecord.checkout(pool)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 711, in checkout
    rec = pool._do_get()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 177, in _do_get
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 175, in _do_get
    return self._create_connection()
           ~~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 388, in _create_connection
    return _ConnectionRecord(self)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 673, in __init__
    self.__connect()
    ~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 899, in __connect
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 895, in __connect
    self.dbapi_connection = connection = pool._invoke_creator(self)
                                         ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\create.py", line 661, in connect
    return dialect.connect(*cargs, **cparams)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 629, in connect
    return self.loaded_dbapi.connect(*cargs, **cparams)  # type: ignore[no-any-return]  # NOQA: E501
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 365, in __init__
    self.connect()
    ~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 711, in connect
    self._force_close()
    ~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 298, in migrate_database
    with get_db() as db:
         ~~~~~~^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 286, in get_db
    log_message(f"Ошибка БД: {e}", 'error')
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 219, in log_message
    migrate_database()
    ~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 337, in migrate_database
    log_message(f"Ошибка миграции базы данных: {e}", 'error', traceback=str(e))
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 214, in log_message
    db.commit()
    ~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2030, in commit
    trans.commit(_to_root=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "<string>", line 2, in commit
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1311, in commit
    self._prepare_impl()
    ~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 2, in _prepare_impl
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1286, in _prepare_impl
    self.session.flush()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4331, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4466, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4427, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 68, in save_obj
    ) in _organize_states_for_save(base_mapper, states, uowtransaction):
         ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 223, in _organize_states_for_save
    for state, dict_, mapper, connection in _connections_for_states(
                                            ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper, uowtransaction, states
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ):
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 1759, in _connections_for_states
    connection = uowtransaction.transaction.connection(base_mapper)
  File "<string>", line 2, in connection
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1037, in connection
    return self._connection_for_bind(bind, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1173, in _connection_for_bind
    conn = self._parent._connection_for_bind(
        bind, execution_options
    )
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1187, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3277, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 143, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3301, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 447, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1264, in _checkout
    fairy = _ConnectionRecord.checkout(pool)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 711, in checkout
    rec = pool._do_get()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 177, in _do_get
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 175, in _do_get
    return self._create_connection()
           ~~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 388, in _create_connection
    return _ConnectionRecord(self)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 673, in __init__
    self.__connect()
    ~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 899, in __connect
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 895, in __connect
    self.dbapi_connection = connection = pool._invoke_creator(self)
                                         ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\create.py", line 661, in connect
    return dialect.connect(*cargs, **cparams)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 629, in connect
    return self.loaded_dbapi.connect(*cargs, **cparams)  # type: ignore[no-any-return]  # NOQA: E501
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 365, in __init__
    self.connect()
    ~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 661, in connect
    sock = socket.create_connection(
        (self.host, self.port), self.connect_timeout, **kwargs
    )
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\socket.py", line 840, in create_connection
    for res in getaddrinfo(host, port, 0, SOCK_STREAM):
               ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\socket.py", line 979, in getaddrinfo
    addrlist.append((_intenum_converter(af, AddressFamily),
                     ~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\socket.py", line 106, in _intenum_converter
    return enum_klass(value)
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\enum.py", line 726, in __call__
    return cls.__new__(cls, value)
           ~~~~~~~~~~~^^^^^^^^^^^^
RecursionError: maximum recursion depth exceeded
2025-12-08 15:16:15,123 - ERROR - [crypto_api.backend] User=None | Ошибка миграции базы данных: maximum recursion depth exceeded
Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 282, in get_db
    yield db
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 300, in migrate_database
    result = db.execute("""
             ~~~~~~~~~~^^^^
        SELECT COUNT(*)
        ^^^^^^^^^^^^^^^
    ...<3 lines>...
        AND column_name = 'host'
        ^^^^^^^^^^^^^^^^^^^^^^^^
    """).fetchone()
    ^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2147, in _execute_internal
    statement = coercions.expect(roles.StatementRole, statement)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 395, in expect
    resolved = impl._literal_coercion(
        element, argname=argname, **kw
    )
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 621, in _literal_coercion
    return self._text_coercion(element, argname, **kw)
           ~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 614, in _text_coercion
    return _no_text_coercion(element, argname)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 584, in _no_text_coercion
    raise exc_cls(
    ...<7 lines>...
    ) from err
sqlalchemy.exc.ArgumentError: Textual SQL expression '\n                SELECT C...' should be explicitly declared as text('\n                SELECT C...')

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 789, in _read_bytes
    data = self._rfile.read(num_bytes)
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\socket.py", line 715, in readinto
    self._checkReadable()
    ~~~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1301, in _checkout
    result = pool._dialect._do_ping_w_event(
        fairy.dbapi_connection
    )
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 728, in _do_ping_w_event
    return self.do_ping(dbapi_connection)
           ~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\dialects\mysql\pymysql.py", line 121, in do_ping
    dbapi_connection.ping(False)
    ~~~~~~~~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 607, in ping
    self._read_ok_packet()
    ~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 465, in _read_ok_packet
    pkt = self._read_packet()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 751, in _read_packet
    packet_header = self._read_bytes(4)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 801, in _read_bytes
    self._force_close()
    ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 444, in _force_close
    self._rfile.close()
    ~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 372, in _close_connection
    self._dialect.do_terminate(connection)
    ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 717, in do_terminate
    self.do_close(dbapi_connection)
    ~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 720, in do_close
    dbapi_connection.close()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 434, in close
    self._force_close()
    ~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 298, in migrate_database
    with get_db() as db:
         ~~~~~~^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 286, in get_db
    log_message(f"Ошибка БД: {e}", 'error')
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 214, in log_message
    db.commit()
    ~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2030, in commit
    trans.commit(_to_root=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "<string>", line 2, in commit
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1311, in commit
    self._prepare_impl()
    ~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 2, in _prepare_impl
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1286, in _prepare_impl
    self.session.flush()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4331, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4466, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4427, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 68, in save_obj
    ) in _organize_states_for_save(base_mapper, states, uowtransaction):
         ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 223, in _organize_states_for_save
    for state, dict_, mapper, connection in _connections_for_states(
                                            ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper, uowtransaction, states
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ):
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 1759, in _connections_for_states
    connection = uowtransaction.transaction.connection(base_mapper)
  File "<string>", line 2, in connection
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1037, in connection
    return self._connection_for_bind(bind, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1173, in _connection_for_bind
    conn = self._parent._connection_for_bind(
        bind, execution_options
    )
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1187, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3277, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 143, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3301, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 447, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1363, in _checkout
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 228, in __exit__
    raise value.with_traceback(traceback)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1366, in _checkout
    rec._checkin_failed(
    ~~~~~~~~~~~~~~~~~~~^
        be_outer,
        ^^^^^^^^^
        _fairy_was_created=True,
        ^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 745, in _checkin_failed
    self.invalidate(e=err)
    ~~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 815, in invalidate
    self.__close(terminate=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 882, in __close
    self.__pool._close_connection(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.dbapi_connection, terminate=terminate
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 376, in _close_connection
    self.logger.error(
    ~~~~~~~~~~~~~~~~~^
        f"Exception {'terminating' if terminate else 'closing'} "
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<2 lines>...
        exc_info=True,
        ^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\logging\__init__.py", line 1549, in error
    self._log(ERROR, msg, args, **kwargs)
    ~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\logging\__init__.py", line 1653, in _log
    fn, lno, func, sinfo = self.findCaller(stack_info, stacklevel)
                           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\logging\__init__.py", line 1597, in findCaller
    f = currentframe()
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 661, in connect
    sock = socket.create_connection(
        (self.host, self.port), self.connect_timeout, **kwargs
    )
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 298, in migrate_database
    with get_db() as db:
         ~~~~~~^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 286, in get_db
    log_message(f"Ошибка БД: {e}", 'error')
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 219, in log_message
    migrate_database()
    ~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 337, in migrate_database
    log_message(f"Ошибка миграции базы данных: {e}", 'error', traceback=str(e))
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 214, in log_message
    db.commit()
    ~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2030, in commit
    trans.commit(_to_root=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "<string>", line 2, in commit
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1311, in commit
    self._prepare_impl()
    ~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 2, in _prepare_impl
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1286, in _prepare_impl
    self.session.flush()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4331, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4466, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4427, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 68, in save_obj
    ) in _organize_states_for_save(base_mapper, states, uowtransaction):
         ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 223, in _organize_states_for_save
    for state, dict_, mapper, connection in _connections_for_states(
                                            ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper, uowtransaction, states
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ):
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 1759, in _connections_for_states
    connection = uowtransaction.transaction.connection(base_mapper)
  File "<string>", line 2, in connection
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1037, in connection
    return self._connection_for_bind(bind, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1173, in _connection_for_bind
    conn = self._parent._connection_for_bind(
        bind, execution_options
    )
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1187, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3277, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 143, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3301, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 447, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1264, in _checkout
    fairy = _ConnectionRecord.checkout(pool)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 711, in checkout
    rec = pool._do_get()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 177, in _do_get
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 175, in _do_get
    return self._create_connection()
           ~~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 388, in _create_connection
    return _ConnectionRecord(self)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 673, in __init__
    self.__connect()
    ~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 899, in __connect
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 895, in __connect
    self.dbapi_connection = connection = pool._invoke_creator(self)
                                         ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\create.py", line 661, in connect
    return dialect.connect(*cargs, **cparams)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 629, in connect
    return self.loaded_dbapi.connect(*cargs, **cparams)  # type: ignore[no-any-return]  # NOQA: E501
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 365, in __init__
    self.connect()
    ~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 711, in connect
    self._force_close()
    ~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 298, in migrate_database
    with get_db() as db:
         ~~~~~~^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 286, in get_db
    log_message(f"Ошибка БД: {e}", 'error')
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 219, in log_message
    migrate_database()
    ~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 337, in migrate_database
    log_message(f"Ошибка миграции базы данных: {e}", 'error', traceback=str(e))
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 214, in log_message
    db.commit()
    ~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2030, in commit
    trans.commit(_to_root=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "<string>", line 2, in commit
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1311, in commit
    self._prepare_impl()
    ~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 2, in _prepare_impl
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1286, in _prepare_impl
    self.session.flush()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4331, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4466, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4427, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 68, in save_obj
    ) in _organize_states_for_save(base_mapper, states, uowtransaction):
         ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 223, in _organize_states_for_save
    for state, dict_, mapper, connection in _connections_for_states(
                                            ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper, uowtransaction, states
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ):
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 1759, in _connections_for_states
    connection = uowtransaction.transaction.connection(base_mapper)
  File "<string>", line 2, in connection
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1037, in connection
    return self._connection_for_bind(bind, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1173, in _connection_for_bind
    conn = self._parent._connection_for_bind(
        bind, execution_options
    )
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1187, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3277, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 143, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3301, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 447, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1264, in _checkout
    fairy = _ConnectionRecord.checkout(pool)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 711, in checkout
    rec = pool._do_get()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 177, in _do_get
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 175, in _do_get
    return self._create_connection()
           ~~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 388, in _create_connection
    return _ConnectionRecord(self)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 673, in __init__
    self.__connect()
    ~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 899, in __connect
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 895, in __connect
    self.dbapi_connection = connection = pool._invoke_creator(self)
                                         ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\create.py", line 661, in connect
    return dialect.connect(*cargs, **cparams)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 629, in connect
    return self.loaded_dbapi.connect(*cargs, **cparams)  # type: ignore[no-any-return]  # NOQA: E501
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 365, in __init__
    self.connect()
    ~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 661, in connect
    sock = socket.create_connection(
        (self.host, self.port), self.connect_timeout, **kwargs
    )
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\socket.py", line 840, in create_connection
    for res in getaddrinfo(host, port, 0, SOCK_STREAM):
               ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\socket.py", line 979, in getaddrinfo
    addrlist.append((_intenum_converter(af, AddressFamily),
                     ~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\socket.py", line 106, in _intenum_converter
    return enum_klass(value)
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\enum.py", line 726, in __call__
    return cls.__new__(cls, value)
           ~~~~~~~~~~~^^^^^^^^^^^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 789, in _read_bytes
    data = self._rfile.read(num_bytes)
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\socket.py", line 715, in readinto
    self._checkReadable()
    ~~~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 298, in migrate_database
    with get_db() as db:
         ~~~~~~^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 286, in get_db
    log_message(f"Ошибка БД: {e}", 'error')
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 219, in log_message
    migrate_database()
    ~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 337, in migrate_database
    log_message(f"Ошибка миграции базы данных: {e}", 'error', traceback=str(e))
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 219, in log_message
    migrate_database()
    ~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 337, in migrate_database
    log_message(f"Ошибка миграции базы данных: {e}", 'error', traceback=str(e))
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 219, in log_message
    migrate_database()
    ~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 337, in migrate_database
    log_message(f"Ошибка миграции базы данных: {e}", 'error', traceback=str(e))
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 214, in log_message
    db.commit()
    ~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2030, in commit
    trans.commit(_to_root=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "<string>", line 2, in commit
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1311, in commit
    self._prepare_impl()
    ~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 2, in _prepare_impl
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1286, in _prepare_impl
    self.session.flush()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4331, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4466, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4427, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 68, in save_obj
    ) in _organize_states_for_save(base_mapper, states, uowtransaction):
         ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 223, in _organize_states_for_save
    for state, dict_, mapper, connection in _connections_for_states(
                                            ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper, uowtransaction, states
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ):
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 1759, in _connections_for_states
    connection = uowtransaction.transaction.connection(base_mapper)
  File "<string>", line 2, in connection
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1037, in connection
    return self._connection_for_bind(bind, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1173, in _connection_for_bind
    conn = self._parent._connection_for_bind(
        bind, execution_options
    )
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1187, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3277, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 143, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3301, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 447, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1264, in _checkout
    fairy = _ConnectionRecord.checkout(pool)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 711, in checkout
    rec = pool._do_get()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 177, in _do_get
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 175, in _do_get
    return self._create_connection()
           ~~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 388, in _create_connection
    return _ConnectionRecord(self)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 673, in __init__
    self.__connect()
    ~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 913, in __connect
    )._exec_w_sync_on_first_run(self.dbapi_connection, self)
      ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\event\attr.py", line 507, in _exec_w_sync_on_first_run
    self(*args, **kw)
    ~~~~^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\event\attr.py", line 515, in __call__
    fn(*args, **kw)
    ~~^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\create.py", line 739, in on_connect
    do_on_connect(dbapi_connection)
    ~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\dialects\mysql\mysqldb.py", line 180, in on_connect
    cursor.execute("SET NAMES %s" % charset_name)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 575, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 826, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 1203, in read
    first_packet = self.connection._read_packet()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 751, in _read_packet
    packet_header = self._read_bytes(4)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 801, in _read_bytes
    self._force_close()
    ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 444, in _force_close
    self._rfile.close()
    ~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded
2025-12-08 15:16:15,283 - ERROR - [crypto_api.backend] User=None | Ошибка БД: Textual SQL expression '\n                SELECT C...' should be explicitly declared as text('\n                SELECT C...')
2025-12-08 15:16:15,341 - ERROR - [crypto_api.backend] User=None | Ошибка БД: Textual SQL expression '\n                SELECT C...' should be explicitly declared as text('\n                SELECT C...')
2025-12-08 15:16:15,397 - ERROR - [crypto_api.backend] User=None | Ошибка БД: Textual SQL expression '\n                SELECT C...' should be explicitly declared as text('\n                SELECT C...')
2025-12-08 15:16:15,455 - ERROR - [crypto_api.backend] User=None | Ошибка БД: Textual SQL expression '\n                SELECT C...' should be explicitly declared as text('\n                SELECT C...')
2025-12-08 15:16:15,512 - ERROR - [crypto_api.backend] User=None | Ошибка БД: Textual SQL expression '\n                SELECT C...' should be explicitly declared as text('\n                SELECT C...')
2025-12-08 15:16:15,514 - ERROR - [crypto_api.backend] User=None | Ошибка миграции базы данных: maximum recursion depth exceeded
Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 282, in get_db
    yield db
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 300, in migrate_database
    result = db.execute("""
             ~~~~~~~~~~^^^^
        SELECT COUNT(*)
        ^^^^^^^^^^^^^^^
    ...<3 lines>...
        AND column_name = 'host'
        ^^^^^^^^^^^^^^^^^^^^^^^^
    """).fetchone()
    ^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2147, in _execute_internal
    statement = coercions.expect(roles.StatementRole, statement)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 395, in expect
    resolved = impl._literal_coercion(
        element, argname=argname, **kw
    )
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 621, in _literal_coercion
    return self._text_coercion(element, argname, **kw)
           ~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 614, in _text_coercion
    return _no_text_coercion(element, argname)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 584, in _no_text_coercion
    raise exc_cls(
    ...<7 lines>...
    ) from err
sqlalchemy.exc.ArgumentError: Textual SQL expression '\n                SELECT C...' should be explicitly declared as text('\n                SELECT C...')

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1301, in _checkout
    result = pool._dialect._do_ping_w_event(
        fairy.dbapi_connection
    )
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 728, in _do_ping_w_event
    return self.do_ping(dbapi_connection)
           ~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\dialects\mysql\pymysql.py", line 121, in do_ping
    dbapi_connection.ping(False)
    ~~~~~~~~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 607, in ping
    self._read_ok_packet()
    ~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 465, in _read_ok_packet
    pkt = self._read_packet()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 751, in _read_packet
    packet_header = self._read_bytes(4)
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 298, in migrate_database
    with get_db() as db:
         ~~~~~~^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 286, in get_db
    log_message(f"Ошибка БД: {e}", 'error')
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 214, in log_message
    db.commit()
    ~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2030, in commit
    trans.commit(_to_root=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "<string>", line 2, in commit
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1311, in commit
    self._prepare_impl()
    ~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 2, in _prepare_impl
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1286, in _prepare_impl
    self.session.flush()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4331, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4466, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4427, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 68, in save_obj
    ) in _organize_states_for_save(base_mapper, states, uowtransaction):
         ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 223, in _organize_states_for_save
    for state, dict_, mapper, connection in _connections_for_states(
                                            ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper, uowtransaction, states
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ):
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 1759, in _connections_for_states
    connection = uowtransaction.transaction.connection(base_mapper)
  File "<string>", line 2, in connection
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1037, in connection
    return self._connection_for_bind(bind, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1173, in _connection_for_bind
    conn = self._parent._connection_for_bind(
        bind, execution_options
    )
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1187, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3277, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 143, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3301, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 447, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1363, in _checkout
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 228, in __exit__
    raise value.with_traceback(traceback)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1366, in _checkout
    rec._checkin_failed(
    ~~~~~~~~~~~~~~~~~~~^
        be_outer,
        ^^^^^^^^^
        _fairy_was_created=True,
        ^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 745, in _checkin_failed
    self.invalidate(e=err)
    ~~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 815, in invalidate
    self.__close(terminate=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 882, in __close
    self.__pool._close_connection(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.dbapi_connection, terminate=terminate
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 365, in _close_connection
    self.logger.debug(
    ~~~~~~~~~~~~~~~~~^
        "%s connection %r",
        ^^^^^^^^^^^^^^^^^^^
        "Hard-closing" if terminate else "Closing",
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        connection,
        ^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\logging\__init__.py", line 1507, in debug
    if self.isEnabledFor(DEBUG):
       ~~~~~~~~~~~~~~~~~^^^^^^^
RecursionError: maximum recursion depth exceeded
2025-12-08 15:16:15,527 - ERROR - [crypto_api.backend] User=None | Ошибка миграции базы данных: maximum recursion depth exceeded
Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 282, in get_db
    yield db
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 300, in migrate_database
    result = db.execute("""
             ~~~~~~~~~~^^^^
        SELECT COUNT(*)
        ^^^^^^^^^^^^^^^
    ...<3 lines>...
        AND column_name = 'host'
        ^^^^^^^^^^^^^^^^^^^^^^^^
    """).fetchone()
    ^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2147, in _execute_internal
    statement = coercions.expect(roles.StatementRole, statement)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 395, in expect
    resolved = impl._literal_coercion(
        element, argname=argname, **kw
    )
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 621, in _literal_coercion
    return self._text_coercion(element, argname, **kw)
           ~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 614, in _text_coercion
    return _no_text_coercion(element, argname)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 584, in _no_text_coercion
    raise exc_cls(
    ...<7 lines>...
    ) from err
sqlalchemy.exc.ArgumentError: Textual SQL expression '\n                SELECT C...' should be explicitly declared as text('\n                SELECT C...')

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1301, in _checkout
    result = pool._dialect._do_ping_w_event(
        fairy.dbapi_connection
    )
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 728, in _do_ping_w_event
    return self.do_ping(dbapi_connection)
           ~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\dialects\mysql\pymysql.py", line 121, in do_ping
    dbapi_connection.ping(False)
    ~~~~~~~~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 607, in ping
    self._read_ok_packet()
    ~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 465, in _read_ok_packet
    pkt = self._read_packet()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 751, in _read_packet
    packet_header = self._read_bytes(4)
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 298, in migrate_database
    with get_db() as db:
         ~~~~~~^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 286, in get_db
    log_message(f"Ошибка БД: {e}", 'error')
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 214, in log_message
    db.commit()
    ~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2030, in commit
    trans.commit(_to_root=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "<string>", line 2, in commit
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1311, in commit
    self._prepare_impl()
    ~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 2, in _prepare_impl
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1286, in _prepare_impl
    self.session.flush()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4331, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4466, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4427, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 68, in save_obj
    ) in _organize_states_for_save(base_mapper, states, uowtransaction):
         ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 223, in _organize_states_for_save
    for state, dict_, mapper, connection in _connections_for_states(
                                            ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper, uowtransaction, states
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ):
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 1759, in _connections_for_states
    connection = uowtransaction.transaction.connection(base_mapper)
  File "<string>", line 2, in connection
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1037, in connection
    return self._connection_for_bind(bind, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1173, in _connection_for_bind
    conn = self._parent._connection_for_bind(
        bind, execution_options
    )
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1187, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3277, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 143, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3301, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 447, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1363, in _checkout
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 228, in __exit__
    raise value.with_traceback(traceback)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1366, in _checkout
    rec._checkin_failed(
    ~~~~~~~~~~~~~~~~~~~^
        be_outer,
        ^^^^^^^^^
        _fairy_was_created=True,
        ^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 745, in _checkin_failed
    self.invalidate(e=err)
    ~~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 815, in invalidate
    self.__close(terminate=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 882, in __close
    self.__pool._close_connection(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.dbapi_connection, terminate=terminate
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 365, in _close_connection
    self.logger.debug(
    ~~~~~~~~~~~~~~~~~^
        "%s connection %r",
        ^^^^^^^^^^^^^^^^^^^
        "Hard-closing" if terminate else "Closing",
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        connection,
        ^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\logging\__init__.py", line 1507, in debug
    if self.isEnabledFor(DEBUG):
       ~~~~~~~~~~~~~~~~~^^^^^^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 298, in migrate_database
    with get_db() as db:
         ~~~~~~^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 286, in get_db
    log_message(f"Ошибка БД: {e}", 'error')
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 219, in log_message
    migrate_database()
    ~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 337, in migrate_database
    log_message(f"Ошибка миграции базы данных: {e}", 'error', traceback=str(e))
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 214, in log_message
    db.commit()
    ~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2030, in commit
    trans.commit(_to_root=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "<string>", line 2, in commit
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1311, in commit
    self._prepare_impl()
    ~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 2, in _prepare_impl
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1286, in _prepare_impl
    self.session.flush()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4331, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4466, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4427, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 68, in save_obj
    ) in _organize_states_for_save(base_mapper, states, uowtransaction):
         ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 223, in _organize_states_for_save
    for state, dict_, mapper, connection in _connections_for_states(
                                            ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper, uowtransaction, states
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ):
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 1759, in _connections_for_states
    connection = uowtransaction.transaction.connection(base_mapper)
  File "<string>", line 2, in connection
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1037, in connection
    return self._connection_for_bind(bind, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1173, in _connection_for_bind
    conn = self._parent._connection_for_bind(
        bind, execution_options
    )
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1187, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3277, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 143, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3301, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 447, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1264, in _checkout
    fairy = _ConnectionRecord.checkout(pool)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 711, in checkout
    rec = pool._do_get()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 177, in _do_get
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 175, in _do_get
    return self._create_connection()
           ~~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 388, in _create_connection
    return _ConnectionRecord(self)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 673, in __init__
    self.__connect()
    ~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 899, in __connect
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 895, in __connect
    self.dbapi_connection = connection = pool._invoke_creator(self)
                                         ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\create.py", line 661, in connect
    return dialect.connect(*cargs, **cparams)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 629, in connect
    return self.loaded_dbapi.connect(*cargs, **cparams)  # type: ignore[no-any-return]  # NOQA: E501
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
RecursionError: maximum recursion depth exceeded
2025-12-08 15:16:15,541 - ERROR - [crypto_api.backend] User=None | Ошибка миграции базы данных: maximum recursion depth exceeded
Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 282, in get_db
    yield db
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 300, in migrate_database
    result = db.execute("""
             ~~~~~~~~~~^^^^
        SELECT COUNT(*)
        ^^^^^^^^^^^^^^^
    ...<3 lines>...
        AND column_name = 'host'
        ^^^^^^^^^^^^^^^^^^^^^^^^
    """).fetchone()
    ^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2147, in _execute_internal
    statement = coercions.expect(roles.StatementRole, statement)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 395, in expect
    resolved = impl._literal_coercion(
        element, argname=argname, **kw
    )
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 621, in _literal_coercion
    return self._text_coercion(element, argname, **kw)
           ~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 614, in _text_coercion
    return _no_text_coercion(element, argname)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 584, in _no_text_coercion
    raise exc_cls(
    ...<7 lines>...
    ) from err
sqlalchemy.exc.ArgumentError: Textual SQL expression '\n                SELECT C...' should be explicitly declared as text('\n                SELECT C...')

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1301, in _checkout
    result = pool._dialect._do_ping_w_event(
        fairy.dbapi_connection
    )
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 728, in _do_ping_w_event
    return self.do_ping(dbapi_connection)
           ~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\dialects\mysql\pymysql.py", line 121, in do_ping
    dbapi_connection.ping(False)
    ~~~~~~~~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 607, in ping
    self._read_ok_packet()
    ~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 465, in _read_ok_packet
    pkt = self._read_packet()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 751, in _read_packet
    packet_header = self._read_bytes(4)
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 298, in migrate_database
    with get_db() as db:
         ~~~~~~^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 286, in get_db
    log_message(f"Ошибка БД: {e}", 'error')
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 214, in log_message
    db.commit()
    ~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2030, in commit
    trans.commit(_to_root=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "<string>", line 2, in commit
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1311, in commit
    self._prepare_impl()
    ~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 2, in _prepare_impl
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1286, in _prepare_impl
    self.session.flush()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4331, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4466, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4427, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 68, in save_obj
    ) in _organize_states_for_save(base_mapper, states, uowtransaction):
         ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 223, in _organize_states_for_save
    for state, dict_, mapper, connection in _connections_for_states(
                                            ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper, uowtransaction, states
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ):
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 1759, in _connections_for_states
    connection = uowtransaction.transaction.connection(base_mapper)
  File "<string>", line 2, in connection
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1037, in connection
    return self._connection_for_bind(bind, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1173, in _connection_for_bind
    conn = self._parent._connection_for_bind(
        bind, execution_options
    )
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1187, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3277, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 143, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3301, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 447, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1363, in _checkout
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 228, in __exit__
    raise value.with_traceback(traceback)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1366, in _checkout
    rec._checkin_failed(
    ~~~~~~~~~~~~~~~~~~~^
        be_outer,
        ^^^^^^^^^
        _fairy_was_created=True,
        ^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 745, in _checkin_failed
    self.invalidate(e=err)
    ~~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 815, in invalidate
    self.__close(terminate=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 882, in __close
    self.__pool._close_connection(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.dbapi_connection, terminate=terminate
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 365, in _close_connection
    self.logger.debug(
    ~~~~~~~~~~~~~~~~~^
        "%s connection %r",
        ^^^^^^^^^^^^^^^^^^^
        "Hard-closing" if terminate else "Closing",
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        connection,
        ^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\logging\__init__.py", line 1507, in debug
    if self.isEnabledFor(DEBUG):
       ~~~~~~~~~~~~~~~~~^^^^^^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 298, in migrate_database
    with get_db() as db:
         ~~~~~~^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 286, in get_db
    log_message(f"Ошибка БД: {e}", 'error')
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 219, in log_message
    migrate_database()
    ~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 337, in migrate_database
    log_message(f"Ошибка миграции базы данных: {e}", 'error', traceback=str(e))
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 214, in log_message
    db.commit()
    ~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2030, in commit
    trans.commit(_to_root=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "<string>", line 2, in commit
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1311, in commit
    self._prepare_impl()
    ~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 2, in _prepare_impl
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1286, in _prepare_impl
    self.session.flush()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4331, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4466, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4427, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 68, in save_obj
    ) in _organize_states_for_save(base_mapper, states, uowtransaction):
         ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 223, in _organize_states_for_save
    for state, dict_, mapper, connection in _connections_for_states(
                                            ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper, uowtransaction, states
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ):
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 1759, in _connections_for_states
    connection = uowtransaction.transaction.connection(base_mapper)
  File "<string>", line 2, in connection
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1037, in connection
    return self._connection_for_bind(bind, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1173, in _connection_for_bind
    conn = self._parent._connection_for_bind(
        bind, execution_options
    )
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1187, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3277, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 143, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3301, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 447, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1264, in _checkout
    fairy = _ConnectionRecord.checkout(pool)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 711, in checkout
    rec = pool._do_get()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 177, in _do_get
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 175, in _do_get
    return self._create_connection()
           ~~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 388, in _create_connection
    return _ConnectionRecord(self)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 673, in __init__
    self.__connect()
    ~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 899, in __connect
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 895, in __connect
    self.dbapi_connection = connection = pool._invoke_creator(self)
                                         ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\create.py", line 661, in connect
    return dialect.connect(*cargs, **cparams)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 629, in connect
    return self.loaded_dbapi.connect(*cargs, **cparams)  # type: ignore[no-any-return]  # NOQA: E501
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 298, in migrate_database
    with get_db() as db:
         ~~~~~~^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 286, in get_db
    log_message(f"Ошибка БД: {e}", 'error')
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 219, in log_message
    migrate_database()
    ~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 337, in migrate_database
    log_message(f"Ошибка миграции базы данных: {e}", 'error', traceback=str(e))
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 214, in log_message
    db.commit()
    ~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2030, in commit
    trans.commit(_to_root=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "<string>", line 2, in commit
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1311, in commit
    self._prepare_impl()
    ~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 2, in _prepare_impl
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1286, in _prepare_impl
    self.session.flush()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4331, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4466, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4427, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 68, in save_obj
    ) in _organize_states_for_save(base_mapper, states, uowtransaction):
         ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 223, in _organize_states_for_save
    for state, dict_, mapper, connection in _connections_for_states(
                                            ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper, uowtransaction, states
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ):
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 1759, in _connections_for_states
    connection = uowtransaction.transaction.connection(base_mapper)
  File "<string>", line 2, in connection
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1037, in connection
    return self._connection_for_bind(bind, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1173, in _connection_for_bind
    conn = self._parent._connection_for_bind(
        bind, execution_options
    )
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1187, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3277, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 143, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3301, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 447, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1264, in _checkout
    fairy = _ConnectionRecord.checkout(pool)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 711, in checkout
    rec = pool._do_get()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 177, in _do_get
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 175, in _do_get
    return self._create_connection()
           ~~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 388, in _create_connection
    return _ConnectionRecord(self)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 673, in __init__
    self.__connect()
    ~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 899, in __connect
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 895, in __connect
    self.dbapi_connection = connection = pool._invoke_creator(self)
                                         ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\create.py", line 661, in connect
    return dialect.connect(*cargs, **cparams)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 629, in connect
    return self.loaded_dbapi.connect(*cargs, **cparams)  # type: ignore[no-any-return]  # NOQA: E501
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 365, in __init__
    self.connect()
    ~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 661, in connect
    sock = socket.create_connection(
        (self.host, self.port), self.connect_timeout, **kwargs
    )
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\socket.py", line 840, in create_connection
    for res in getaddrinfo(host, port, 0, SOCK_STREAM):
               ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\socket.py", line 977, in getaddrinfo
    for res in _socket.getaddrinfo(host, port, family, type, proto, flags):
               ~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
RecursionError: maximum recursion depth exceeded
encoding with 'idna' codec failed
2025-12-08 15:16:15,623 - ERROR - [crypto_api.backend] User=None | Ошибка миграции базы данных: maximum recursion depth exceeded
Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 282, in get_db
    yield db
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 300, in migrate_database
    result = db.execute("""
             ~~~~~~~~~~^^^^
        SELECT COUNT(*)
        ^^^^^^^^^^^^^^^
    ...<3 lines>...
        AND column_name = 'host'
        ^^^^^^^^^^^^^^^^^^^^^^^^
    """).fetchone()
    ^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2147, in _execute_internal
    statement = coercions.expect(roles.StatementRole, statement)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 395, in expect
    resolved = impl._literal_coercion(
        element, argname=argname, **kw
    )
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 621, in _literal_coercion
    return self._text_coercion(element, argname, **kw)
           ~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 614, in _text_coercion
    return _no_text_coercion(element, argname)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 584, in _no_text_coercion
    raise exc_cls(
    ...<7 lines>...
    ) from err
sqlalchemy.exc.ArgumentError: Textual SQL expression '\n                SELECT C...' should be explicitly declared as text('\n                SELECT C...')

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1301, in _checkout
    result = pool._dialect._do_ping_w_event(
        fairy.dbapi_connection
    )
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 728, in _do_ping_w_event
    return self.do_ping(dbapi_connection)
           ~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\dialects\mysql\pymysql.py", line 121, in do_ping
    dbapi_connection.ping(False)
    ~~~~~~~~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 607, in ping
    self._read_ok_packet()
    ~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 465, in _read_ok_packet
    pkt = self._read_packet()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 751, in _read_packet
    packet_header = self._read_bytes(4)
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 298, in migrate_database
    with get_db() as db:
         ~~~~~~^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 286, in get_db
    log_message(f"Ошибка БД: {e}", 'error')
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 214, in log_message
    db.commit()
    ~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2030, in commit
    trans.commit(_to_root=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "<string>", line 2, in commit
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1311, in commit
    self._prepare_impl()
    ~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 2, in _prepare_impl
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1286, in _prepare_impl
    self.session.flush()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4331, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4466, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4427, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 68, in save_obj
    ) in _organize_states_for_save(base_mapper, states, uowtransaction):
         ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 223, in _organize_states_for_save
    for state, dict_, mapper, connection in _connections_for_states(
                                            ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper, uowtransaction, states
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ):
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 1759, in _connections_for_states
    connection = uowtransaction.transaction.connection(base_mapper)
  File "<string>", line 2, in connection
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1037, in connection
    return self._connection_for_bind(bind, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1173, in _connection_for_bind
    conn = self._parent._connection_for_bind(
        bind, execution_options
    )
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1187, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3277, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 143, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3301, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 447, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1363, in _checkout
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 228, in __exit__
    raise value.with_traceback(traceback)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1366, in _checkout
    rec._checkin_failed(
    ~~~~~~~~~~~~~~~~~~~^
        be_outer,
        ^^^^^^^^^
        _fairy_was_created=True,
        ^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 745, in _checkin_failed
    self.invalidate(e=err)
    ~~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 815, in invalidate
    self.__close(terminate=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 882, in __close
    self.__pool._close_connection(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.dbapi_connection, terminate=terminate
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 365, in _close_connection
    self.logger.debug(
    ~~~~~~~~~~~~~~~~~^
        "%s connection %r",
        ^^^^^^^^^^^^^^^^^^^
        "Hard-closing" if terminate else "Closing",
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        connection,
        ^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\logging\__init__.py", line 1507, in debug
    if self.isEnabledFor(DEBUG):
       ~~~~~~~~~~~~~~~~~^^^^^^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 298, in migrate_database
    with get_db() as db:
         ~~~~~~^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 286, in get_db
    log_message(f"Ошибка БД: {e}", 'error')
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 219, in log_message
    migrate_database()
    ~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 337, in migrate_database
    log_message(f"Ошибка миграции базы данных: {e}", 'error', traceback=str(e))
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 214, in log_message
    db.commit()
    ~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2030, in commit
    trans.commit(_to_root=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "<string>", line 2, in commit
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1311, in commit
    self._prepare_impl()
    ~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 2, in _prepare_impl
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1286, in _prepare_impl
    self.session.flush()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4331, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4466, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4427, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 68, in save_obj
    ) in _organize_states_for_save(base_mapper, states, uowtransaction):
         ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 223, in _organize_states_for_save
    for state, dict_, mapper, connection in _connections_for_states(
                                            ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper, uowtransaction, states
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ):
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 1759, in _connections_for_states
    connection = uowtransaction.transaction.connection(base_mapper)
  File "<string>", line 2, in connection
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1037, in connection
    return self._connection_for_bind(bind, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1173, in _connection_for_bind
    conn = self._parent._connection_for_bind(
        bind, execution_options
    )
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1187, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3277, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 143, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3301, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 447, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1264, in _checkout
    fairy = _ConnectionRecord.checkout(pool)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 711, in checkout
    rec = pool._do_get()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 177, in _do_get
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 175, in _do_get
    return self._create_connection()
           ~~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 388, in _create_connection
    return _ConnectionRecord(self)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 673, in __init__
    self.__connect()
    ~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 899, in __connect
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 895, in __connect
    self.dbapi_connection = connection = pool._invoke_creator(self)
                                         ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\create.py", line 661, in connect
    return dialect.connect(*cargs, **cparams)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 629, in connect
    return self.loaded_dbapi.connect(*cargs, **cparams)  # type: ignore[no-any-return]  # NOQA: E501
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 298, in migrate_database
    with get_db() as db:
         ~~~~~~^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 286, in get_db
    log_message(f"Ошибка БД: {e}", 'error')
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 219, in log_message
    migrate_database()
    ~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 337, in migrate_database
    log_message(f"Ошибка миграции базы данных: {e}", 'error', traceback=str(e))
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 214, in log_message
    db.commit()
    ~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2030, in commit
    trans.commit(_to_root=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "<string>", line 2, in commit
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1311, in commit
    self._prepare_impl()
    ~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 2, in _prepare_impl
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1286, in _prepare_impl
    self.session.flush()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4331, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4466, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4427, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 68, in save_obj
    ) in _organize_states_for_save(base_mapper, states, uowtransaction):
         ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 223, in _organize_states_for_save
    for state, dict_, mapper, connection in _connections_for_states(
                                            ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper, uowtransaction, states
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ):
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 1759, in _connections_for_states
    connection = uowtransaction.transaction.connection(base_mapper)
  File "<string>", line 2, in connection
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1037, in connection
    return self._connection_for_bind(bind, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1173, in _connection_for_bind
    conn = self._parent._connection_for_bind(
        bind, execution_options
    )
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1187, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3277, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 143, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3301, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 447, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1264, in _checkout
    fairy = _ConnectionRecord.checkout(pool)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 711, in checkout
    rec = pool._do_get()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 177, in _do_get
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 175, in _do_get
    return self._create_connection()
           ~~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 388, in _create_connection
    return _ConnectionRecord(self)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 673, in __init__
    self.__connect()
    ~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 899, in __connect
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 895, in __connect
    self.dbapi_connection = connection = pool._invoke_creator(self)
                                         ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\create.py", line 661, in connect
    return dialect.connect(*cargs, **cparams)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 629, in connect
    return self.loaded_dbapi.connect(*cargs, **cparams)  # type: ignore[no-any-return]  # NOQA: E501
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 365, in __init__
    self.connect()
    ~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 661, in connect
    sock = socket.create_connection(
        (self.host, self.port), self.connect_timeout, **kwargs
    )
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\socket.py", line 840, in create_connection
    for res in getaddrinfo(host, port, 0, SOCK_STREAM):
               ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\socket.py", line 977, in getaddrinfo
    for res in _socket.getaddrinfo(host, port, family, type, proto, flags):
               ~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
RecursionError: maximum recursion depth exceeded
encoding with 'idna' codec failed

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 789, in _read_bytes
    data = self._rfile.read(num_bytes)
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\socket.py", line 715, in readinto
    self._checkReadable()
    ~~~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 298, in migrate_database
    with get_db() as db:
         ~~~~~~^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 286, in get_db
    log_message(f"Ошибка БД: {e}", 'error')
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 219, in log_message
    migrate_database()
    ~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 337, in migrate_database
    log_message(f"Ошибка миграции базы данных: {e}", 'error', traceback=str(e))
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 214, in log_message
    db.commit()
    ~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2030, in commit
    trans.commit(_to_root=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "<string>", line 2, in commit
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1311, in commit
    self._prepare_impl()
    ~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 2, in _prepare_impl
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1286, in _prepare_impl
    self.session.flush()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4331, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4466, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4427, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 68, in save_obj
    ) in _organize_states_for_save(base_mapper, states, uowtransaction):
         ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 223, in _organize_states_for_save
    for state, dict_, mapper, connection in _connections_for_states(
                                            ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper, uowtransaction, states
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ):
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 1759, in _connections_for_states
    connection = uowtransaction.transaction.connection(base_mapper)
  File "<string>", line 2, in connection
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1037, in connection
    return self._connection_for_bind(bind, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1173, in _connection_for_bind
    conn = self._parent._connection_for_bind(
        bind, execution_options
    )
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1187, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3277, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 143, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3301, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 447, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1264, in _checkout
    fairy = _ConnectionRecord.checkout(pool)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 711, in checkout
    rec = pool._do_get()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 177, in _do_get
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 175, in _do_get
    return self._create_connection()
           ~~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 388, in _create_connection
    return _ConnectionRecord(self)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 673, in __init__
    self.__connect()
    ~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 899, in __connect
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 895, in __connect
    self.dbapi_connection = connection = pool._invoke_creator(self)
                                         ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\create.py", line 661, in connect
    return dialect.connect(*cargs, **cparams)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 629, in connect
    return self.loaded_dbapi.connect(*cargs, **cparams)  # type: ignore[no-any-return]  # NOQA: E501
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 365, in __init__
    self.connect()
    ~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 709, in connect
    self.autocommit(self.autocommit_mode)
    ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 459, in autocommit
    self._send_autocommit_mode()
    ~~~~~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 480, in _send_autocommit_mode
    self._read_ok_packet()
    ~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 465, in _read_ok_packet
    pkt = self._read_packet()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 751, in _read_packet
    packet_header = self._read_bytes(4)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 801, in _read_bytes
    self._force_close()
    ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 444, in _force_close
    self._rfile.close()
    ~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded
2025-12-08 15:16:15,781 - ERROR - [crypto_api.backend] User=None | Ошибка БД: Textual SQL expression '\n                SELECT C...' should be explicitly declared as text('\n                SELECT C...')
2025-12-08 15:16:15,835 - ERROR - [crypto_api.backend] User=None | Ошибка БД: Textual SQL expression '\n                SELECT C...' should be explicitly declared as text('\n                SELECT C...')
2025-12-08 15:16:15,889 - ERROR - [crypto_api.backend] User=None | Ошибка БД: Textual SQL expression '\n                SELECT C...' should be explicitly declared as text('\n                SELECT C...')
2025-12-08 15:16:15,891 - ERROR - [crypto_api.backend] User=None | Ошибка миграции базы данных: maximum recursion depth exceeded
Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 282, in get_db
    yield db
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 300, in migrate_database
    result = db.execute("""
             ~~~~~~~~~~^^^^
        SELECT COUNT(*)
        ^^^^^^^^^^^^^^^
    ...<3 lines>...
        AND column_name = 'host'
        ^^^^^^^^^^^^^^^^^^^^^^^^
    """).fetchone()
    ^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2147, in _execute_internal
    statement = coercions.expect(roles.StatementRole, statement)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 395, in expect
    resolved = impl._literal_coercion(
        element, argname=argname, **kw
    )
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 621, in _literal_coercion
    return self._text_coercion(element, argname, **kw)
           ~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 614, in _text_coercion
    return _no_text_coercion(element, argname)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 584, in _no_text_coercion
    raise exc_cls(
    ...<7 lines>...
    ) from err
sqlalchemy.exc.ArgumentError: Textual SQL expression '\n                SELECT C...' should be explicitly declared as text('\n                SELECT C...')

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 789, in _read_bytes
    data = self._rfile.read(num_bytes)
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\socket.py", line 715, in readinto
    self._checkReadable()
    ~~~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1301, in _checkout
    result = pool._dialect._do_ping_w_event(
        fairy.dbapi_connection
    )
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 728, in _do_ping_w_event
    return self.do_ping(dbapi_connection)
           ~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\dialects\mysql\pymysql.py", line 121, in do_ping
    dbapi_connection.ping(False)
    ~~~~~~~~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 607, in ping
    self._read_ok_packet()
    ~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 465, in _read_ok_packet
    pkt = self._read_packet()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 751, in _read_packet
    packet_header = self._read_bytes(4)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 801, in _read_bytes
    self._force_close()
    ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 444, in _force_close
    self._rfile.close()
    ~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 372, in _close_connection
    self._dialect.do_terminate(connection)
    ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 717, in do_terminate
    self.do_close(dbapi_connection)
    ~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 720, in do_close
    dbapi_connection.close()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 434, in close
    self._force_close()
    ~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 298, in migrate_database
    with get_db() as db:
         ~~~~~~^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 286, in get_db
    log_message(f"Ошибка БД: {e}", 'error')
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 214, in log_message
    db.commit()
    ~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2030, in commit
    trans.commit(_to_root=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "<string>", line 2, in commit
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1311, in commit
    self._prepare_impl()
    ~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 2, in _prepare_impl
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1286, in _prepare_impl
    self.session.flush()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4331, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4466, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4427, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 68, in save_obj
    ) in _organize_states_for_save(base_mapper, states, uowtransaction):
         ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 223, in _organize_states_for_save
    for state, dict_, mapper, connection in _connections_for_states(
                                            ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper, uowtransaction, states
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ):
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 1759, in _connections_for_states
    connection = uowtransaction.transaction.connection(base_mapper)
  File "<string>", line 2, in connection
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1037, in connection
    return self._connection_for_bind(bind, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1173, in _connection_for_bind
    conn = self._parent._connection_for_bind(
        bind, execution_options
    )
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1187, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3277, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 143, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3301, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 447, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1363, in _checkout
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 228, in __exit__
    raise value.with_traceback(traceback)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1366, in _checkout
    rec._checkin_failed(
    ~~~~~~~~~~~~~~~~~~~^
        be_outer,
        ^^^^^^^^^
        _fairy_was_created=True,
        ^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 745, in _checkin_failed
    self.invalidate(e=err)
    ~~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 815, in invalidate
    self.__close(terminate=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 882, in __close
    self.__pool._close_connection(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.dbapi_connection, terminate=terminate
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 376, in _close_connection
    self.logger.error(
    ~~~~~~~~~~~~~~~~~^
        f"Exception {'terminating' if terminate else 'closing'} "
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<2 lines>...
        exc_info=True,
        ^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\logging\__init__.py", line 1549, in error
    self._log(ERROR, msg, args, **kwargs)
    ~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\logging\__init__.py", line 1653, in _log
    fn, lno, func, sinfo = self.findCaller(stack_info, stacklevel)
                           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\logging\__init__.py", line 1597, in findCaller
    f = currentframe()
RecursionError: maximum recursion depth exceeded
2025-12-08 15:16:15,902 - ERROR - [crypto_api.backend] User=None | Ошибка миграции базы данных: maximum recursion depth exceeded
Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 282, in get_db
    yield db
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 300, in migrate_database
    result = db.execute("""
             ~~~~~~~~~~^^^^
        SELECT COUNT(*)
        ^^^^^^^^^^^^^^^
    ...<3 lines>...
        AND column_name = 'host'
        ^^^^^^^^^^^^^^^^^^^^^^^^
    """).fetchone()
    ^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2147, in _execute_internal
    statement = coercions.expect(roles.StatementRole, statement)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 395, in expect
    resolved = impl._literal_coercion(
        element, argname=argname, **kw
    )
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 621, in _literal_coercion
    return self._text_coercion(element, argname, **kw)
           ~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 614, in _text_coercion
    return _no_text_coercion(element, argname)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 584, in _no_text_coercion
    raise exc_cls(
    ...<7 lines>...
    ) from err
sqlalchemy.exc.ArgumentError: Textual SQL expression '\n                SELECT C...' should be explicitly declared as text('\n                SELECT C...')

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 789, in _read_bytes
    data = self._rfile.read(num_bytes)
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\socket.py", line 715, in readinto
    self._checkReadable()
    ~~~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1301, in _checkout
    result = pool._dialect._do_ping_w_event(
        fairy.dbapi_connection
    )
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 728, in _do_ping_w_event
    return self.do_ping(dbapi_connection)
           ~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\dialects\mysql\pymysql.py", line 121, in do_ping
    dbapi_connection.ping(False)
    ~~~~~~~~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 607, in ping
    self._read_ok_packet()
    ~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 465, in _read_ok_packet
    pkt = self._read_packet()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 751, in _read_packet
    packet_header = self._read_bytes(4)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 801, in _read_bytes
    self._force_close()
    ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 444, in _force_close
    self._rfile.close()
    ~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 372, in _close_connection
    self._dialect.do_terminate(connection)
    ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 717, in do_terminate
    self.do_close(dbapi_connection)
    ~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 720, in do_close
    dbapi_connection.close()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 434, in close
    self._force_close()
    ~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 298, in migrate_database
    with get_db() as db:
         ~~~~~~^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 286, in get_db
    log_message(f"Ошибка БД: {e}", 'error')
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 214, in log_message
    db.commit()
    ~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2030, in commit
    trans.commit(_to_root=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "<string>", line 2, in commit
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1311, in commit
    self._prepare_impl()
    ~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 2, in _prepare_impl
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1286, in _prepare_impl
    self.session.flush()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4331, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4466, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4427, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 68, in save_obj
    ) in _organize_states_for_save(base_mapper, states, uowtransaction):
         ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 223, in _organize_states_for_save
    for state, dict_, mapper, connection in _connections_for_states(
                                            ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper, uowtransaction, states
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ):
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 1759, in _connections_for_states
    connection = uowtransaction.transaction.connection(base_mapper)
  File "<string>", line 2, in connection
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1037, in connection
    return self._connection_for_bind(bind, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1173, in _connection_for_bind
    conn = self._parent._connection_for_bind(
        bind, execution_options
    )
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1187, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3277, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 143, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3301, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 447, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1363, in _checkout
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 228, in __exit__
    raise value.with_traceback(traceback)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1366, in _checkout
    rec._checkin_failed(
    ~~~~~~~~~~~~~~~~~~~^
        be_outer,
        ^^^^^^^^^
        _fairy_was_created=True,
        ^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 745, in _checkin_failed
    self.invalidate(e=err)
    ~~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 815, in invalidate
    self.__close(terminate=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 882, in __close
    self.__pool._close_connection(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.dbapi_connection, terminate=terminate
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 376, in _close_connection
    self.logger.error(
    ~~~~~~~~~~~~~~~~~^
        f"Exception {'terminating' if terminate else 'closing'} "
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<2 lines>...
        exc_info=True,
        ^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\logging\__init__.py", line 1549, in error
    self._log(ERROR, msg, args, **kwargs)
    ~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\logging\__init__.py", line 1653, in _log
    fn, lno, func, sinfo = self.findCaller(stack_info, stacklevel)
                           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\logging\__init__.py", line 1597, in findCaller
    f = currentframe()
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 661, in connect
    sock = socket.create_connection(
        (self.host, self.port), self.connect_timeout, **kwargs
    )
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 298, in migrate_database
    with get_db() as db:
         ~~~~~~^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 286, in get_db
    log_message(f"Ошибка БД: {e}", 'error')
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 219, in log_message
    migrate_database()
    ~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 337, in migrate_database
    log_message(f"Ошибка миграции базы данных: {e}", 'error', traceback=str(e))
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 214, in log_message
    db.commit()
    ~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2030, in commit
    trans.commit(_to_root=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "<string>", line 2, in commit
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1311, in commit
    self._prepare_impl()
    ~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 2, in _prepare_impl
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1286, in _prepare_impl
    self.session.flush()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4331, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4466, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4427, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 68, in save_obj
    ) in _organize_states_for_save(base_mapper, states, uowtransaction):
         ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 223, in _organize_states_for_save
    for state, dict_, mapper, connection in _connections_for_states(
                                            ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper, uowtransaction, states
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ):
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 1759, in _connections_for_states
    connection = uowtransaction.transaction.connection(base_mapper)
  File "<string>", line 2, in connection
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1037, in connection
    return self._connection_for_bind(bind, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1173, in _connection_for_bind
    conn = self._parent._connection_for_bind(
        bind, execution_options
    )
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1187, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3277, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 143, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3301, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 447, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1264, in _checkout
    fairy = _ConnectionRecord.checkout(pool)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 711, in checkout
    rec = pool._do_get()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 177, in _do_get
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 175, in _do_get
    return self._create_connection()
           ~~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 388, in _create_connection
    return _ConnectionRecord(self)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 673, in __init__
    self.__connect()
    ~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 899, in __connect
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 895, in __connect
    self.dbapi_connection = connection = pool._invoke_creator(self)
                                         ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\create.py", line 661, in connect
    return dialect.connect(*cargs, **cparams)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 629, in connect
    return self.loaded_dbapi.connect(*cargs, **cparams)  # type: ignore[no-any-return]  # NOQA: E501
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 365, in __init__
    self.connect()
    ~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 711, in connect
    self._force_close()
    ~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded
2025-12-08 15:16:15,920 - ERROR - [crypto_api.backend] User=None | Ошибка миграции базы данных: maximum recursion depth exceeded
Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 282, in get_db
    yield db
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 300, in migrate_database
    result = db.execute("""
             ~~~~~~~~~~^^^^
        SELECT COUNT(*)
        ^^^^^^^^^^^^^^^
    ...<3 lines>...
        AND column_name = 'host'
        ^^^^^^^^^^^^^^^^^^^^^^^^
    """).fetchone()
    ^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2147, in _execute_internal
    statement = coercions.expect(roles.StatementRole, statement)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 395, in expect
    resolved = impl._literal_coercion(
        element, argname=argname, **kw
    )
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 621, in _literal_coercion
    return self._text_coercion(element, argname, **kw)
           ~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 614, in _text_coercion
    return _no_text_coercion(element, argname)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 584, in _no_text_coercion
    raise exc_cls(
    ...<7 lines>...
    ) from err
sqlalchemy.exc.ArgumentError: Textual SQL expression '\n                SELECT C...' should be explicitly declared as text('\n                SELECT C...')

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 789, in _read_bytes
    data = self._rfile.read(num_bytes)
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\socket.py", line 715, in readinto
    self._checkReadable()
    ~~~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1301, in _checkout
    result = pool._dialect._do_ping_w_event(
        fairy.dbapi_connection
    )
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 728, in _do_ping_w_event
    return self.do_ping(dbapi_connection)
           ~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\dialects\mysql\pymysql.py", line 121, in do_ping
    dbapi_connection.ping(False)
    ~~~~~~~~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 607, in ping
    self._read_ok_packet()
    ~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 465, in _read_ok_packet
    pkt = self._read_packet()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 751, in _read_packet
    packet_header = self._read_bytes(4)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 801, in _read_bytes
    self._force_close()
    ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 444, in _force_close
    self._rfile.close()
    ~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 372, in _close_connection
    self._dialect.do_terminate(connection)
    ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 717, in do_terminate
    self.do_close(dbapi_connection)
    ~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 720, in do_close
    dbapi_connection.close()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 434, in close
    self._force_close()
    ~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 298, in migrate_database
    with get_db() as db:
         ~~~~~~^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 286, in get_db
    log_message(f"Ошибка БД: {e}", 'error')
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 214, in log_message
    db.commit()
    ~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2030, in commit
    trans.commit(_to_root=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "<string>", line 2, in commit
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1311, in commit
    self._prepare_impl()
    ~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 2, in _prepare_impl
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1286, in _prepare_impl
    self.session.flush()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4331, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4466, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4427, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 68, in save_obj
    ) in _organize_states_for_save(base_mapper, states, uowtransaction):
         ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 223, in _organize_states_for_save
    for state, dict_, mapper, connection in _connections_for_states(
                                            ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper, uowtransaction, states
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ):
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 1759, in _connections_for_states
    connection = uowtransaction.transaction.connection(base_mapper)
  File "<string>", line 2, in connection
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1037, in connection
    return self._connection_for_bind(bind, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1173, in _connection_for_bind
    conn = self._parent._connection_for_bind(
        bind, execution_options
    )
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1187, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3277, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 143, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3301, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 447, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1363, in _checkout
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 228, in __exit__
    raise value.with_traceback(traceback)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1366, in _checkout
    rec._checkin_failed(
    ~~~~~~~~~~~~~~~~~~~^
        be_outer,
        ^^^^^^^^^
        _fairy_was_created=True,
        ^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 745, in _checkin_failed
    self.invalidate(e=err)
    ~~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 815, in invalidate
    self.__close(terminate=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 882, in __close
    self.__pool._close_connection(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.dbapi_connection, terminate=terminate
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 376, in _close_connection
    self.logger.error(
    ~~~~~~~~~~~~~~~~~^
        f"Exception {'terminating' if terminate else 'closing'} "
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<2 lines>...
        exc_info=True,
        ^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\logging\__init__.py", line 1549, in error
    self._log(ERROR, msg, args, **kwargs)
    ~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\logging\__init__.py", line 1653, in _log
    fn, lno, func, sinfo = self.findCaller(stack_info, stacklevel)
                           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\logging\__init__.py", line 1597, in findCaller
    f = currentframe()
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 661, in connect
    sock = socket.create_connection(
        (self.host, self.port), self.connect_timeout, **kwargs
    )
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 298, in migrate_database
    with get_db() as db:
         ~~~~~~^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 286, in get_db
    log_message(f"Ошибка БД: {e}", 'error')
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 219, in log_message
    migrate_database()
    ~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 337, in migrate_database
    log_message(f"Ошибка миграции базы данных: {e}", 'error', traceback=str(e))
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 214, in log_message
    db.commit()
    ~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2030, in commit
    trans.commit(_to_root=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "<string>", line 2, in commit
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1311, in commit
    self._prepare_impl()
    ~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 2, in _prepare_impl
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1286, in _prepare_impl
    self.session.flush()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4331, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4466, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4427, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 68, in save_obj
    ) in _organize_states_for_save(base_mapper, states, uowtransaction):
         ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 223, in _organize_states_for_save
    for state, dict_, mapper, connection in _connections_for_states(
                                            ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper, uowtransaction, states
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ):
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 1759, in _connections_for_states
    connection = uowtransaction.transaction.connection(base_mapper)
  File "<string>", line 2, in connection
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1037, in connection
    return self._connection_for_bind(bind, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1173, in _connection_for_bind
    conn = self._parent._connection_for_bind(
        bind, execution_options
    )
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1187, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3277, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 143, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3301, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 447, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1264, in _checkout
    fairy = _ConnectionRecord.checkout(pool)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 711, in checkout
    rec = pool._do_get()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 177, in _do_get
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 175, in _do_get
    return self._create_connection()
           ~~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 388, in _create_connection
    return _ConnectionRecord(self)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 673, in __init__
    self.__connect()
    ~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 899, in __connect
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 895, in __connect
    self.dbapi_connection = connection = pool._invoke_creator(self)
                                         ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\create.py", line 661, in connect
    return dialect.connect(*cargs, **cparams)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 629, in connect
    return self.loaded_dbapi.connect(*cargs, **cparams)  # type: ignore[no-any-return]  # NOQA: E501
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 365, in __init__
    self.connect()
    ~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 711, in connect
    self._force_close()
    ~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 298, in migrate_database
    with get_db() as db:
         ~~~~~~^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 286, in get_db
    log_message(f"Ошибка БД: {e}", 'error')
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 219, in log_message
    migrate_database()
    ~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 337, in migrate_database
    log_message(f"Ошибка миграции базы данных: {e}", 'error', traceback=str(e))
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 214, in log_message
    db.commit()
    ~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2030, in commit
    trans.commit(_to_root=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "<string>", line 2, in commit
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1311, in commit
    self._prepare_impl()
    ~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 2, in _prepare_impl
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1286, in _prepare_impl
    self.session.flush()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4331, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4466, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4427, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 68, in save_obj
    ) in _organize_states_for_save(base_mapper, states, uowtransaction):
         ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 223, in _organize_states_for_save
    for state, dict_, mapper, connection in _connections_for_states(
                                            ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper, uowtransaction, states
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ):
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 1759, in _connections_for_states
    connection = uowtransaction.transaction.connection(base_mapper)
  File "<string>", line 2, in connection
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1037, in connection
    return self._connection_for_bind(bind, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1173, in _connection_for_bind
    conn = self._parent._connection_for_bind(
        bind, execution_options
    )
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1187, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3277, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 143, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3301, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 447, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1264, in _checkout
    fairy = _ConnectionRecord.checkout(pool)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 711, in checkout
    rec = pool._do_get()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 177, in _do_get
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 175, in _do_get
    return self._create_connection()
           ~~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 388, in _create_connection
    return _ConnectionRecord(self)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 673, in __init__
    self.__connect()
    ~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 899, in __connect
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 895, in __connect
    self.dbapi_connection = connection = pool._invoke_creator(self)
                                         ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\create.py", line 661, in connect
    return dialect.connect(*cargs, **cparams)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 629, in connect
    return self.loaded_dbapi.connect(*cargs, **cparams)  # type: ignore[no-any-return]  # NOQA: E501
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 365, in __init__
    self.connect()
    ~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 661, in connect
    sock = socket.create_connection(
        (self.host, self.port), self.connect_timeout, **kwargs
    )
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\socket.py", line 840, in create_connection
    for res in getaddrinfo(host, port, 0, SOCK_STREAM):
               ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\socket.py", line 979, in getaddrinfo
    addrlist.append((_intenum_converter(af, AddressFamily),
                     ~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\socket.py", line 106, in _intenum_converter
    return enum_klass(value)
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\enum.py", line 726, in __call__
    return cls.__new__(cls, value)
           ~~~~~~~~~~~^^^^^^^^^^^^
RecursionError: maximum recursion depth exceeded
2025-12-08 15:16:16,009 - ERROR - [crypto_api.backend] User=None | Ошибка миграции базы данных: maximum recursion depth exceeded
Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 282, in get_db
    yield db
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 300, in migrate_database
    result = db.execute("""
             ~~~~~~~~~~^^^^
        SELECT COUNT(*)
        ^^^^^^^^^^^^^^^
    ...<3 lines>...
        AND column_name = 'host'
        ^^^^^^^^^^^^^^^^^^^^^^^^
    """).fetchone()
    ^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2147, in _execute_internal
    statement = coercions.expect(roles.StatementRole, statement)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 395, in expect
    resolved = impl._literal_coercion(
        element, argname=argname, **kw
    )
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 621, in _literal_coercion
    return self._text_coercion(element, argname, **kw)
           ~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 614, in _text_coercion
    return _no_text_coercion(element, argname)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 584, in _no_text_coercion
    raise exc_cls(
    ...<7 lines>...
    ) from err
sqlalchemy.exc.ArgumentError: Textual SQL expression '\n                SELECT C...' should be explicitly declared as text('\n                SELECT C...')

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 789, in _read_bytes
    data = self._rfile.read(num_bytes)
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\socket.py", line 715, in readinto
    self._checkReadable()
    ~~~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1301, in _checkout
    result = pool._dialect._do_ping_w_event(
        fairy.dbapi_connection
    )
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 728, in _do_ping_w_event
    return self.do_ping(dbapi_connection)
           ~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\dialects\mysql\pymysql.py", line 121, in do_ping
    dbapi_connection.ping(False)
    ~~~~~~~~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 607, in ping
    self._read_ok_packet()
    ~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 465, in _read_ok_packet
    pkt = self._read_packet()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 751, in _read_packet
    packet_header = self._read_bytes(4)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 801, in _read_bytes
    self._force_close()
    ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 444, in _force_close
    self._rfile.close()
    ~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 372, in _close_connection
    self._dialect.do_terminate(connection)
    ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 717, in do_terminate
    self.do_close(dbapi_connection)
    ~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 720, in do_close
    dbapi_connection.close()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 434, in close
    self._force_close()
    ~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 298, in migrate_database
    with get_db() as db:
         ~~~~~~^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 286, in get_db
    log_message(f"Ошибка БД: {e}", 'error')
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 214, in log_message
    db.commit()
    ~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2030, in commit
    trans.commit(_to_root=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "<string>", line 2, in commit
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1311, in commit
    self._prepare_impl()
    ~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 2, in _prepare_impl
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1286, in _prepare_impl
    self.session.flush()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4331, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4466, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4427, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 68, in save_obj
    ) in _organize_states_for_save(base_mapper, states, uowtransaction):
         ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 223, in _organize_states_for_save
    for state, dict_, mapper, connection in _connections_for_states(
                                            ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper, uowtransaction, states
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ):
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 1759, in _connections_for_states
    connection = uowtransaction.transaction.connection(base_mapper)
  File "<string>", line 2, in connection
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1037, in connection
    return self._connection_for_bind(bind, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1173, in _connection_for_bind
    conn = self._parent._connection_for_bind(
        bind, execution_options
    )
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1187, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3277, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 143, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3301, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 447, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1363, in _checkout
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 228, in __exit__
    raise value.with_traceback(traceback)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1366, in _checkout
    rec._checkin_failed(
    ~~~~~~~~~~~~~~~~~~~^
        be_outer,
        ^^^^^^^^^
        _fairy_was_created=True,
        ^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 745, in _checkin_failed
    self.invalidate(e=err)
    ~~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 815, in invalidate
    self.__close(terminate=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 882, in __close
    self.__pool._close_connection(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.dbapi_connection, terminate=terminate
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 376, in _close_connection
    self.logger.error(
    ~~~~~~~~~~~~~~~~~^
        f"Exception {'terminating' if terminate else 'closing'} "
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<2 lines>...
        exc_info=True,
        ^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\logging\__init__.py", line 1549, in error
    self._log(ERROR, msg, args, **kwargs)
    ~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\logging\__init__.py", line 1653, in _log
    fn, lno, func, sinfo = self.findCaller(stack_info, stacklevel)
                           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\logging\__init__.py", line 1597, in findCaller
    f = currentframe()
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 661, in connect
    sock = socket.create_connection(
        (self.host, self.port), self.connect_timeout, **kwargs
    )
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 298, in migrate_database
    with get_db() as db:
         ~~~~~~^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 286, in get_db
    log_message(f"Ошибка БД: {e}", 'error')
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 219, in log_message
    migrate_database()
    ~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 337, in migrate_database
    log_message(f"Ошибка миграции базы данных: {e}", 'error', traceback=str(e))
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 214, in log_message
    db.commit()
    ~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2030, in commit
    trans.commit(_to_root=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "<string>", line 2, in commit
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1311, in commit
    self._prepare_impl()
    ~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 2, in _prepare_impl
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1286, in _prepare_impl
    self.session.flush()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4331, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4466, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4427, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 68, in save_obj
    ) in _organize_states_for_save(base_mapper, states, uowtransaction):
         ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 223, in _organize_states_for_save
    for state, dict_, mapper, connection in _connections_for_states(
                                            ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper, uowtransaction, states
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ):
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 1759, in _connections_for_states
    connection = uowtransaction.transaction.connection(base_mapper)
  File "<string>", line 2, in connection
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1037, in connection
    return self._connection_for_bind(bind, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1173, in _connection_for_bind
    conn = self._parent._connection_for_bind(
        bind, execution_options
    )
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1187, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3277, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 143, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3301, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 447, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1264, in _checkout
    fairy = _ConnectionRecord.checkout(pool)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 711, in checkout
    rec = pool._do_get()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 177, in _do_get
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 175, in _do_get
    return self._create_connection()
           ~~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 388, in _create_connection
    return _ConnectionRecord(self)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 673, in __init__
    self.__connect()
    ~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 899, in __connect
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 895, in __connect
    self.dbapi_connection = connection = pool._invoke_creator(self)
                                         ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\create.py", line 661, in connect
    return dialect.connect(*cargs, **cparams)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 629, in connect
    return self.loaded_dbapi.connect(*cargs, **cparams)  # type: ignore[no-any-return]  # NOQA: E501
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 365, in __init__
    self.connect()
    ~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 711, in connect
    self._force_close()
    ~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 298, in migrate_database
    with get_db() as db:
         ~~~~~~^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 286, in get_db
    log_message(f"Ошибка БД: {e}", 'error')
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 219, in log_message
    migrate_database()
    ~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 337, in migrate_database
    log_message(f"Ошибка миграции базы данных: {e}", 'error', traceback=str(e))
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 214, in log_message
    db.commit()
    ~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2030, in commit
    trans.commit(_to_root=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "<string>", line 2, in commit
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1311, in commit
    self._prepare_impl()
    ~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 2, in _prepare_impl
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1286, in _prepare_impl
    self.session.flush()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4331, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4466, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4427, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 68, in save_obj
    ) in _organize_states_for_save(base_mapper, states, uowtransaction):
         ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 223, in _organize_states_for_save
    for state, dict_, mapper, connection in _connections_for_states(
                                            ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper, uowtransaction, states
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ):
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 1759, in _connections_for_states
    connection = uowtransaction.transaction.connection(base_mapper)
  File "<string>", line 2, in connection
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1037, in connection
    return self._connection_for_bind(bind, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1173, in _connection_for_bind
    conn = self._parent._connection_for_bind(
        bind, execution_options
    )
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1187, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3277, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 143, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3301, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 447, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1264, in _checkout
    fairy = _ConnectionRecord.checkout(pool)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 711, in checkout
    rec = pool._do_get()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 177, in _do_get
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 175, in _do_get
    return self._create_connection()
           ~~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 388, in _create_connection
    return _ConnectionRecord(self)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 673, in __init__
    self.__connect()
    ~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 899, in __connect
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 895, in __connect
    self.dbapi_connection = connection = pool._invoke_creator(self)
                                         ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\create.py", line 661, in connect
    return dialect.connect(*cargs, **cparams)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 629, in connect
    return self.loaded_dbapi.connect(*cargs, **cparams)  # type: ignore[no-any-return]  # NOQA: E501
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 365, in __init__
    self.connect()
    ~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 661, in connect
    sock = socket.create_connection(
        (self.host, self.port), self.connect_timeout, **kwargs
    )
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\socket.py", line 840, in create_connection
    for res in getaddrinfo(host, port, 0, SOCK_STREAM):
               ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\socket.py", line 979, in getaddrinfo
    addrlist.append((_intenum_converter(af, AddressFamily),
                     ~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\socket.py", line 106, in _intenum_converter
    return enum_klass(value)
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\enum.py", line 726, in __call__
    return cls.__new__(cls, value)
           ~~~~~~~~~~~^^^^^^^^^^^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 789, in _read_bytes
    data = self._rfile.read(num_bytes)
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\socket.py", line 715, in readinto
    self._checkReadable()
    ~~~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 298, in migrate_database
    with get_db() as db:
         ~~~~~~^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 286, in get_db
    log_message(f"Ошибка БД: {e}", 'error')
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 219, in log_message
    migrate_database()
    ~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 337, in migrate_database
    log_message(f"Ошибка миграции базы данных: {e}", 'error', traceback=str(e))
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 219, in log_message
    migrate_database()
    ~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 337, in migrate_database
    log_message(f"Ошибка миграции базы данных: {e}", 'error', traceback=str(e))
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 214, in log_message
    db.commit()
    ~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2030, in commit
    trans.commit(_to_root=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "<string>", line 2, in commit
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1311, in commit
    self._prepare_impl()
    ~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 2, in _prepare_impl
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1286, in _prepare_impl
    self.session.flush()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4331, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4466, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4427, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 68, in save_obj
    ) in _organize_states_for_save(base_mapper, states, uowtransaction):
         ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 223, in _organize_states_for_save
    for state, dict_, mapper, connection in _connections_for_states(
                                            ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper, uowtransaction, states
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ):
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 1759, in _connections_for_states
    connection = uowtransaction.transaction.connection(base_mapper)
  File "<string>", line 2, in connection
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1037, in connection
    return self._connection_for_bind(bind, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1173, in _connection_for_bind
    conn = self._parent._connection_for_bind(
        bind, execution_options
    )
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1187, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3277, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 143, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3301, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 447, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1264, in _checkout
    fairy = _ConnectionRecord.checkout(pool)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 711, in checkout
    rec = pool._do_get()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 177, in _do_get
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 175, in _do_get
    return self._create_connection()
           ~~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 388, in _create_connection
    return _ConnectionRecord(self)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 673, in __init__
    self.__connect()
    ~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 913, in __connect
    )._exec_w_sync_on_first_run(self.dbapi_connection, self)
      ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\event\attr.py", line 507, in _exec_w_sync_on_first_run
    self(*args, **kw)
    ~~~~^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\event\attr.py", line 515, in __call__
    fn(*args, **kw)
    ~~^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\create.py", line 739, in on_connect
    do_on_connect(dbapi_connection)
    ~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\dialects\mysql\mysqldb.py", line 180, in on_connect
    cursor.execute("SET NAMES %s" % charset_name)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 575, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 826, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 1203, in read
    first_packet = self.connection._read_packet()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 751, in _read_packet
    packet_header = self._read_bytes(4)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 801, in _read_bytes
    self._force_close()
    ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 444, in _force_close
    self._rfile.close()
    ~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded
2025-12-08 15:16:16,164 - ERROR - [crypto_api.backend] User=None | Ошибка БД: Textual SQL expression '\n                SELECT C...' should be explicitly declared as text('\n                SELECT C...')
2025-12-08 15:16:16,222 - ERROR - [crypto_api.backend] User=None | Ошибка БД: Textual SQL expression '\n                SELECT C...' should be explicitly declared as text('\n                SELECT C...')
2025-12-08 15:16:16,278 - ERROR - [crypto_api.backend] User=None | Ошибка БД: Textual SQL expression '\n                SELECT C...' should be explicitly declared as text('\n                SELECT C...')
2025-12-08 15:16:16,337 - ERROR - [crypto_api.backend] User=None | Ошибка БД: Textual SQL expression '\n                SELECT C...' should be explicitly declared as text('\n                SELECT C...')
2025-12-08 15:16:16,339 - ERROR - [crypto_api.backend] User=None | Ошибка миграции базы данных: maximum recursion depth exceeded
Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 282, in get_db
    yield db
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 300, in migrate_database
    result = db.execute("""
             ~~~~~~~~~~^^^^
        SELECT COUNT(*)
        ^^^^^^^^^^^^^^^
    ...<3 lines>...
        AND column_name = 'host'
        ^^^^^^^^^^^^^^^^^^^^^^^^
    """).fetchone()
    ^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2147, in _execute_internal
    statement = coercions.expect(roles.StatementRole, statement)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 395, in expect
    resolved = impl._literal_coercion(
        element, argname=argname, **kw
    )
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 621, in _literal_coercion
    return self._text_coercion(element, argname, **kw)
           ~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 614, in _text_coercion
    return _no_text_coercion(element, argname)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 584, in _no_text_coercion
    raise exc_cls(
    ...<7 lines>...
    ) from err
sqlalchemy.exc.ArgumentError: Textual SQL expression '\n                SELECT C...' should be explicitly declared as text('\n                SELECT C...')

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 789, in _read_bytes
    data = self._rfile.read(num_bytes)
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\socket.py", line 715, in readinto
    self._checkReadable()
    ~~~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1301, in _checkout
    result = pool._dialect._do_ping_w_event(
        fairy.dbapi_connection
    )
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 728, in _do_ping_w_event
    return self.do_ping(dbapi_connection)
           ~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\dialects\mysql\pymysql.py", line 121, in do_ping
    dbapi_connection.ping(False)
    ~~~~~~~~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 607, in ping
    self._read_ok_packet()
    ~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 465, in _read_ok_packet
    pkt = self._read_packet()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 751, in _read_packet
    packet_header = self._read_bytes(4)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 801, in _read_bytes
    self._force_close()
    ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 444, in _force_close
    self._rfile.close()
    ~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 372, in _close_connection
    self._dialect.do_terminate(connection)
    ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 717, in do_terminate
    self.do_close(dbapi_connection)
    ~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 720, in do_close
    dbapi_connection.close()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 434, in close
    self._force_close()
    ~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 298, in migrate_database
    with get_db() as db:
         ~~~~~~^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 286, in get_db
    log_message(f"Ошибка БД: {e}", 'error')
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 214, in log_message
    db.commit()
    ~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2030, in commit
    trans.commit(_to_root=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "<string>", line 2, in commit
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1311, in commit
    self._prepare_impl()
    ~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 2, in _prepare_impl
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1286, in _prepare_impl
    self.session.flush()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4331, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4466, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4427, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 68, in save_obj
    ) in _organize_states_for_save(base_mapper, states, uowtransaction):
         ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 223, in _organize_states_for_save
    for state, dict_, mapper, connection in _connections_for_states(
                                            ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper, uowtransaction, states
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ):
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 1759, in _connections_for_states
    connection = uowtransaction.transaction.connection(base_mapper)
  File "<string>", line 2, in connection
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1037, in connection
    return self._connection_for_bind(bind, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1173, in _connection_for_bind
    conn = self._parent._connection_for_bind(
        bind, execution_options
    )
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1187, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3277, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 143, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3301, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 447, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1363, in _checkout
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 228, in __exit__
    raise value.with_traceback(traceback)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1366, in _checkout
    rec._checkin_failed(
    ~~~~~~~~~~~~~~~~~~~^
        be_outer,
        ^^^^^^^^^
        _fairy_was_created=True,
        ^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 745, in _checkin_failed
    self.invalidate(e=err)
    ~~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 815, in invalidate
    self.__close(terminate=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 882, in __close
    self.__pool._close_connection(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.dbapi_connection, terminate=terminate
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 376, in _close_connection
    self.logger.error(
    ~~~~~~~~~~~~~~~~~^
        f"Exception {'terminating' if terminate else 'closing'} "
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<2 lines>...
        exc_info=True,
        ^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\logging\__init__.py", line 1549, in error
    self._log(ERROR, msg, args, **kwargs)
    ~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\logging\__init__.py", line 1653, in _log
    fn, lno, func, sinfo = self.findCaller(stack_info, stacklevel)
                           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\logging\__init__.py", line 1597, in findCaller
    f = currentframe()
RecursionError: maximum recursion depth exceeded
2025-12-08 15:16:16,357 - ERROR - [crypto_api.backend] User=None | Ошибка миграции базы данных: maximum recursion depth exceeded
Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 282, in get_db
    yield db
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 300, in migrate_database
    result = db.execute("""
             ~~~~~~~~~~^^^^
        SELECT COUNT(*)
        ^^^^^^^^^^^^^^^
    ...<3 lines>...
        AND column_name = 'host'
        ^^^^^^^^^^^^^^^^^^^^^^^^
    """).fetchone()
    ^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2147, in _execute_internal
    statement = coercions.expect(roles.StatementRole, statement)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 395, in expect
    resolved = impl._literal_coercion(
        element, argname=argname, **kw
    )
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 621, in _literal_coercion
    return self._text_coercion(element, argname, **kw)
           ~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 614, in _text_coercion
    return _no_text_coercion(element, argname)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 584, in _no_text_coercion
    raise exc_cls(
    ...<7 lines>...
    ) from err
sqlalchemy.exc.ArgumentError: Textual SQL expression '\n                SELECT C...' should be explicitly declared as text('\n                SELECT C...')

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 789, in _read_bytes
    data = self._rfile.read(num_bytes)
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\socket.py", line 715, in readinto
    self._checkReadable()
    ~~~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1301, in _checkout
    result = pool._dialect._do_ping_w_event(
        fairy.dbapi_connection
    )
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 728, in _do_ping_w_event
    return self.do_ping(dbapi_connection)
           ~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\dialects\mysql\pymysql.py", line 121, in do_ping
    dbapi_connection.ping(False)
    ~~~~~~~~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 607, in ping
    self._read_ok_packet()
    ~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 465, in _read_ok_packet
    pkt = self._read_packet()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 751, in _read_packet
    packet_header = self._read_bytes(4)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 801, in _read_bytes
    self._force_close()
    ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 444, in _force_close
    self._rfile.close()
    ~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 372, in _close_connection
    self._dialect.do_terminate(connection)
    ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 717, in do_terminate
    self.do_close(dbapi_connection)
    ~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 720, in do_close
    dbapi_connection.close()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 434, in close
    self._force_close()
    ~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 298, in migrate_database
    with get_db() as db:
         ~~~~~~^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 286, in get_db
    log_message(f"Ошибка БД: {e}", 'error')
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 214, in log_message
    db.commit()
    ~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2030, in commit
    trans.commit(_to_root=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "<string>", line 2, in commit
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1311, in commit
    self._prepare_impl()
    ~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 2, in _prepare_impl
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1286, in _prepare_impl
    self.session.flush()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4331, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4466, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4427, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 68, in save_obj
    ) in _organize_states_for_save(base_mapper, states, uowtransaction):
         ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 223, in _organize_states_for_save
    for state, dict_, mapper, connection in _connections_for_states(
                                            ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper, uowtransaction, states
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ):
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 1759, in _connections_for_states
    connection = uowtransaction.transaction.connection(base_mapper)
  File "<string>", line 2, in connection
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1037, in connection
    return self._connection_for_bind(bind, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1173, in _connection_for_bind
    conn = self._parent._connection_for_bind(
        bind, execution_options
    )
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1187, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3277, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 143, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3301, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 447, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1363, in _checkout
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 228, in __exit__
    raise value.with_traceback(traceback)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1366, in _checkout
    rec._checkin_failed(
    ~~~~~~~~~~~~~~~~~~~^
        be_outer,
        ^^^^^^^^^
        _fairy_was_created=True,
        ^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 745, in _checkin_failed
    self.invalidate(e=err)
    ~~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 815, in invalidate
    self.__close(terminate=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 882, in __close
    self.__pool._close_connection(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.dbapi_connection, terminate=terminate
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 376, in _close_connection
    self.logger.error(
    ~~~~~~~~~~~~~~~~~^
        f"Exception {'terminating' if terminate else 'closing'} "
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<2 lines>...
        exc_info=True,
        ^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\logging\__init__.py", line 1549, in error
    self._log(ERROR, msg, args, **kwargs)
    ~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\logging\__init__.py", line 1653, in _log
    fn, lno, func, sinfo = self.findCaller(stack_info, stacklevel)
                           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\logging\__init__.py", line 1597, in findCaller
    f = currentframe()
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 661, in connect
    sock = socket.create_connection(
        (self.host, self.port), self.connect_timeout, **kwargs
    )
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 298, in migrate_database
    with get_db() as db:
         ~~~~~~^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 286, in get_db
    log_message(f"Ошибка БД: {e}", 'error')
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 219, in log_message
    migrate_database()
    ~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 337, in migrate_database
    log_message(f"Ошибка миграции базы данных: {e}", 'error', traceback=str(e))
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 214, in log_message
    db.commit()
    ~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2030, in commit
    trans.commit(_to_root=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "<string>", line 2, in commit
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1311, in commit
    self._prepare_impl()
    ~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 2, in _prepare_impl
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1286, in _prepare_impl
    self.session.flush()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4331, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4466, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4427, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 68, in save_obj
    ) in _organize_states_for_save(base_mapper, states, uowtransaction):
         ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 223, in _organize_states_for_save
    for state, dict_, mapper, connection in _connections_for_states(
                                            ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper, uowtransaction, states
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ):
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 1759, in _connections_for_states
    connection = uowtransaction.transaction.connection(base_mapper)
  File "<string>", line 2, in connection
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1037, in connection
    return self._connection_for_bind(bind, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1173, in _connection_for_bind
    conn = self._parent._connection_for_bind(
        bind, execution_options
    )
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1187, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3277, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 143, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3301, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 447, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1264, in _checkout
    fairy = _ConnectionRecord.checkout(pool)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 711, in checkout
    rec = pool._do_get()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 177, in _do_get
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 175, in _do_get
    return self._create_connection()
           ~~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 388, in _create_connection
    return _ConnectionRecord(self)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 673, in __init__
    self.__connect()
    ~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 899, in __connect
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 895, in __connect
    self.dbapi_connection = connection = pool._invoke_creator(self)
                                         ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\create.py", line 661, in connect
    return dialect.connect(*cargs, **cparams)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 629, in connect
    return self.loaded_dbapi.connect(*cargs, **cparams)  # type: ignore[no-any-return]  # NOQA: E501
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 365, in __init__
    self.connect()
    ~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 711, in connect
    self._force_close()
    ~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded
2025-12-08 15:16:16,375 - ERROR - [crypto_api.backend] User=None | Ошибка миграции базы данных: maximum recursion depth exceeded
Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 282, in get_db
    yield db
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 300, in migrate_database
    result = db.execute("""
             ~~~~~~~~~~^^^^
        SELECT COUNT(*)
        ^^^^^^^^^^^^^^^
    ...<3 lines>...
        AND column_name = 'host'
        ^^^^^^^^^^^^^^^^^^^^^^^^
    """).fetchone()
    ^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2147, in _execute_internal
    statement = coercions.expect(roles.StatementRole, statement)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 395, in expect
    resolved = impl._literal_coercion(
        element, argname=argname, **kw
    )
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 621, in _literal_coercion
    return self._text_coercion(element, argname, **kw)
           ~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 614, in _text_coercion
    return _no_text_coercion(element, argname)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 584, in _no_text_coercion
    raise exc_cls(
    ...<7 lines>...
    ) from err
sqlalchemy.exc.ArgumentError: Textual SQL expression '\n                SELECT C...' should be explicitly declared as text('\n                SELECT C...')

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 789, in _read_bytes
    data = self._rfile.read(num_bytes)
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\socket.py", line 715, in readinto
    self._checkReadable()
    ~~~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1301, in _checkout
    result = pool._dialect._do_ping_w_event(
        fairy.dbapi_connection
    )
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 728, in _do_ping_w_event
    return self.do_ping(dbapi_connection)
           ~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\dialects\mysql\pymysql.py", line 121, in do_ping
    dbapi_connection.ping(False)
    ~~~~~~~~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 607, in ping
    self._read_ok_packet()
    ~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 465, in _read_ok_packet
    pkt = self._read_packet()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 751, in _read_packet
    packet_header = self._read_bytes(4)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 801, in _read_bytes
    self._force_close()
    ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 444, in _force_close
    self._rfile.close()
    ~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 372, in _close_connection
    self._dialect.do_terminate(connection)
    ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 717, in do_terminate
    self.do_close(dbapi_connection)
    ~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 720, in do_close
    dbapi_connection.close()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 434, in close
    self._force_close()
    ~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 298, in migrate_database
    with get_db() as db:
         ~~~~~~^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 286, in get_db
    log_message(f"Ошибка БД: {e}", 'error')
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 214, in log_message
    db.commit()
    ~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2030, in commit
    trans.commit(_to_root=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "<string>", line 2, in commit
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1311, in commit
    self._prepare_impl()
    ~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 2, in _prepare_impl
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1286, in _prepare_impl
    self.session.flush()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4331, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4466, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4427, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 68, in save_obj
    ) in _organize_states_for_save(base_mapper, states, uowtransaction):
         ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 223, in _organize_states_for_save
    for state, dict_, mapper, connection in _connections_for_states(
                                            ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper, uowtransaction, states
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ):
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 1759, in _connections_for_states
    connection = uowtransaction.transaction.connection(base_mapper)
  File "<string>", line 2, in connection
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1037, in connection
    return self._connection_for_bind(bind, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1173, in _connection_for_bind
    conn = self._parent._connection_for_bind(
        bind, execution_options
    )
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1187, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3277, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 143, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3301, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 447, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1363, in _checkout
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 228, in __exit__
    raise value.with_traceback(traceback)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1366, in _checkout
    rec._checkin_failed(
    ~~~~~~~~~~~~~~~~~~~^
        be_outer,
        ^^^^^^^^^
        _fairy_was_created=True,
        ^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 745, in _checkin_failed
    self.invalidate(e=err)
    ~~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 815, in invalidate
    self.__close(terminate=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 882, in __close
    self.__pool._close_connection(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.dbapi_connection, terminate=terminate
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 376, in _close_connection
    self.logger.error(
    ~~~~~~~~~~~~~~~~~^
        f"Exception {'terminating' if terminate else 'closing'} "
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<2 lines>...
        exc_info=True,
        ^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\logging\__init__.py", line 1549, in error
    self._log(ERROR, msg, args, **kwargs)
    ~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\logging\__init__.py", line 1653, in _log
    fn, lno, func, sinfo = self.findCaller(stack_info, stacklevel)
                           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\logging\__init__.py", line 1597, in findCaller
    f = currentframe()
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 661, in connect
    sock = socket.create_connection(
        (self.host, self.port), self.connect_timeout, **kwargs
    )
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 298, in migrate_database
    with get_db() as db:
         ~~~~~~^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 286, in get_db
    log_message(f"Ошибка БД: {e}", 'error')
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 219, in log_message
    migrate_database()
    ~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 337, in migrate_database
    log_message(f"Ошибка миграции базы данных: {e}", 'error', traceback=str(e))
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 214, in log_message
    db.commit()
    ~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2030, in commit
    trans.commit(_to_root=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "<string>", line 2, in commit
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1311, in commit
    self._prepare_impl()
    ~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 2, in _prepare_impl
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1286, in _prepare_impl
    self.session.flush()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4331, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4466, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4427, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 68, in save_obj
    ) in _organize_states_for_save(base_mapper, states, uowtransaction):
         ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 223, in _organize_states_for_save
    for state, dict_, mapper, connection in _connections_for_states(
                                            ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper, uowtransaction, states
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ):
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 1759, in _connections_for_states
    connection = uowtransaction.transaction.connection(base_mapper)
  File "<string>", line 2, in connection
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1037, in connection
    return self._connection_for_bind(bind, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1173, in _connection_for_bind
    conn = self._parent._connection_for_bind(
        bind, execution_options
    )
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1187, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3277, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 143, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3301, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 447, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1264, in _checkout
    fairy = _ConnectionRecord.checkout(pool)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 711, in checkout
    rec = pool._do_get()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 177, in _do_get
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 175, in _do_get
    return self._create_connection()
           ~~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 388, in _create_connection
    return _ConnectionRecord(self)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 673, in __init__
    self.__connect()
    ~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 899, in __connect
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 895, in __connect
    self.dbapi_connection = connection = pool._invoke_creator(self)
                                         ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\create.py", line 661, in connect
    return dialect.connect(*cargs, **cparams)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 629, in connect
    return self.loaded_dbapi.connect(*cargs, **cparams)  # type: ignore[no-any-return]  # NOQA: E501
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 365, in __init__
    self.connect()
    ~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 711, in connect
    self._force_close()
    ~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 298, in migrate_database
    with get_db() as db:
         ~~~~~~^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 286, in get_db
    log_message(f"Ошибка БД: {e}", 'error')
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 219, in log_message
    migrate_database()
    ~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 337, in migrate_database
    log_message(f"Ошибка миграции базы данных: {e}", 'error', traceback=str(e))
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 214, in log_message
    db.commit()
    ~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2030, in commit
    trans.commit(_to_root=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "<string>", line 2, in commit
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1311, in commit
    self._prepare_impl()
    ~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 2, in _prepare_impl
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1286, in _prepare_impl
    self.session.flush()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4331, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4466, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4427, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 68, in save_obj
    ) in _organize_states_for_save(base_mapper, states, uowtransaction):
         ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 223, in _organize_states_for_save
    for state, dict_, mapper, connection in _connections_for_states(
                                            ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper, uowtransaction, states
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ):
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 1759, in _connections_for_states
    connection = uowtransaction.transaction.connection(base_mapper)
  File "<string>", line 2, in connection
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1037, in connection
    return self._connection_for_bind(bind, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1173, in _connection_for_bind
    conn = self._parent._connection_for_bind(
        bind, execution_options
    )
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1187, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3277, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 143, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3301, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 447, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1264, in _checkout
    fairy = _ConnectionRecord.checkout(pool)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 711, in checkout
    rec = pool._do_get()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 177, in _do_get
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 175, in _do_get
    return self._create_connection()
           ~~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 388, in _create_connection
    return _ConnectionRecord(self)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 673, in __init__
    self.__connect()
    ~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 899, in __connect
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 895, in __connect
    self.dbapi_connection = connection = pool._invoke_creator(self)
                                         ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\create.py", line 661, in connect
    return dialect.connect(*cargs, **cparams)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 629, in connect
    return self.loaded_dbapi.connect(*cargs, **cparams)  # type: ignore[no-any-return]  # NOQA: E501
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 365, in __init__
    self.connect()
    ~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 661, in connect
    sock = socket.create_connection(
        (self.host, self.port), self.connect_timeout, **kwargs
    )
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\socket.py", line 840, in create_connection
    for res in getaddrinfo(host, port, 0, SOCK_STREAM):
               ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\socket.py", line 979, in getaddrinfo
    addrlist.append((_intenum_converter(af, AddressFamily),
                     ~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\socket.py", line 106, in _intenum_converter
    return enum_klass(value)
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\enum.py", line 726, in __call__
    return cls.__new__(cls, value)
           ~~~~~~~~~~~^^^^^^^^^^^^
RecursionError: maximum recursion depth exceeded
2025-12-08 15:16:16,471 - ERROR - [crypto_api.backend] User=None | Ошибка миграции базы данных: maximum recursion depth exceeded
Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 282, in get_db
    yield db
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 300, in migrate_database
    result = db.execute("""
             ~~~~~~~~~~^^^^
        SELECT COUNT(*)
        ^^^^^^^^^^^^^^^
    ...<3 lines>...
        AND column_name = 'host'
        ^^^^^^^^^^^^^^^^^^^^^^^^
    """).fetchone()
    ^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2147, in _execute_internal
    statement = coercions.expect(roles.StatementRole, statement)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 395, in expect
    resolved = impl._literal_coercion(
        element, argname=argname, **kw
    )
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 621, in _literal_coercion
    return self._text_coercion(element, argname, **kw)
           ~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 614, in _text_coercion
    return _no_text_coercion(element, argname)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 584, in _no_text_coercion
    raise exc_cls(
    ...<7 lines>...
    ) from err
sqlalchemy.exc.ArgumentError: Textual SQL expression '\n                SELECT C...' should be explicitly declared as text('\n                SELECT C...')

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 789, in _read_bytes
    data = self._rfile.read(num_bytes)
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\socket.py", line 715, in readinto
    self._checkReadable()
    ~~~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1301, in _checkout
    result = pool._dialect._do_ping_w_event(
        fairy.dbapi_connection
    )
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 728, in _do_ping_w_event
    return self.do_ping(dbapi_connection)
           ~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\dialects\mysql\pymysql.py", line 121, in do_ping
    dbapi_connection.ping(False)
    ~~~~~~~~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 607, in ping
    self._read_ok_packet()
    ~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 465, in _read_ok_packet
    pkt = self._read_packet()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 751, in _read_packet
    packet_header = self._read_bytes(4)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 801, in _read_bytes
    self._force_close()
    ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 444, in _force_close
    self._rfile.close()
    ~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 372, in _close_connection
    self._dialect.do_terminate(connection)
    ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 717, in do_terminate
    self.do_close(dbapi_connection)
    ~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 720, in do_close
    dbapi_connection.close()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 434, in close
    self._force_close()
    ~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 298, in migrate_database
    with get_db() as db:
         ~~~~~~^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 286, in get_db
    log_message(f"Ошибка БД: {e}", 'error')
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 214, in log_message
    db.commit()
    ~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2030, in commit
    trans.commit(_to_root=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "<string>", line 2, in commit
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1311, in commit
    self._prepare_impl()
    ~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 2, in _prepare_impl
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1286, in _prepare_impl
    self.session.flush()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4331, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4466, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4427, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 68, in save_obj
    ) in _organize_states_for_save(base_mapper, states, uowtransaction):
         ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 223, in _organize_states_for_save
    for state, dict_, mapper, connection in _connections_for_states(
                                            ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper, uowtransaction, states
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ):
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 1759, in _connections_for_states
    connection = uowtransaction.transaction.connection(base_mapper)
  File "<string>", line 2, in connection
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1037, in connection
    return self._connection_for_bind(bind, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1173, in _connection_for_bind
    conn = self._parent._connection_for_bind(
        bind, execution_options
    )
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1187, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3277, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 143, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3301, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 447, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1363, in _checkout
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 228, in __exit__
    raise value.with_traceback(traceback)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1366, in _checkout
    rec._checkin_failed(
    ~~~~~~~~~~~~~~~~~~~^
        be_outer,
        ^^^^^^^^^
        _fairy_was_created=True,
        ^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 745, in _checkin_failed
    self.invalidate(e=err)
    ~~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 815, in invalidate
    self.__close(terminate=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 882, in __close
    self.__pool._close_connection(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.dbapi_connection, terminate=terminate
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 376, in _close_connection
    self.logger.error(
    ~~~~~~~~~~~~~~~~~^
        f"Exception {'terminating' if terminate else 'closing'} "
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<2 lines>...
        exc_info=True,
        ^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\logging\__init__.py", line 1549, in error
    self._log(ERROR, msg, args, **kwargs)
    ~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\logging\__init__.py", line 1653, in _log
    fn, lno, func, sinfo = self.findCaller(stack_info, stacklevel)
                           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\logging\__init__.py", line 1597, in findCaller
    f = currentframe()
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 661, in connect
    sock = socket.create_connection(
        (self.host, self.port), self.connect_timeout, **kwargs
    )
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 298, in migrate_database
    with get_db() as db:
         ~~~~~~^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 286, in get_db
    log_message(f"Ошибка БД: {e}", 'error')
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 219, in log_message
    migrate_database()
    ~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 337, in migrate_database
    log_message(f"Ошибка миграции базы данных: {e}", 'error', traceback=str(e))
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 214, in log_message
    db.commit()
    ~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2030, in commit
    trans.commit(_to_root=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "<string>", line 2, in commit
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1311, in commit
    self._prepare_impl()
    ~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 2, in _prepare_impl
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1286, in _prepare_impl
    self.session.flush()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4331, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4466, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4427, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 68, in save_obj
    ) in _organize_states_for_save(base_mapper, states, uowtransaction):
         ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 223, in _organize_states_for_save
    for state, dict_, mapper, connection in _connections_for_states(
                                            ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper, uowtransaction, states
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ):
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 1759, in _connections_for_states
    connection = uowtransaction.transaction.connection(base_mapper)
  File "<string>", line 2, in connection
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1037, in connection
    return self._connection_for_bind(bind, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1173, in _connection_for_bind
    conn = self._parent._connection_for_bind(
        bind, execution_options
    )
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1187, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3277, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 143, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3301, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 447, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1264, in _checkout
    fairy = _ConnectionRecord.checkout(pool)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 711, in checkout
    rec = pool._do_get()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 177, in _do_get
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 175, in _do_get
    return self._create_connection()
           ~~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 388, in _create_connection
    return _ConnectionRecord(self)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 673, in __init__
    self.__connect()
    ~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 899, in __connect
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 895, in __connect
    self.dbapi_connection = connection = pool._invoke_creator(self)
                                         ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\create.py", line 661, in connect
    return dialect.connect(*cargs, **cparams)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 629, in connect
    return self.loaded_dbapi.connect(*cargs, **cparams)  # type: ignore[no-any-return]  # NOQA: E501
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 365, in __init__
    self.connect()
    ~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 711, in connect
    self._force_close()
    ~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 298, in migrate_database
    with get_db() as db:
         ~~~~~~^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 286, in get_db
    log_message(f"Ошибка БД: {e}", 'error')
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 219, in log_message
    migrate_database()
    ~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 337, in migrate_database
    log_message(f"Ошибка миграции базы данных: {e}", 'error', traceback=str(e))
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 214, in log_message
    db.commit()
    ~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2030, in commit
    trans.commit(_to_root=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "<string>", line 2, in commit
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1311, in commit
    self._prepare_impl()
    ~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 2, in _prepare_impl
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1286, in _prepare_impl
    self.session.flush()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4331, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4466, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4427, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 68, in save_obj
    ) in _organize_states_for_save(base_mapper, states, uowtransaction):
         ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 223, in _organize_states_for_save
    for state, dict_, mapper, connection in _connections_for_states(
                                            ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper, uowtransaction, states
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ):
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 1759, in _connections_for_states
    connection = uowtransaction.transaction.connection(base_mapper)
  File "<string>", line 2, in connection
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1037, in connection
    return self._connection_for_bind(bind, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1173, in _connection_for_bind
    conn = self._parent._connection_for_bind(
        bind, execution_options
    )
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1187, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3277, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 143, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3301, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 447, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1264, in _checkout
    fairy = _ConnectionRecord.checkout(pool)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 711, in checkout
    rec = pool._do_get()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 177, in _do_get
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 175, in _do_get
    return self._create_connection()
           ~~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 388, in _create_connection
    return _ConnectionRecord(self)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 673, in __init__
    self.__connect()
    ~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 899, in __connect
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 895, in __connect
    self.dbapi_connection = connection = pool._invoke_creator(self)
                                         ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\create.py", line 661, in connect
    return dialect.connect(*cargs, **cparams)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 629, in connect
    return self.loaded_dbapi.connect(*cargs, **cparams)  # type: ignore[no-any-return]  # NOQA: E501
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 365, in __init__
    self.connect()
    ~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 661, in connect
    sock = socket.create_connection(
        (self.host, self.port), self.connect_timeout, **kwargs
    )
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\socket.py", line 840, in create_connection
    for res in getaddrinfo(host, port, 0, SOCK_STREAM):
               ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\socket.py", line 979, in getaddrinfo
    addrlist.append((_intenum_converter(af, AddressFamily),
                     ~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\socket.py", line 106, in _intenum_converter
    return enum_klass(value)
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\enum.py", line 726, in __call__
    return cls.__new__(cls, value)
           ~~~~~~~~~~~^^^^^^^^^^^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 789, in _read_bytes
    data = self._rfile.read(num_bytes)
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\socket.py", line 715, in readinto
    self._checkReadable()
    ~~~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 298, in migrate_database
    with get_db() as db:
         ~~~~~~^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 286, in get_db
    log_message(f"Ошибка БД: {e}", 'error')
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 219, in log_message
    migrate_database()
    ~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 337, in migrate_database
    log_message(f"Ошибка миграции базы данных: {e}", 'error', traceback=str(e))
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 214, in log_message
    db.commit()
    ~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2030, in commit
    trans.commit(_to_root=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "<string>", line 2, in commit
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1311, in commit
    self._prepare_impl()
    ~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 2, in _prepare_impl
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1286, in _prepare_impl
    self.session.flush()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4331, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4466, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4427, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 68, in save_obj
    ) in _organize_states_for_save(base_mapper, states, uowtransaction):
         ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 223, in _organize_states_for_save
    for state, dict_, mapper, connection in _connections_for_states(
                                            ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper, uowtransaction, states
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ):
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 1759, in _connections_for_states
    connection = uowtransaction.transaction.connection(base_mapper)
  File "<string>", line 2, in connection
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1037, in connection
    return self._connection_for_bind(bind, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1173, in _connection_for_bind
    conn = self._parent._connection_for_bind(
        bind, execution_options
    )
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1187, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3277, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 143, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3301, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 447, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1264, in _checkout
    fairy = _ConnectionRecord.checkout(pool)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 711, in checkout
    rec = pool._do_get()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 177, in _do_get
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 175, in _do_get
    return self._create_connection()
           ~~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 388, in _create_connection
    return _ConnectionRecord(self)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 673, in __init__
    self.__connect()
    ~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 913, in __connect
    )._exec_w_sync_on_first_run(self.dbapi_connection, self)
      ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\event\attr.py", line 507, in _exec_w_sync_on_first_run
    self(*args, **kw)
    ~~~~^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\event\attr.py", line 515, in __call__
    fn(*args, **kw)
    ~~^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\create.py", line 739, in on_connect
    do_on_connect(dbapi_connection)
    ~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\dialects\mysql\mysqldb.py", line 180, in on_connect
    cursor.execute("SET NAMES %s" % charset_name)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 575, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 826, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 1203, in read
    first_packet = self.connection._read_packet()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 751, in _read_packet
    packet_header = self._read_bytes(4)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 801, in _read_bytes
    self._force_close()
    ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 444, in _force_close
    self._rfile.close()
    ~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded
2025-12-08 15:16:16,634 - ERROR - [crypto_api.backend] User=None | Ошибка БД: Textual SQL expression '\n                SELECT C...' should be explicitly declared as text('\n                SELECT C...')
2025-12-08 15:16:16,691 - ERROR - [crypto_api.backend] User=None | Ошибка БД: Textual SQL expression '\n                SELECT C...' should be explicitly declared as text('\n                SELECT C...')
2025-12-08 15:16:16,747 - ERROR - [crypto_api.backend] User=None | Ошибка БД: Textual SQL expression '\n                SELECT C...' should be explicitly declared as text('\n                SELECT C...')
2025-12-08 15:16:16,805 - ERROR - [crypto_api.backend] User=None | Ошибка БД: Textual SQL expression '\n                SELECT C...' should be explicitly declared as text('\n                SELECT C...')
2025-12-08 15:16:16,807 - ERROR - [crypto_api.backend] User=None | Ошибка миграции базы данных: maximum recursion depth exceeded
Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 282, in get_db
    yield db
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 300, in migrate_database
    result = db.execute("""
             ~~~~~~~~~~^^^^
        SELECT COUNT(*)
        ^^^^^^^^^^^^^^^
    ...<3 lines>...
        AND column_name = 'host'
        ^^^^^^^^^^^^^^^^^^^^^^^^
    """).fetchone()
    ^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2147, in _execute_internal
    statement = coercions.expect(roles.StatementRole, statement)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 395, in expect
    resolved = impl._literal_coercion(
        element, argname=argname, **kw
    )
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 621, in _literal_coercion
    return self._text_coercion(element, argname, **kw)
           ~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 614, in _text_coercion
    return _no_text_coercion(element, argname)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 584, in _no_text_coercion
    raise exc_cls(
    ...<7 lines>...
    ) from err
sqlalchemy.exc.ArgumentError: Textual SQL expression '\n                SELECT C...' should be explicitly declared as text('\n                SELECT C...')

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1301, in _checkout
    result = pool._dialect._do_ping_w_event(
        fairy.dbapi_connection
    )
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 728, in _do_ping_w_event
    return self.do_ping(dbapi_connection)
           ~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\dialects\mysql\pymysql.py", line 121, in do_ping
    dbapi_connection.ping(False)
    ~~~~~~~~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 607, in ping
    self._read_ok_packet()
    ~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 465, in _read_ok_packet
    pkt = self._read_packet()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 751, in _read_packet
    packet_header = self._read_bytes(4)
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 298, in migrate_database
    with get_db() as db:
         ~~~~~~^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 286, in get_db
    log_message(f"Ошибка БД: {e}", 'error')
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 214, in log_message
    db.commit()
    ~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2030, in commit
    trans.commit(_to_root=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "<string>", line 2, in commit
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1311, in commit
    self._prepare_impl()
    ~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 2, in _prepare_impl
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1286, in _prepare_impl
    self.session.flush()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4331, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4466, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4427, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 68, in save_obj
    ) in _organize_states_for_save(base_mapper, states, uowtransaction):
         ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 223, in _organize_states_for_save
    for state, dict_, mapper, connection in _connections_for_states(
                                            ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper, uowtransaction, states
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ):
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 1759, in _connections_for_states
    connection = uowtransaction.transaction.connection(base_mapper)
  File "<string>", line 2, in connection
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1037, in connection
    return self._connection_for_bind(bind, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1173, in _connection_for_bind
    conn = self._parent._connection_for_bind(
        bind, execution_options
    )
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1187, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3277, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 143, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3301, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 447, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1363, in _checkout
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 228, in __exit__
    raise value.with_traceback(traceback)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1366, in _checkout
    rec._checkin_failed(
    ~~~~~~~~~~~~~~~~~~~^
        be_outer,
        ^^^^^^^^^
        _fairy_was_created=True,
        ^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 745, in _checkin_failed
    self.invalidate(e=err)
    ~~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 815, in invalidate
    self.__close(terminate=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 882, in __close
    self.__pool._close_connection(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.dbapi_connection, terminate=terminate
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 365, in _close_connection
    self.logger.debug(
    ~~~~~~~~~~~~~~~~~^
        "%s connection %r",
        ^^^^^^^^^^^^^^^^^^^
        "Hard-closing" if terminate else "Closing",
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        connection,
        ^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\logging\__init__.py", line 1507, in debug
    if self.isEnabledFor(DEBUG):
       ~~~~~~~~~~~~~~~~~^^^^^^^
RecursionError: maximum recursion depth exceeded
2025-12-08 15:16:16,817 - ERROR - [crypto_api.backend] User=None | Ошибка миграции базы данных: maximum recursion depth exceeded
Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 282, in get_db
    yield db
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 300, in migrate_database
    result = db.execute("""
             ~~~~~~~~~~^^^^
        SELECT COUNT(*)
        ^^^^^^^^^^^^^^^
    ...<3 lines>...
        AND column_name = 'host'
        ^^^^^^^^^^^^^^^^^^^^^^^^
    """).fetchone()
    ^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2147, in _execute_internal
    statement = coercions.expect(roles.StatementRole, statement)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 395, in expect
    resolved = impl._literal_coercion(
        element, argname=argname, **kw
    )
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 621, in _literal_coercion
    return self._text_coercion(element, argname, **kw)
           ~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 614, in _text_coercion
    return _no_text_coercion(element, argname)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 584, in _no_text_coercion
    raise exc_cls(
    ...<7 lines>...
    ) from err
sqlalchemy.exc.ArgumentError: Textual SQL expression '\n                SELECT C...' should be explicitly declared as text('\n                SELECT C...')

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1301, in _checkout
    result = pool._dialect._do_ping_w_event(
        fairy.dbapi_connection
    )
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 728, in _do_ping_w_event
    return self.do_ping(dbapi_connection)
           ~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\dialects\mysql\pymysql.py", line 121, in do_ping
    dbapi_connection.ping(False)
    ~~~~~~~~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 607, in ping
    self._read_ok_packet()
    ~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 465, in _read_ok_packet
    pkt = self._read_packet()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 751, in _read_packet
    packet_header = self._read_bytes(4)
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 298, in migrate_database
    with get_db() as db:
         ~~~~~~^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 286, in get_db
    log_message(f"Ошибка БД: {e}", 'error')
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 214, in log_message
    db.commit()
    ~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2030, in commit
    trans.commit(_to_root=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "<string>", line 2, in commit
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1311, in commit
    self._prepare_impl()
    ~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 2, in _prepare_impl
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1286, in _prepare_impl
    self.session.flush()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4331, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4466, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4427, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 68, in save_obj
    ) in _organize_states_for_save(base_mapper, states, uowtransaction):
         ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 223, in _organize_states_for_save
    for state, dict_, mapper, connection in _connections_for_states(
                                            ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper, uowtransaction, states
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ):
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 1759, in _connections_for_states
    connection = uowtransaction.transaction.connection(base_mapper)
  File "<string>", line 2, in connection
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1037, in connection
    return self._connection_for_bind(bind, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1173, in _connection_for_bind
    conn = self._parent._connection_for_bind(
        bind, execution_options
    )
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1187, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3277, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 143, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3301, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 447, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1363, in _checkout
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 228, in __exit__
    raise value.with_traceback(traceback)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1366, in _checkout
    rec._checkin_failed(
    ~~~~~~~~~~~~~~~~~~~^
        be_outer,
        ^^^^^^^^^
        _fairy_was_created=True,
        ^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 745, in _checkin_failed
    self.invalidate(e=err)
    ~~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 815, in invalidate
    self.__close(terminate=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 882, in __close
    self.__pool._close_connection(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.dbapi_connection, terminate=terminate
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 365, in _close_connection
    self.logger.debug(
    ~~~~~~~~~~~~~~~~~^
        "%s connection %r",
        ^^^^^^^^^^^^^^^^^^^
        "Hard-closing" if terminate else "Closing",
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        connection,
        ^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\logging\__init__.py", line 1507, in debug
    if self.isEnabledFor(DEBUG):
       ~~~~~~~~~~~~~~~~~^^^^^^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 298, in migrate_database
    with get_db() as db:
         ~~~~~~^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 286, in get_db
    log_message(f"Ошибка БД: {e}", 'error')
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 219, in log_message
    migrate_database()
    ~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 337, in migrate_database
    log_message(f"Ошибка миграции базы данных: {e}", 'error', traceback=str(e))
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 214, in log_message
    db.commit()
    ~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2030, in commit
    trans.commit(_to_root=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "<string>", line 2, in commit
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1311, in commit
    self._prepare_impl()
    ~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 2, in _prepare_impl
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1286, in _prepare_impl
    self.session.flush()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4331, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4466, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4427, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 68, in save_obj
    ) in _organize_states_for_save(base_mapper, states, uowtransaction):
         ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 223, in _organize_states_for_save
    for state, dict_, mapper, connection in _connections_for_states(
                                            ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper, uowtransaction, states
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ):
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 1759, in _connections_for_states
    connection = uowtransaction.transaction.connection(base_mapper)
  File "<string>", line 2, in connection
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1037, in connection
    return self._connection_for_bind(bind, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1173, in _connection_for_bind
    conn = self._parent._connection_for_bind(
        bind, execution_options
    )
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1187, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3277, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 143, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3301, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 447, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1264, in _checkout
    fairy = _ConnectionRecord.checkout(pool)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 711, in checkout
    rec = pool._do_get()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 177, in _do_get
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 175, in _do_get
    return self._create_connection()
           ~~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 388, in _create_connection
    return _ConnectionRecord(self)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 673, in __init__
    self.__connect()
    ~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 899, in __connect
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 895, in __connect
    self.dbapi_connection = connection = pool._invoke_creator(self)
                                         ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\create.py", line 661, in connect
    return dialect.connect(*cargs, **cparams)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 629, in connect
    return self.loaded_dbapi.connect(*cargs, **cparams)  # type: ignore[no-any-return]  # NOQA: E501
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
RecursionError: maximum recursion depth exceeded
2025-12-08 15:16:16,830 - ERROR - [crypto_api.backend] User=None | Ошибка миграции базы данных: maximum recursion depth exceeded
Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 282, in get_db
    yield db
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 300, in migrate_database
    result = db.execute("""
             ~~~~~~~~~~^^^^
        SELECT COUNT(*)
        ^^^^^^^^^^^^^^^
    ...<3 lines>...
        AND column_name = 'host'
        ^^^^^^^^^^^^^^^^^^^^^^^^
    """).fetchone()
    ^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2147, in _execute_internal
    statement = coercions.expect(roles.StatementRole, statement)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 395, in expect
    resolved = impl._literal_coercion(
        element, argname=argname, **kw
    )
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 621, in _literal_coercion
    return self._text_coercion(element, argname, **kw)
           ~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 614, in _text_coercion
    return _no_text_coercion(element, argname)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 584, in _no_text_coercion
    raise exc_cls(
    ...<7 lines>...
    ) from err
sqlalchemy.exc.ArgumentError: Textual SQL expression '\n                SELECT C...' should be explicitly declared as text('\n                SELECT C...')

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1301, in _checkout
    result = pool._dialect._do_ping_w_event(
        fairy.dbapi_connection
    )
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 728, in _do_ping_w_event
    return self.do_ping(dbapi_connection)
           ~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\dialects\mysql\pymysql.py", line 121, in do_ping
    dbapi_connection.ping(False)
    ~~~~~~~~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 607, in ping
    self._read_ok_packet()
    ~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 465, in _read_ok_packet
    pkt = self._read_packet()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 751, in _read_packet
    packet_header = self._read_bytes(4)
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 298, in migrate_database
    with get_db() as db:
         ~~~~~~^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 286, in get_db
    log_message(f"Ошибка БД: {e}", 'error')
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 214, in log_message
    db.commit()
    ~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2030, in commit
    trans.commit(_to_root=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "<string>", line 2, in commit
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1311, in commit
    self._prepare_impl()
    ~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 2, in _prepare_impl
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1286, in _prepare_impl
    self.session.flush()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4331, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4466, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4427, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 68, in save_obj
    ) in _organize_states_for_save(base_mapper, states, uowtransaction):
         ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 223, in _organize_states_for_save
    for state, dict_, mapper, connection in _connections_for_states(
                                            ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper, uowtransaction, states
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ):
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 1759, in _connections_for_states
    connection = uowtransaction.transaction.connection(base_mapper)
  File "<string>", line 2, in connection
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1037, in connection
    return self._connection_for_bind(bind, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1173, in _connection_for_bind
    conn = self._parent._connection_for_bind(
        bind, execution_options
    )
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1187, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3277, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 143, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3301, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 447, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1363, in _checkout
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 228, in __exit__
    raise value.with_traceback(traceback)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1366, in _checkout
    rec._checkin_failed(
    ~~~~~~~~~~~~~~~~~~~^
        be_outer,
        ^^^^^^^^^
        _fairy_was_created=True,
        ^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 745, in _checkin_failed
    self.invalidate(e=err)
    ~~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 815, in invalidate
    self.__close(terminate=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 882, in __close
    self.__pool._close_connection(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.dbapi_connection, terminate=terminate
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 365, in _close_connection
    self.logger.debug(
    ~~~~~~~~~~~~~~~~~^
        "%s connection %r",
        ^^^^^^^^^^^^^^^^^^^
        "Hard-closing" if terminate else "Closing",
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        connection,
        ^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\logging\__init__.py", line 1507, in debug
    if self.isEnabledFor(DEBUG):
       ~~~~~~~~~~~~~~~~~^^^^^^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 298, in migrate_database
    with get_db() as db:
         ~~~~~~^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 286, in get_db
    log_message(f"Ошибка БД: {e}", 'error')
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 219, in log_message
    migrate_database()
    ~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 337, in migrate_database
    log_message(f"Ошибка миграции базы данных: {e}", 'error', traceback=str(e))
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 214, in log_message
    db.commit()
    ~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2030, in commit
    trans.commit(_to_root=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "<string>", line 2, in commit
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1311, in commit
    self._prepare_impl()
    ~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 2, in _prepare_impl
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1286, in _prepare_impl
    self.session.flush()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4331, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4466, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4427, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 68, in save_obj
    ) in _organize_states_for_save(base_mapper, states, uowtransaction):
         ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 223, in _organize_states_for_save
    for state, dict_, mapper, connection in _connections_for_states(
                                            ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper, uowtransaction, states
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ):
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 1759, in _connections_for_states
    connection = uowtransaction.transaction.connection(base_mapper)
  File "<string>", line 2, in connection
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1037, in connection
    return self._connection_for_bind(bind, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1173, in _connection_for_bind
    conn = self._parent._connection_for_bind(
        bind, execution_options
    )
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1187, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3277, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 143, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3301, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 447, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1264, in _checkout
    fairy = _ConnectionRecord.checkout(pool)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 711, in checkout
    rec = pool._do_get()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 177, in _do_get
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 175, in _do_get
    return self._create_connection()
           ~~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 388, in _create_connection
    return _ConnectionRecord(self)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 673, in __init__
    self.__connect()
    ~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 899, in __connect
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 895, in __connect
    self.dbapi_connection = connection = pool._invoke_creator(self)
                                         ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\create.py", line 661, in connect
    return dialect.connect(*cargs, **cparams)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 629, in connect
    return self.loaded_dbapi.connect(*cargs, **cparams)  # type: ignore[no-any-return]  # NOQA: E501
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 298, in migrate_database
    with get_db() as db:
         ~~~~~~^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 286, in get_db
    log_message(f"Ошибка БД: {e}", 'error')
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 219, in log_message
    migrate_database()
    ~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 337, in migrate_database
    log_message(f"Ошибка миграции базы данных: {e}", 'error', traceback=str(e))
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 214, in log_message
    db.commit()
    ~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2030, in commit
    trans.commit(_to_root=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "<string>", line 2, in commit
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1311, in commit
    self._prepare_impl()
    ~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 2, in _prepare_impl
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1286, in _prepare_impl
    self.session.flush()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4331, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4466, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4427, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 68, in save_obj
    ) in _organize_states_for_save(base_mapper, states, uowtransaction):
         ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 223, in _organize_states_for_save
    for state, dict_, mapper, connection in _connections_for_states(
                                            ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper, uowtransaction, states
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ):
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 1759, in _connections_for_states
    connection = uowtransaction.transaction.connection(base_mapper)
  File "<string>", line 2, in connection
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1037, in connection
    return self._connection_for_bind(bind, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1173, in _connection_for_bind
    conn = self._parent._connection_for_bind(
        bind, execution_options
    )
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1187, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3277, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 143, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3301, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 447, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1264, in _checkout
    fairy = _ConnectionRecord.checkout(pool)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 711, in checkout
    rec = pool._do_get()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 177, in _do_get
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 175, in _do_get
    return self._create_connection()
           ~~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 388, in _create_connection
    return _ConnectionRecord(self)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 673, in __init__
    self.__connect()
    ~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 899, in __connect
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 895, in __connect
    self.dbapi_connection = connection = pool._invoke_creator(self)
                                         ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\create.py", line 661, in connect
    return dialect.connect(*cargs, **cparams)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 629, in connect
    return self.loaded_dbapi.connect(*cargs, **cparams)  # type: ignore[no-any-return]  # NOQA: E501
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 365, in __init__
    self.connect()
    ~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 661, in connect
    sock = socket.create_connection(
        (self.host, self.port), self.connect_timeout, **kwargs
    )
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\socket.py", line 840, in create_connection
    for res in getaddrinfo(host, port, 0, SOCK_STREAM):
               ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\socket.py", line 977, in getaddrinfo
    for res in _socket.getaddrinfo(host, port, family, type, proto, flags):
               ~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
RecursionError: maximum recursion depth exceeded
encoding with 'idna' codec failed
2025-12-08 15:16:16,908 - ERROR - [crypto_api.backend] User=None | Ошибка миграции базы данных: maximum recursion depth exceeded
Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 282, in get_db
    yield db
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 300, in migrate_database
    result = db.execute("""
             ~~~~~~~~~~^^^^
        SELECT COUNT(*)
        ^^^^^^^^^^^^^^^
    ...<3 lines>...
        AND column_name = 'host'
        ^^^^^^^^^^^^^^^^^^^^^^^^
    """).fetchone()
    ^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2147, in _execute_internal
    statement = coercions.expect(roles.StatementRole, statement)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 395, in expect
    resolved = impl._literal_coercion(
        element, argname=argname, **kw
    )
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 621, in _literal_coercion
    return self._text_coercion(element, argname, **kw)
           ~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 614, in _text_coercion
    return _no_text_coercion(element, argname)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 584, in _no_text_coercion
    raise exc_cls(
    ...<7 lines>...
    ) from err
sqlalchemy.exc.ArgumentError: Textual SQL expression '\n                SELECT C...' should be explicitly declared as text('\n                SELECT C...')

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1301, in _checkout
    result = pool._dialect._do_ping_w_event(
        fairy.dbapi_connection
    )
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 728, in _do_ping_w_event
    return self.do_ping(dbapi_connection)
           ~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\dialects\mysql\pymysql.py", line 121, in do_ping
    dbapi_connection.ping(False)
    ~~~~~~~~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 607, in ping
    self._read_ok_packet()
    ~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 465, in _read_ok_packet
    pkt = self._read_packet()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 751, in _read_packet
    packet_header = self._read_bytes(4)
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 298, in migrate_database
    with get_db() as db:
         ~~~~~~^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 286, in get_db
    log_message(f"Ошибка БД: {e}", 'error')
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 214, in log_message
    db.commit()
    ~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2030, in commit
    trans.commit(_to_root=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "<string>", line 2, in commit
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1311, in commit
    self._prepare_impl()
    ~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 2, in _prepare_impl
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1286, in _prepare_impl
    self.session.flush()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4331, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4466, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4427, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 68, in save_obj
    ) in _organize_states_for_save(base_mapper, states, uowtransaction):
         ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 223, in _organize_states_for_save
    for state, dict_, mapper, connection in _connections_for_states(
                                            ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper, uowtransaction, states
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ):
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 1759, in _connections_for_states
    connection = uowtransaction.transaction.connection(base_mapper)
  File "<string>", line 2, in connection
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1037, in connection
    return self._connection_for_bind(bind, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1173, in _connection_for_bind
    conn = self._parent._connection_for_bind(
        bind, execution_options
    )
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1187, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3277, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 143, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3301, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 447, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1363, in _checkout
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 228, in __exit__
    raise value.with_traceback(traceback)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1366, in _checkout
    rec._checkin_failed(
    ~~~~~~~~~~~~~~~~~~~^
        be_outer,
        ^^^^^^^^^
        _fairy_was_created=True,
        ^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 745, in _checkin_failed
    self.invalidate(e=err)
    ~~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 815, in invalidate
    self.__close(terminate=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 882, in __close
    self.__pool._close_connection(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.dbapi_connection, terminate=terminate
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 365, in _close_connection
    self.logger.debug(
    ~~~~~~~~~~~~~~~~~^
        "%s connection %r",
        ^^^^^^^^^^^^^^^^^^^
        "Hard-closing" if terminate else "Closing",
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        connection,
        ^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\logging\__init__.py", line 1507, in debug
    if self.isEnabledFor(DEBUG):
       ~~~~~~~~~~~~~~~~~^^^^^^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 298, in migrate_database
    with get_db() as db:
         ~~~~~~^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 286, in get_db
    log_message(f"Ошибка БД: {e}", 'error')
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 219, in log_message
    migrate_database()
    ~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 337, in migrate_database
    log_message(f"Ошибка миграции базы данных: {e}", 'error', traceback=str(e))
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 214, in log_message
    db.commit()
    ~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2030, in commit
    trans.commit(_to_root=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "<string>", line 2, in commit
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1311, in commit
    self._prepare_impl()
    ~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 2, in _prepare_impl
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1286, in _prepare_impl
    self.session.flush()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4331, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4466, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4427, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 68, in save_obj
    ) in _organize_states_for_save(base_mapper, states, uowtransaction):
         ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 223, in _organize_states_for_save
    for state, dict_, mapper, connection in _connections_for_states(
                                            ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper, uowtransaction, states
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ):
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 1759, in _connections_for_states
    connection = uowtransaction.transaction.connection(base_mapper)
  File "<string>", line 2, in connection
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1037, in connection
    return self._connection_for_bind(bind, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1173, in _connection_for_bind
    conn = self._parent._connection_for_bind(
        bind, execution_options
    )
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1187, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3277, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 143, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3301, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 447, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1264, in _checkout
    fairy = _ConnectionRecord.checkout(pool)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 711, in checkout
    rec = pool._do_get()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 177, in _do_get
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 175, in _do_get
    return self._create_connection()
           ~~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 388, in _create_connection
    return _ConnectionRecord(self)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 673, in __init__
    self.__connect()
    ~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 899, in __connect
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 895, in __connect
    self.dbapi_connection = connection = pool._invoke_creator(self)
                                         ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\create.py", line 661, in connect
    return dialect.connect(*cargs, **cparams)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 629, in connect
    return self.loaded_dbapi.connect(*cargs, **cparams)  # type: ignore[no-any-return]  # NOQA: E501
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 298, in migrate_database
    with get_db() as db:
         ~~~~~~^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 286, in get_db
    log_message(f"Ошибка БД: {e}", 'error')
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 219, in log_message
    migrate_database()
    ~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 337, in migrate_database
    log_message(f"Ошибка миграции базы данных: {e}", 'error', traceback=str(e))
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 214, in log_message
    db.commit()
    ~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2030, in commit
    trans.commit(_to_root=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "<string>", line 2, in commit
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1311, in commit
    self._prepare_impl()
    ~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 2, in _prepare_impl
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1286, in _prepare_impl
    self.session.flush()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4331, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4466, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4427, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 68, in save_obj
    ) in _organize_states_for_save(base_mapper, states, uowtransaction):
         ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 223, in _organize_states_for_save
    for state, dict_, mapper, connection in _connections_for_states(
                                            ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper, uowtransaction, states
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ):
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 1759, in _connections_for_states
    connection = uowtransaction.transaction.connection(base_mapper)
  File "<string>", line 2, in connection
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1037, in connection
    return self._connection_for_bind(bind, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1173, in _connection_for_bind
    conn = self._parent._connection_for_bind(
        bind, execution_options
    )
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1187, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3277, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 143, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3301, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 447, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1264, in _checkout
    fairy = _ConnectionRecord.checkout(pool)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 711, in checkout
    rec = pool._do_get()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 177, in _do_get
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 175, in _do_get
    return self._create_connection()
           ~~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 388, in _create_connection
    return _ConnectionRecord(self)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 673, in __init__
    self.__connect()
    ~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 899, in __connect
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 895, in __connect
    self.dbapi_connection = connection = pool._invoke_creator(self)
                                         ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\create.py", line 661, in connect
    return dialect.connect(*cargs, **cparams)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 629, in connect
    return self.loaded_dbapi.connect(*cargs, **cparams)  # type: ignore[no-any-return]  # NOQA: E501
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 365, in __init__
    self.connect()
    ~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 661, in connect
    sock = socket.create_connection(
        (self.host, self.port), self.connect_timeout, **kwargs
    )
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\socket.py", line 840, in create_connection
    for res in getaddrinfo(host, port, 0, SOCK_STREAM):
               ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\socket.py", line 977, in getaddrinfo
    for res in _socket.getaddrinfo(host, port, family, type, proto, flags):
               ~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
RecursionError: maximum recursion depth exceeded
encoding with 'idna' codec failed

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 789, in _read_bytes
    data = self._rfile.read(num_bytes)
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\socket.py", line 715, in readinto
    self._checkReadable()
    ~~~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 298, in migrate_database
    with get_db() as db:
         ~~~~~~^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 286, in get_db
    log_message(f"Ошибка БД: {e}", 'error')
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 219, in log_message
    migrate_database()
    ~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 337, in migrate_database
    log_message(f"Ошибка миграции базы данных: {e}", 'error', traceback=str(e))
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 214, in log_message
    db.commit()
    ~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2030, in commit
    trans.commit(_to_root=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "<string>", line 2, in commit
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1311, in commit
    self._prepare_impl()
    ~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 2, in _prepare_impl
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1286, in _prepare_impl
    self.session.flush()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4331, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4466, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4427, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 68, in save_obj
    ) in _organize_states_for_save(base_mapper, states, uowtransaction):
         ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 223, in _organize_states_for_save
    for state, dict_, mapper, connection in _connections_for_states(
                                            ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper, uowtransaction, states
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ):
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 1759, in _connections_for_states
    connection = uowtransaction.transaction.connection(base_mapper)
  File "<string>", line 2, in connection
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1037, in connection
    return self._connection_for_bind(bind, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1173, in _connection_for_bind
    conn = self._parent._connection_for_bind(
        bind, execution_options
    )
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1187, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3277, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 143, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3301, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 447, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1264, in _checkout
    fairy = _ConnectionRecord.checkout(pool)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 711, in checkout
    rec = pool._do_get()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 177, in _do_get
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 175, in _do_get
    return self._create_connection()
           ~~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 388, in _create_connection
    return _ConnectionRecord(self)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 673, in __init__
    self.__connect()
    ~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 899, in __connect
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 895, in __connect
    self.dbapi_connection = connection = pool._invoke_creator(self)
                                         ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\create.py", line 661, in connect
    return dialect.connect(*cargs, **cparams)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 629, in connect
    return self.loaded_dbapi.connect(*cargs, **cparams)  # type: ignore[no-any-return]  # NOQA: E501
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 365, in __init__
    self.connect()
    ~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 709, in connect
    self.autocommit(self.autocommit_mode)
    ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 459, in autocommit
    self._send_autocommit_mode()
    ~~~~~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 480, in _send_autocommit_mode
    self._read_ok_packet()
    ~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 465, in _read_ok_packet
    pkt = self._read_packet()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 751, in _read_packet
    packet_header = self._read_bytes(4)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 801, in _read_bytes
    self._force_close()
    ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 444, in _force_close
    self._rfile.close()
    ~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded
2025-12-08 15:16:17,068 - ERROR - [crypto_api.backend] User=None | Ошибка БД: Textual SQL expression '\n                SELECT C...' should be explicitly declared as text('\n                SELECT C...')
2025-12-08 15:16:17,125 - ERROR - [crypto_api.backend] User=None | Ошибка БД: Textual SQL expression '\n                SELECT C...' should be explicitly declared as text('\n                SELECT C...')
2025-12-08 15:16:17,182 - ERROR - [crypto_api.backend] User=None | Ошибка БД: Textual SQL expression '\n                SELECT C...' should be explicitly declared as text('\n                SELECT C...')
2025-12-08 15:16:17,185 - ERROR - [crypto_api.backend] User=None | Ошибка миграции базы данных: maximum recursion depth exceeded
Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 282, in get_db
    yield db
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 300, in migrate_database
    result = db.execute("""
             ~~~~~~~~~~^^^^
        SELECT COUNT(*)
        ^^^^^^^^^^^^^^^
    ...<3 lines>...
        AND column_name = 'host'
        ^^^^^^^^^^^^^^^^^^^^^^^^
    """).fetchone()
    ^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2147, in _execute_internal
    statement = coercions.expect(roles.StatementRole, statement)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 395, in expect
    resolved = impl._literal_coercion(
        element, argname=argname, **kw
    )
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 621, in _literal_coercion
    return self._text_coercion(element, argname, **kw)
           ~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 614, in _text_coercion
    return _no_text_coercion(element, argname)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 584, in _no_text_coercion
    raise exc_cls(
    ...<7 lines>...
    ) from err
sqlalchemy.exc.ArgumentError: Textual SQL expression '\n                SELECT C...' should be explicitly declared as text('\n                SELECT C...')

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 789, in _read_bytes
    data = self._rfile.read(num_bytes)
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\socket.py", line 715, in readinto
    self._checkReadable()
    ~~~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1301, in _checkout
    result = pool._dialect._do_ping_w_event(
        fairy.dbapi_connection
    )
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 728, in _do_ping_w_event
    return self.do_ping(dbapi_connection)
           ~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\dialects\mysql\pymysql.py", line 121, in do_ping
    dbapi_connection.ping(False)
    ~~~~~~~~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 607, in ping
    self._read_ok_packet()
    ~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 465, in _read_ok_packet
    pkt = self._read_packet()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 751, in _read_packet
    packet_header = self._read_bytes(4)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 801, in _read_bytes
    self._force_close()
    ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 444, in _force_close
    self._rfile.close()
    ~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 372, in _close_connection
    self._dialect.do_terminate(connection)
    ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 717, in do_terminate
    self.do_close(dbapi_connection)
    ~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 720, in do_close
    dbapi_connection.close()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 434, in close
    self._force_close()
    ~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 298, in migrate_database
    with get_db() as db:
         ~~~~~~^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 286, in get_db
    log_message(f"Ошибка БД: {e}", 'error')
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 214, in log_message
    db.commit()
    ~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2030, in commit
    trans.commit(_to_root=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "<string>", line 2, in commit
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1311, in commit
    self._prepare_impl()
    ~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 2, in _prepare_impl
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1286, in _prepare_impl
    self.session.flush()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4331, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4466, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4427, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 68, in save_obj
    ) in _organize_states_for_save(base_mapper, states, uowtransaction):
         ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 223, in _organize_states_for_save
    for state, dict_, mapper, connection in _connections_for_states(
                                            ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper, uowtransaction, states
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ):
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 1759, in _connections_for_states
    connection = uowtransaction.transaction.connection(base_mapper)
  File "<string>", line 2, in connection
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1037, in connection
    return self._connection_for_bind(bind, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1173, in _connection_for_bind
    conn = self._parent._connection_for_bind(
        bind, execution_options
    )
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1187, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3277, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 143, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3301, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 447, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1363, in _checkout
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 228, in __exit__
    raise value.with_traceback(traceback)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1366, in _checkout
    rec._checkin_failed(
    ~~~~~~~~~~~~~~~~~~~^
        be_outer,
        ^^^^^^^^^
        _fairy_was_created=True,
        ^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 745, in _checkin_failed
    self.invalidate(e=err)
    ~~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 815, in invalidate
    self.__close(terminate=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 882, in __close
    self.__pool._close_connection(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.dbapi_connection, terminate=terminate
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 376, in _close_connection
    self.logger.error(
    ~~~~~~~~~~~~~~~~~^
        f"Exception {'terminating' if terminate else 'closing'} "
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<2 lines>...
        exc_info=True,
        ^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\logging\__init__.py", line 1549, in error
    self._log(ERROR, msg, args, **kwargs)
    ~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\logging\__init__.py", line 1653, in _log
    fn, lno, func, sinfo = self.findCaller(stack_info, stacklevel)
                           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\logging\__init__.py", line 1597, in findCaller
    f = currentframe()
RecursionError: maximum recursion depth exceeded
2025-12-08 15:16:17,199 - ERROR - [crypto_api.backend] User=None | Ошибка миграции базы данных: maximum recursion depth exceeded
Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 282, in get_db
    yield db
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 300, in migrate_database
    result = db.execute("""
             ~~~~~~~~~~^^^^
        SELECT COUNT(*)
        ^^^^^^^^^^^^^^^
    ...<3 lines>...
        AND column_name = 'host'
        ^^^^^^^^^^^^^^^^^^^^^^^^
    """).fetchone()
    ^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2147, in _execute_internal
    statement = coercions.expect(roles.StatementRole, statement)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 395, in expect
    resolved = impl._literal_coercion(
        element, argname=argname, **kw
    )
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 621, in _literal_coercion
    return self._text_coercion(element, argname, **kw)
           ~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 614, in _text_coercion
    return _no_text_coercion(element, argname)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 584, in _no_text_coercion
    raise exc_cls(
    ...<7 lines>...
    ) from err
sqlalchemy.exc.ArgumentError: Textual SQL expression '\n                SELECT C...' should be explicitly declared as text('\n                SELECT C...')

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 789, in _read_bytes
    data = self._rfile.read(num_bytes)
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\socket.py", line 715, in readinto
    self._checkReadable()
    ~~~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1301, in _checkout
    result = pool._dialect._do_ping_w_event(
        fairy.dbapi_connection
    )
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 728, in _do_ping_w_event
    return self.do_ping(dbapi_connection)
           ~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\dialects\mysql\pymysql.py", line 121, in do_ping
    dbapi_connection.ping(False)
    ~~~~~~~~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 607, in ping
    self._read_ok_packet()
    ~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 465, in _read_ok_packet
    pkt = self._read_packet()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 751, in _read_packet
    packet_header = self._read_bytes(4)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 801, in _read_bytes
    self._force_close()
    ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 444, in _force_close
    self._rfile.close()
    ~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 372, in _close_connection
    self._dialect.do_terminate(connection)
    ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 717, in do_terminate
    self.do_close(dbapi_connection)
    ~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 720, in do_close
    dbapi_connection.close()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 434, in close
    self._force_close()
    ~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 298, in migrate_database
    with get_db() as db:
         ~~~~~~^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 286, in get_db
    log_message(f"Ошибка БД: {e}", 'error')
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 214, in log_message
    db.commit()
    ~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2030, in commit
    trans.commit(_to_root=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "<string>", line 2, in commit
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1311, in commit
    self._prepare_impl()
    ~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 2, in _prepare_impl
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1286, in _prepare_impl
    self.session.flush()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4331, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4466, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4427, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 68, in save_obj
    ) in _organize_states_for_save(base_mapper, states, uowtransaction):
         ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 223, in _organize_states_for_save
    for state, dict_, mapper, connection in _connections_for_states(
                                            ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper, uowtransaction, states
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ):
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 1759, in _connections_for_states
    connection = uowtransaction.transaction.connection(base_mapper)
  File "<string>", line 2, in connection
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1037, in connection
    return self._connection_for_bind(bind, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1173, in _connection_for_bind
    conn = self._parent._connection_for_bind(
        bind, execution_options
    )
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1187, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3277, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 143, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3301, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 447, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1363, in _checkout
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 228, in __exit__
    raise value.with_traceback(traceback)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1366, in _checkout
    rec._checkin_failed(
    ~~~~~~~~~~~~~~~~~~~^
        be_outer,
        ^^^^^^^^^
        _fairy_was_created=True,
        ^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 745, in _checkin_failed
    self.invalidate(e=err)
    ~~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 815, in invalidate
    self.__close(terminate=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 882, in __close
    self.__pool._close_connection(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.dbapi_connection, terminate=terminate
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 376, in _close_connection
    self.logger.error(
    ~~~~~~~~~~~~~~~~~^
        f"Exception {'terminating' if terminate else 'closing'} "
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<2 lines>...
        exc_info=True,
        ^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\logging\__init__.py", line 1549, in error
    self._log(ERROR, msg, args, **kwargs)
    ~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\logging\__init__.py", line 1653, in _log
    fn, lno, func, sinfo = self.findCaller(stack_info, stacklevel)
                           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\logging\__init__.py", line 1597, in findCaller
    f = currentframe()
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 661, in connect
    sock = socket.create_connection(
        (self.host, self.port), self.connect_timeout, **kwargs
    )
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 298, in migrate_database
    with get_db() as db:
         ~~~~~~^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 286, in get_db
    log_message(f"Ошибка БД: {e}", 'error')
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 219, in log_message
    migrate_database()
    ~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 337, in migrate_database
    log_message(f"Ошибка миграции базы данных: {e}", 'error', traceback=str(e))
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 214, in log_message
    db.commit()
    ~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2030, in commit
    trans.commit(_to_root=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "<string>", line 2, in commit
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1311, in commit
    self._prepare_impl()
    ~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 2, in _prepare_impl
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1286, in _prepare_impl
    self.session.flush()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4331, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4466, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4427, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 68, in save_obj
    ) in _organize_states_for_save(base_mapper, states, uowtransaction):
         ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 223, in _organize_states_for_save
    for state, dict_, mapper, connection in _connections_for_states(
                                            ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper, uowtransaction, states
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ):
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 1759, in _connections_for_states
    connection = uowtransaction.transaction.connection(base_mapper)
  File "<string>", line 2, in connection
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1037, in connection
    return self._connection_for_bind(bind, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1173, in _connection_for_bind
    conn = self._parent._connection_for_bind(
        bind, execution_options
    )
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1187, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3277, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 143, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3301, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 447, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1264, in _checkout
    fairy = _ConnectionRecord.checkout(pool)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 711, in checkout
    rec = pool._do_get()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 177, in _do_get
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 175, in _do_get
    return self._create_connection()
           ~~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 388, in _create_connection
    return _ConnectionRecord(self)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 673, in __init__
    self.__connect()
    ~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 899, in __connect
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 895, in __connect
    self.dbapi_connection = connection = pool._invoke_creator(self)
                                         ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\create.py", line 661, in connect
    return dialect.connect(*cargs, **cparams)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 629, in connect
    return self.loaded_dbapi.connect(*cargs, **cparams)  # type: ignore[no-any-return]  # NOQA: E501
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 365, in __init__
    self.connect()
    ~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 711, in connect
    self._force_close()
    ~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded
2025-12-08 15:16:17,216 - ERROR - [crypto_api.backend] User=None | Ошибка миграции базы данных: maximum recursion depth exceeded
Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 282, in get_db
    yield db
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 300, in migrate_database
    result = db.execute("""
             ~~~~~~~~~~^^^^
        SELECT COUNT(*)
        ^^^^^^^^^^^^^^^
    ...<3 lines>...
        AND column_name = 'host'
        ^^^^^^^^^^^^^^^^^^^^^^^^
    """).fetchone()
    ^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2147, in _execute_internal
    statement = coercions.expect(roles.StatementRole, statement)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 395, in expect
    resolved = impl._literal_coercion(
        element, argname=argname, **kw
    )
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 621, in _literal_coercion
    return self._text_coercion(element, argname, **kw)
           ~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 614, in _text_coercion
    return _no_text_coercion(element, argname)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 584, in _no_text_coercion
    raise exc_cls(
    ...<7 lines>...
    ) from err
sqlalchemy.exc.ArgumentError: Textual SQL expression '\n                SELECT C...' should be explicitly declared as text('\n                SELECT C...')

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 789, in _read_bytes
    data = self._rfile.read(num_bytes)
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\socket.py", line 715, in readinto
    self._checkReadable()
    ~~~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1301, in _checkout
    result = pool._dialect._do_ping_w_event(
        fairy.dbapi_connection
    )
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 728, in _do_ping_w_event
    return self.do_ping(dbapi_connection)
           ~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\dialects\mysql\pymysql.py", line 121, in do_ping
    dbapi_connection.ping(False)
    ~~~~~~~~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 607, in ping
    self._read_ok_packet()
    ~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 465, in _read_ok_packet
    pkt = self._read_packet()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 751, in _read_packet
    packet_header = self._read_bytes(4)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 801, in _read_bytes
    self._force_close()
    ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 444, in _force_close
    self._rfile.close()
    ~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 372, in _close_connection
    self._dialect.do_terminate(connection)
    ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 717, in do_terminate
    self.do_close(dbapi_connection)
    ~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 720, in do_close
    dbapi_connection.close()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 434, in close
    self._force_close()
    ~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 298, in migrate_database
    with get_db() as db:
         ~~~~~~^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 286, in get_db
    log_message(f"Ошибка БД: {e}", 'error')
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 214, in log_message
    db.commit()
    ~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2030, in commit
    trans.commit(_to_root=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "<string>", line 2, in commit
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1311, in commit
    self._prepare_impl()
    ~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 2, in _prepare_impl
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1286, in _prepare_impl
    self.session.flush()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4331, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4466, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4427, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 68, in save_obj
    ) in _organize_states_for_save(base_mapper, states, uowtransaction):
         ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 223, in _organize_states_for_save
    for state, dict_, mapper, connection in _connections_for_states(
                                            ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper, uowtransaction, states
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ):
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 1759, in _connections_for_states
    connection = uowtransaction.transaction.connection(base_mapper)
  File "<string>", line 2, in connection
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1037, in connection
    return self._connection_for_bind(bind, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1173, in _connection_for_bind
    conn = self._parent._connection_for_bind(
        bind, execution_options
    )
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1187, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3277, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 143, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3301, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 447, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1363, in _checkout
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 228, in __exit__
    raise value.with_traceback(traceback)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1366, in _checkout
    rec._checkin_failed(
    ~~~~~~~~~~~~~~~~~~~^
        be_outer,
        ^^^^^^^^^
        _fairy_was_created=True,
        ^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 745, in _checkin_failed
    self.invalidate(e=err)
    ~~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 815, in invalidate
    self.__close(terminate=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 882, in __close
    self.__pool._close_connection(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.dbapi_connection, terminate=terminate
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 376, in _close_connection
    self.logger.error(
    ~~~~~~~~~~~~~~~~~^
        f"Exception {'terminating' if terminate else 'closing'} "
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<2 lines>...
        exc_info=True,
        ^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\logging\__init__.py", line 1549, in error
    self._log(ERROR, msg, args, **kwargs)
    ~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\logging\__init__.py", line 1653, in _log
    fn, lno, func, sinfo = self.findCaller(stack_info, stacklevel)
                           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\logging\__init__.py", line 1597, in findCaller
    f = currentframe()
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 661, in connect
    sock = socket.create_connection(
        (self.host, self.port), self.connect_timeout, **kwargs
    )
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 298, in migrate_database
    with get_db() as db:
         ~~~~~~^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 286, in get_db
    log_message(f"Ошибка БД: {e}", 'error')
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 219, in log_message
    migrate_database()
    ~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 337, in migrate_database
    log_message(f"Ошибка миграции базы данных: {e}", 'error', traceback=str(e))
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 214, in log_message
    db.commit()
    ~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2030, in commit
    trans.commit(_to_root=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "<string>", line 2, in commit
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1311, in commit
    self._prepare_impl()
    ~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 2, in _prepare_impl
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1286, in _prepare_impl
    self.session.flush()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4331, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4466, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4427, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 68, in save_obj
    ) in _organize_states_for_save(base_mapper, states, uowtransaction):
         ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 223, in _organize_states_for_save
    for state, dict_, mapper, connection in _connections_for_states(
                                            ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper, uowtransaction, states
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ):
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 1759, in _connections_for_states
    connection = uowtransaction.transaction.connection(base_mapper)
  File "<string>", line 2, in connection
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1037, in connection
    return self._connection_for_bind(bind, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1173, in _connection_for_bind
    conn = self._parent._connection_for_bind(
        bind, execution_options
    )
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1187, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3277, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 143, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3301, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 447, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1264, in _checkout
    fairy = _ConnectionRecord.checkout(pool)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 711, in checkout
    rec = pool._do_get()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 177, in _do_get
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 175, in _do_get
    return self._create_connection()
           ~~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 388, in _create_connection
    return _ConnectionRecord(self)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 673, in __init__
    self.__connect()
    ~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 899, in __connect
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 895, in __connect
    self.dbapi_connection = connection = pool._invoke_creator(self)
                                         ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\create.py", line 661, in connect
    return dialect.connect(*cargs, **cparams)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 629, in connect
    return self.loaded_dbapi.connect(*cargs, **cparams)  # type: ignore[no-any-return]  # NOQA: E501
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 365, in __init__
    self.connect()
    ~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 711, in connect
    self._force_close()
    ~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 298, in migrate_database
    with get_db() as db:
         ~~~~~~^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 286, in get_db
    log_message(f"Ошибка БД: {e}", 'error')
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 219, in log_message
    migrate_database()
    ~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 337, in migrate_database
    log_message(f"Ошибка миграции базы данных: {e}", 'error', traceback=str(e))
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 214, in log_message
    db.commit()
    ~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2030, in commit
    trans.commit(_to_root=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "<string>", line 2, in commit
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1311, in commit
    self._prepare_impl()
    ~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 2, in _prepare_impl
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1286, in _prepare_impl
    self.session.flush()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4331, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4466, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4427, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 68, in save_obj
    ) in _organize_states_for_save(base_mapper, states, uowtransaction):
         ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 223, in _organize_states_for_save
    for state, dict_, mapper, connection in _connections_for_states(
                                            ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper, uowtransaction, states
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ):
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 1759, in _connections_for_states
    connection = uowtransaction.transaction.connection(base_mapper)
  File "<string>", line 2, in connection
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1037, in connection
    return self._connection_for_bind(bind, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1173, in _connection_for_bind
    conn = self._parent._connection_for_bind(
        bind, execution_options
    )
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1187, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3277, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 143, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3301, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 447, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1264, in _checkout
    fairy = _ConnectionRecord.checkout(pool)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 711, in checkout
    rec = pool._do_get()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 177, in _do_get
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 175, in _do_get
    return self._create_connection()
           ~~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 388, in _create_connection
    return _ConnectionRecord(self)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 673, in __init__
    self.__connect()
    ~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 899, in __connect
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 895, in __connect
    self.dbapi_connection = connection = pool._invoke_creator(self)
                                         ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\create.py", line 661, in connect
    return dialect.connect(*cargs, **cparams)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 629, in connect
    return self.loaded_dbapi.connect(*cargs, **cparams)  # type: ignore[no-any-return]  # NOQA: E501
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 365, in __init__
    self.connect()
    ~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 661, in connect
    sock = socket.create_connection(
        (self.host, self.port), self.connect_timeout, **kwargs
    )
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\socket.py", line 840, in create_connection
    for res in getaddrinfo(host, port, 0, SOCK_STREAM):
               ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\socket.py", line 979, in getaddrinfo
    addrlist.append((_intenum_converter(af, AddressFamily),
                     ~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\socket.py", line 106, in _intenum_converter
    return enum_klass(value)
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\enum.py", line 726, in __call__
    return cls.__new__(cls, value)
           ~~~~~~~~~~~^^^^^^^^^^^^
RecursionError: maximum recursion depth exceeded
2025-12-08 15:16:17,312 - ERROR - [crypto_api.backend] User=None | Ошибка миграции базы данных: maximum recursion depth exceeded
Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 282, in get_db
    yield db
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 300, in migrate_database
    result = db.execute("""
             ~~~~~~~~~~^^^^
        SELECT COUNT(*)
        ^^^^^^^^^^^^^^^
    ...<3 lines>...
        AND column_name = 'host'
        ^^^^^^^^^^^^^^^^^^^^^^^^
    """).fetchone()
    ^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2147, in _execute_internal
    statement = coercions.expect(roles.StatementRole, statement)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 395, in expect
    resolved = impl._literal_coercion(
        element, argname=argname, **kw
    )
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 621, in _literal_coercion
    return self._text_coercion(element, argname, **kw)
           ~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 614, in _text_coercion
    return _no_text_coercion(element, argname)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\sql\coercions.py", line 584, in _no_text_coercion
    raise exc_cls(
    ...<7 lines>...
    ) from err
sqlalchemy.exc.ArgumentError: Textual SQL expression '\n                SELECT C...' should be explicitly declared as text('\n                SELECT C...')

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 789, in _read_bytes
    data = self._rfile.read(num_bytes)
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\socket.py", line 715, in readinto
    self._checkReadable()
    ~~~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1301, in _checkout
    result = pool._dialect._do_ping_w_event(
        fairy.dbapi_connection
    )
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 728, in _do_ping_w_event
    return self.do_ping(dbapi_connection)
           ~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\dialects\mysql\pymysql.py", line 121, in do_ping
    dbapi_connection.ping(False)
    ~~~~~~~~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 607, in ping
    self._read_ok_packet()
    ~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 465, in _read_ok_packet
    pkt = self._read_packet()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 751, in _read_packet
    packet_header = self._read_bytes(4)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 801, in _read_bytes
    self._force_close()
    ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 444, in _force_close
    self._rfile.close()
    ~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 372, in _close_connection
    self._dialect.do_terminate(connection)
    ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 717, in do_terminate
    self.do_close(dbapi_connection)
    ~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 720, in do_close
    dbapi_connection.close()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 434, in close
    self._force_close()
    ~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 298, in migrate_database
    with get_db() as db:
         ~~~~~~^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 286, in get_db
    log_message(f"Ошибка БД: {e}", 'error')
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 214, in log_message
    db.commit()
    ~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2030, in commit
    trans.commit(_to_root=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "<string>", line 2, in commit
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1311, in commit
    self._prepare_impl()
    ~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 2, in _prepare_impl
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1286, in _prepare_impl
    self.session.flush()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4331, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4466, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4427, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 68, in save_obj
    ) in _organize_states_for_save(base_mapper, states, uowtransaction):
         ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 223, in _organize_states_for_save
    for state, dict_, mapper, connection in _connections_for_states(
                                            ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper, uowtransaction, states
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ):
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 1759, in _connections_for_states
    connection = uowtransaction.transaction.connection(base_mapper)
  File "<string>", line 2, in connection
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1037, in connection
    return self._connection_for_bind(bind, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1173, in _connection_for_bind
    conn = self._parent._connection_for_bind(
        bind, execution_options
    )
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1187, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3277, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 143, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3301, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 447, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1363, in _checkout
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 228, in __exit__
    raise value.with_traceback(traceback)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1366, in _checkout
    rec._checkin_failed(
    ~~~~~~~~~~~~~~~~~~~^
        be_outer,
        ^^^^^^^^^
        _fairy_was_created=True,
        ^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 745, in _checkin_failed
    self.invalidate(e=err)
    ~~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 815, in invalidate
    self.__close(terminate=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 882, in __close
    self.__pool._close_connection(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.dbapi_connection, terminate=terminate
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 376, in _close_connection
    self.logger.error(
    ~~~~~~~~~~~~~~~~~^
        f"Exception {'terminating' if terminate else 'closing'} "
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<2 lines>...
        exc_info=True,
        ^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\logging\__init__.py", line 1549, in error
    self._log(ERROR, msg, args, **kwargs)
    ~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\logging\__init__.py", line 1653, in _log
    fn, lno, func, sinfo = self.findCaller(stack_info, stacklevel)
                           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\logging\__init__.py", line 1597, in findCaller
    f = currentframe()
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 661, in connect
    sock = socket.create_connection(
        (self.host, self.port), self.connect_timeout, **kwargs
    )
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 298, in migrate_database
    with get_db() as db:
         ~~~~~~^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 286, in get_db
    log_message(f"Ошибка БД: {e}", 'error')
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 219, in log_message
    migrate_database()
    ~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 337, in migrate_database
    log_message(f"Ошибка миграции базы данных: {e}", 'error', traceback=str(e))
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 214, in log_message
    db.commit()
    ~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2030, in commit
    trans.commit(_to_root=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "<string>", line 2, in commit
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1311, in commit
    self._prepare_impl()
    ~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 2, in _prepare_impl
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1286, in _prepare_impl
    self.session.flush()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4331, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4466, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4427, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 68, in save_obj
    ) in _organize_states_for_save(base_mapper, states, uowtransaction):
         ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 223, in _organize_states_for_save
    for state, dict_, mapper, connection in _connections_for_states(
                                            ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper, uowtransaction, states
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ):
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 1759, in _connections_for_states
    connection = uowtransaction.transaction.connection(base_mapper)
  File "<string>", line 2, in connection
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1037, in connection
    return self._connection_for_bind(bind, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1173, in _connection_for_bind
    conn = self._parent._connection_for_bind(
        bind, execution_options
    )
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1187, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3277, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 143, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3301, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 447, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1264, in _checkout
    fairy = _ConnectionRecord.checkout(pool)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 711, in checkout
    rec = pool._do_get()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 177, in _do_get
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 175, in _do_get
    return self._create_connection()
           ~~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 388, in _create_connection
    return _ConnectionRecord(self)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 673, in __init__
    self.__connect()
    ~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 899, in __connect
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 895, in __connect
    self.dbapi_connection = connection = pool._invoke_creator(self)
                                         ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\create.py", line 661, in connect
    return dialect.connect(*cargs, **cparams)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 629, in connect
    return self.loaded_dbapi.connect(*cargs, **cparams)  # type: ignore[no-any-return]  # NOQA: E501
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 365, in __init__
    self.connect()
    ~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 711, in connect
    self._force_close()
    ~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 298, in migrate_database
    with get_db() as db:
         ~~~~~~^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 286, in get_db
    log_message(f"Ошибка БД: {e}", 'error')
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 219, in log_message
    migrate_database()
    ~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 337, in migrate_database
    log_message(f"Ошибка миграции базы данных: {e}", 'error', traceback=str(e))
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 214, in log_message
    db.commit()
    ~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2030, in commit
    trans.commit(_to_root=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "<string>", line 2, in commit
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1311, in commit
    self._prepare_impl()
    ~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 2, in _prepare_impl
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1286, in _prepare_impl
    self.session.flush()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4331, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4466, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4427, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 68, in save_obj
    ) in _organize_states_for_save(base_mapper, states, uowtransaction):
         ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 223, in _organize_states_for_save
    for state, dict_, mapper, connection in _connections_for_states(
                                            ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper, uowtransaction, states
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ):
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 1759, in _connections_for_states
    connection = uowtransaction.transaction.connection(base_mapper)
  File "<string>", line 2, in connection
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1037, in connection
    return self._connection_for_bind(bind, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1173, in _connection_for_bind
    conn = self._parent._connection_for_bind(
        bind, execution_options
    )
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1187, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3277, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 143, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3301, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 447, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1264, in _checkout
    fairy = _ConnectionRecord.checkout(pool)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 711, in checkout
    rec = pool._do_get()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 177, in _do_get
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 175, in _do_get
    return self._create_connection()
           ~~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 388, in _create_connection
    return _ConnectionRecord(self)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 673, in __init__
    self.__connect()
    ~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 899, in __connect
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 895, in __connect
    self.dbapi_connection = connection = pool._invoke_creator(self)
                                         ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\create.py", line 661, in connect
    return dialect.connect(*cargs, **cparams)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\default.py", line 629, in connect
    return self.loaded_dbapi.connect(*cargs, **cparams)  # type: ignore[no-any-return]  # NOQA: E501
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 365, in __init__
    self.connect()
    ~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 661, in connect
    sock = socket.create_connection(
        (self.host, self.port), self.connect_timeout, **kwargs
    )
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\socket.py", line 840, in create_connection
    for res in getaddrinfo(host, port, 0, SOCK_STREAM):
               ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\socket.py", line 979, in getaddrinfo
    addrlist.append((_intenum_converter(af, AddressFamily),
                     ~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\socket.py", line 106, in _intenum_converter
    return enum_klass(value)
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\enum.py", line 726, in __call__
    return cls.__new__(cls, value)
           ~~~~~~~~~~~^^^^^^^^^^^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 789, in _read_bytes
    data = self._rfile.read(num_bytes)
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\socket.py", line 715, in readinto
    self._checkReadable()
    ~~~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 298, in migrate_database
    with get_db() as db:
         ~~~~~~^^
  File "C:\Users\romanov\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 286, in get_db
    log_message(f"Ошибка БД: {e}", 'error')
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 219, in log_message
    migrate_database()
    ~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 337, in migrate_database
    log_message(f"Ошибка миграции базы данных: {e}", 'error', traceback=str(e))
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 219, in log_message
    migrate_database()
    ~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 337, in migrate_database
    log_message(f"Ошибка миграции базы данных: {e}", 'error', traceback=str(e))
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 219, in log_message
    migrate_database()
    ~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 337, in migrate_database
    log_message(f"Ошибка миграции базы данных: {e}", 'error', traceback=str(e))
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 219, in log_message
    migrate_database()
    ~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 337, in migrate_database
    log_message(f"Ошибка миграции базы данных: {e}", 'error', traceback=str(e))
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 219, in log_message
    migrate_database()
    ~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 337, in migrate_database
    log_message(f"Ошибка миграции базы данных: {e}", 'error', traceback=str(e))
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 219, in log_message
    migrate_database()
    ~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 337, in migrate_database
    log_message(f"Ошибка миграции базы данных: {e}", 'error', traceback=str(e))
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\app.py", line 214, in log_message
    db.commit()
    ~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2030, in commit
    trans.commit(_to_root=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "<string>", line 2, in commit
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1311, in commit
    self._prepare_impl()
    ~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 2, in _prepare_impl
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1286, in _prepare_impl
    self.session.flush()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4331, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4466, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 4427, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 68, in save_obj
    ) in _organize_states_for_save(base_mapper, states, uowtransaction):
         ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 223, in _organize_states_for_save
    for state, dict_, mapper, connection in _connections_for_states(
                                            ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper, uowtransaction, states
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ):
    ^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\persistence.py", line 1759, in _connections_for_states
    connection = uowtransaction.transaction.connection(base_mapper)
  File "<string>", line 2, in connection
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1037, in connection
    return self._connection_for_bind(bind, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1173, in _connection_for_bind
    conn = self._parent._connection_for_bind(
        bind, execution_options
    )
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1187, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3277, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 143, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3301, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 447, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1264, in _checkout
    fairy = _ConnectionRecord.checkout(pool)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 711, in checkout
    rec = pool._do_get()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 177, in _do_get
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 175, in _do_get
    return self._create_connection()
           ~~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 388, in _create_connection
    return _ConnectionRecord(self)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 673, in __init__
    self.__connect()
    ~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\pool\base.py", line 913, in __connect
    )._exec_w_sync_on_first_run(self.dbapi_connection, self)
      ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\event\attr.py", line 507, in _exec_w_sync_on_first_run
    self(*args, **kw)
    ~~~~^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\event\attr.py", line 515, in __call__
    fn(*args, **kw)
    ~~^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\engine\create.py", line 739, in on_connect
    do_on_connect(dbapi_connection)
    ~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\sqlalchemy\dialects\mysql\mysqldb.py", line 180, in on_connect
    cursor.execute("SET NAMES %s" % charset_name)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 575, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 826, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 1203, in read
    first_packet = self.connection._read_packet()
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 751, in _read_packet
    packet_header = self._read_bytes(4)
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 801, in _read_bytes
    self._force_close()
    ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\romanov\PycharmProjects\crypto_app\.venv\Lib\site-packages\pymysql\connections.py", line 444, in _force_close
    self._rfile.close()
    ~~~~~~~~~~~~~~~~~^^
RecursionError: maximum recursion depth exceeded
2025-12-08 15:16:17,477 - ERROR - [crypto_api.backend] User=None | Ошибка БД: Textual SQL expression '\n                SELECT C...' should be explicitly declared as text('\n                SELECT C...')
2025-12-08 15:16:17,534 - ERROR - [crypto_api.backend] User=None | Ошибка БД: Textual SQL expression '\n                SELECT C...' should be explicitly declared as text('\n                SELECT C...')
2025-12-08 15:16:17,590 - ERROR - [crypto_api.backend] User=None | Ошибка БД: Textual SQL expression '\n                SELECT C...' should be explicitly declared as text('\n                SELECT C...')
2025-12-08 15:16:17,648 - ERROR - [crypto_api.backend] User=None | Ошибка БД: Textual SQL expression '\n                SELECT C...' should be explicitly declared as text('\n                SELECT C...')
2025-12-08 15:16:17,705 - ERROR - [crypto_api.backend] User=None | Ошибка БД: Textual SQL expression '\n                SELECT C...' should be explicitly declared as text('\n                SELECT C...')
2025-12-08 15:16:17,761 - ERROR - [crypto_api.backend] User=None | Ошибка БД: Textual SQL expression '\n                SELECT C...' should be explicitly declared as text('\n                SELECT C...')
