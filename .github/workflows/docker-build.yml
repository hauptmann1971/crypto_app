# .github/workflows/docker-build.yml
name: Build Docker Image

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4

    - name: üèóÔ∏è Build Docker image
      run: |
        echo "=== –°–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–∞ ==="
        docker build -t crypto-app:latest .
        echo "‚úÖ –û–±—Ä–∞–∑ —É—Å–ø–µ—à–Ω–æ —Å–æ–±—Ä–∞–Ω"

    - name: üß™ Test Docker image
      run: |
        echo "=== –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±—Ä–∞–∑–∞ ==="
        docker run --rm crypto-app:latest python -c "
try:
    import flask
    print(f'‚úÖ Flask —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: {flask.__version__}')
    print('‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ –∫ —Ä–∞–±–æ—Ç–µ')
except Exception as e:
    print(f'‚ùå –û—à–∏–±–∫–∞: {e}')
    exit(1)
        "
        
    - name: üíæ Save Docker image
      run: |
        echo "=== –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ–±—Ä–∞–∑–∞ ==="
        docker save crypto-app:latest -o crypto-app.tar
        echo "–†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: \$(du -h crypto-app.tar | cut -f1)"

    - name: üì§ Upload Docker image
      uses: actions/upload-artifact@v4
      with:
        name: crypto-app-docker-image
        path: crypto-app.tar
        retention-days: 30

    - name: ‚úÖ Success message
      if: success()
      run: |
        echo "üéâ DOCKER –û–ë–†–ê–ó –£–°–ü–ï–®–ù–û –°–û–ë–†–ê–ù!"
        echo ""
        echo "üì¶ –û–±—Ä–∞–∑: crypto-app:latest"
        echo "üìÅ –°–∫–∞—á–∞—Ç—å: –†–∞–∑–¥–µ–ª Artifacts ‚Üí crypto-app-docker-image"
        echo ""
        echo "üöÄ –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –∑–∞–ø—É—Å–∫–∞:"
        echo "   docker load -i crypto-app.tar"
        echo "   docker run -d -p 5000:5000 --name crypto-app crypto-app:latest"
        echo "   –û—Ç–∫—Ä—ã—Ç—å: http://localhost:5000"